/*
 floating_banner-1.1.1.js
 Copyright (c) 2015 Rakuten.Inc
 Date : 2015-03-18 18:30:05
*/
(function(){if(void 0!==window.jQuery){var e=jQuery.noConflict(),f=function(b,c){var d=this;this.$root=b;this.hasLocalStorage=this.isLocalStorageSupported();this.hasSessionStorage=this.isSessionStorageSupported();this.hasJSON=this.isJSONSupported();this.device=this.checkDevice();this.path=this.checkCurrentPath();this.scidBannerSelector=this.$root.attr("data-scidBanner")||this.defaults.selectors.scidBanner;this.useSCIDBanner=c&&this.checkSCID();this.$scidBanner=e(this.scidBannerSelector);this.$window=
e(window);this.$document=e(document);this.$body=e("body");this.$hiddenFrom=this.$banner=this.$closeButton=void 0;this.bannerWidth=this.bannerHeight=0;this.hiddenFrom=Infinity;this.windowHeight=0;this.isClosedEventTriggered=this.isHiddenEventTriggered=this.isDisplayedEventTriggered=this.isBannerDisplayed=this.isBannerVisible=!1;this.now=void 0;this.ls="";this.lsObject={};this.pathKey="";this.scidTimeout=0;this.useSCIDBanner&&0<this.$scidBanner.length?(this.scidTimeout=setTimeout(function(){0<d.$root.length&&
d.getSettings()},3E3),this.$body.bind(this.defaults.events.DISPLAY_SCID_BANNER,function(){clearTimeout(d.scidTimeout);d.$root=d.$scidBanner;d.getSettings()})):0<this.$root.length&&this.getSettings()};f.prototype={defaults:{selectors:{closeButton:".closeButton",banner:".banner",hiddenFrom:"",scidBanner:"#scidBanner"},events:{FLOATING_BANNER_DISPLAYED:"floatingbannerdisplayed",FLOATING_BANNER_HIDDEN:"floatingbannerhidden",FLOATING_BANNER_CLOSED:"floatingbannerclosed",DISPLAY_SCID_BANNER:"displayscidbanner"},
localStorageKey:"RJSFloatingBanner",sessionStorageKey:"RJSFloatingBanner",autoHide:1E4,redisplay:864E5,visibleFromPx:0,fadeInTime:300,fadeOutTime:300,saveLSWhenAutoFade:!1,useVisibleFromPxOnlyFirst:!0,removeKeyPeriodDays:90},getSettings:function(){this.closeButtonSelector=this.$root.attr("data-closeButton")||this.defaults.selectors.closeButton;this.bannerSelector=this.$root.attr("data-banner")||this.defaults.selectors.banner;this.visibleFromPx=isNaN(+this.$root.attr("data-visibleFromPx"))?this.defaults.visibleFromPx:
+this.$root.attr("data-visibleFromPx");this.hiddenFromSelector=this.$root.attr("data-hiddenFrom")||this.defaults.selectors.hiddenFrom;this.autoHide=isNaN(+this.$root.attr("data-autoHide"))?this.defaults.autoHide:+this.$root.attr("data-autoHide");this.redisplay=isNaN(+this.$root.attr("data-redisplay"))?this.defaults.redisplay:+this.$root.attr("data-redisplay");this.fadeInTime=isNaN(+this.$root.attr("data-fadeInTime"))?this.defaults.fadeInTime:+this.$root.attr("data-fadeInTime");this.fadeOutTime=isNaN(+this.$root.attr("data-fadeOutTime"))?
this.defaults.fadeOutTime:+this.$root.attr("data-fadeOutTime");this.removeKeyPeriodDays=+this.$root.attr("data-removeKeyPeriodDays")||this.defaults.removeKeyPeriodDays;this.removeKeyPeriod=864E5*this.removeKeyPeriodDays;this.saveLSWhenAutoFade="true"===this.$root.attr("data-saveLSWhenAutoFade");this.campaignKey=this.$root.attr("data-campaignKey")||"";this.useVisibleFromPxOnlyFirst="false"!==this.$root.attr("data-useVisibleFromPxOnlyFirst");this.useOldBehavior="true"===this.$root.attr("data-useOldBehavior");
""!==this.campaignKey&&this.getBannerElements()},getBannerElements:function(){this.$closeButton=this.$root.find(this.closeButtonSelector);this.$banner=this.$root.find(this.bannerSelector);this.bannerHeight=this.$banner.height();this.now=(new Date).getTime();if("body"===this.hiddenFromSelector)this.hiddenFrom=this.$document.height();else if(""!==this.hiddenFromSelector)this.$hiddenFrom=e(this.hiddenFromSelector),this.hiddenFrom=this.$hiddenFrom.offset().top;0<this.$banner.children().length&&this.checkLocalStorage()},
checkSCID:function(){for(var b=location.search.split(/&|\?/),c=0;c<b.length;c++)if("scid"===b[c].split("=")[0])return!0;return this.hasSessionStorage&&null!==sessionStorage.getItem(this.defaults.sessionStorageKey)?!0:!1},checkLocalStorage:function(){if(this.hasLocalStorage){this.ls=localStorage.getItem(this.defaults.localStorageKey);if(this.hasJSON&&this.ls)this.lsObject=JSON.parse(this.ls)||{};this.checkCurrentKey()}else this.showBanner()},checkCurrentKey:function(){var b=!1;if(this.lsObject[this.device])if(this.lsObject[this.device][this.path]){for(var c=
0;c<this.lsObject[this.device][this.path].length;c++)if(this.lsObject[this.device][this.path][c].campaignKey===this.campaignKey){this.now-this.lsObject[this.device][this.path][c].closedTime>this.redisplay&&this.showBanner();b=!0;break}this.removeOldKey();b||this.showBanner()}else this.showBanner();else this.showBanner()},removeOldKey:function(){for(var b in this.lsObject)for(var c in this.lsObject[b])for(var d=0;d<this.lsObject[b][c].length;d++)this.lsObject[b][c][d].closedTime<=this.now-this.removeKeyPeriod&&
this.lsObject[b][c].splice(d);this.saveLocalStorage()},showBanner:function(){function b(){var b=a.$window.scrollTop();e&&f&&50>screen.height-window.innerHeight&&(b+=69);a.$root.css({webkitTransition:"1s -webkit-transform ease-out",webkitTransform:"translate3d(0,"+b+"px,0)"})}function c(){var b=a.$window.scrollTop();if(b>=a.visibleFromPx&&a.hiddenFrom-a.windowHeight>b){if(!a.isBannerVisible){if(a.useVisibleFromPxOnlyFirst)a.visibleFromPx=0;a.$root.stop(!0,!0).fadeIn(a.fadeInTime);a.isBannerVisible=
!0;if(!a.isBannerDisplayed)0<a.autoHide&&setTimeout(function(){a.hideBanner(a.saveLSWhenAutoFade);if(!a.isHiddenEventTriggered)a.fireEvent(a.$root,a.defaults.events.FLOATING_BANNER_HIDDEN,{campaignKey:a.campaignKey,id:a.$root.attr("id")||"","class":a.$root.attr("class")||""}),a.isHiddenEventTriggered=!0},a.autoHide),a.isBannerDisplayed=!0;if(!a.isDisplayedEventTriggered)a.fireEvent(a.$root,a.defaults.events.FLOATING_BANNER_DISPLAYED,{campaignKey:a.campaignKey,id:a.$root.attr("id")||"","class":a.$root.attr("class")||
""}),a.isDisplayedEventTriggered=!0}}else if(0<=b&&a.isBannerVisible)a.$root.stop(!0,!0).fadeOut(a.fadeOutTime),a.isBannerVisible=!1}function d(){a.windowHeight=a.$window.height()}var a=this;this.$closeButton.bind("click",function(){a.hideBanner(!0);if(!a.isClosedEventTriggered)a.fireEvent(a.$root,a.defaults.events.FLOATING_BANNER_CLOSED,{campaignKey:a.campaignKey,id:a.$root.attr("id")||"","class":a.$root.attr("class")||""}),a.isClosedEventTriggered=!0});if(this.useOldBehavior){var e=null!==navigator.userAgent.match(/OS\s[7-9]_[0-9_]{1,3}\slike\sMac\sOS\sX/),
f=null===navigator.userAgent.match(/(Chrome|CriOS|FBAN|FBIOS|FBAV|FBBV|FBDV|FBMD|FBSN|FBSV|FBSS|FBCR)/);this.$root.stop(!0,!0).fadeIn(this.fadeInTime);0<this.autoHide&&setTimeout(function(){a.hideBanner(a.saveLSWhenAutoFade);if(!a.isHiddenEventTriggered)a.fireEvent(a.$root,a.defaults.events.FLOATING_BANNER_HIDDEN,{campaignKey:a.campaignKey,id:a.$root.attr("id")||"","class":a.$root.attr("class")||""}),a.isHiddenEventTriggered=!0},a.autoHide);this.isBannerVisible=!0;var h=navigator.userAgent.toLowerCase();
h.match(/(iphone|ipod)/i)?this.$root.addClass("popUpBalloon-iPhone"):h.match(/(ipad)/i)?this.$root.addClass("popUpBalloon-iPad"):h.match(/(android)/i)?h.match(/(mobile)/i)?this.$root.addClass("popUpBalloon-androidPhone"):this.$root.addClass("popUpBalloon-androidTablet"):this.$root.addClass("popUpBalloon-default");b();var g;this.$window.bind("scroll.RJSFloatingBanner",function(){clearTimeout(g);g=setTimeout(function(){b()},500)})}else this.$window.bind("scroll.RJSFloatingBanner",c).bind("resize.RJSFloatingBanner",
d),d(),c()},hideBanner:function(b){this.$root.fadeOut(this.fadeOutTime);if(b&&this.hasLocalStorage){this.lsObject[this.device]||(this.lsObject[this.device]={});this.lsObject[this.device][this.path]||(this.lsObject[this.device][this.path]=[]);for(var b=!1,c=0;c<this.lsObject[this.device][this.path].length;c++)if(this.lsObject[this.device][this.path][c].campaignKey===this.campaignKey){this.lsObject[this.device][this.path][c].closedTime=(new Date).getTime();b=!0;break}b||this.lsObject[this.device][this.path].push({campaignKey:this.campaignKey,
closedTime:(new Date).getTime()});this.saveLocalStorage()}this.$closeButton.unbind("click");this.$window.unbind("scroll.RJSFloatingBanner resize.RJSFloatingBanner")},saveLocalStorage:function(){if(this.hasJSON&&this.hasLocalStorage)this.ls=JSON.stringify(this.lsObject),localStorage.setItem(this.defaults.localStorageKey,this.ls)},convertDateStringToUnixMS:function(b){b=b.split(/-|:|\s/);return(new Date(Date.UTC(+b[0],+b[1]-1,+b[2],+b[3],+b[4],+b[5])-324E5)).getTime()},isLocalStorageSupported:function(){try{return localStorage.setItem("test",
"test"),localStorage.removeItem("test"),!0}catch(b){return!1}},isSessionStorageSupported:function(){try{return sessionStorage.setItem("test","test"),sessionStorage.removeItem("test"),!0}catch(b){return!1}},isJSONSupported:function(){return"JSON"in window&&"parse"in JSON&&"stringify"in JSON},checkDevice:function(){var b=navigator.userAgent;return/iPad|(?!Android.*Mobile)Android/.test(b)?"TB":/iPhone|iPod|Android.*Mobile/.test(b)?"SP":"PC"},checkCurrentPath:function(){return 0<=location.protocol.indexOf("http")?
location.pathname.replace(/\//g,"_").replace(/index\.html$/,""):"__local"},fireEvent:function(b,c,d){c=e.Event(c);c.customData=d||{};b.trigger(c)}};var g="true"===e("#floatingBannerScript").attr("data-use-scid"),i=e("#RJSFloatingBanner, .RJSFloatingBanner");0<i.length?i.each(function(b){0===b?new f(e(this),g):new f(e(this),!1)}):g&&new f(i,g)}})();
