KISSY.add("tbc/search-suggest/1.4.8/index",function(e,t,r,n,o,a,i,u,s){var l=(t.all,r.extend({initializer:function(){var e=this;e._initCombo(),e.bindUtil()},bindUtil:function(){var e=this;e.Utils=new u,e.Stat=new s},_setComboCache:function(e){var t=this,r=t.get("tab");t.configArr=t.configArr||[],t.configArr[r]={data:e}},_checkHasTab:function(){var e=this,t=e.getPlugin("tab");t||(e.tabNode=e.get("form"))},_initComboEvent:function(){var e=this,t=e.comboBox,r=t.get("input");r.on("mousedown",function(n){if(e.fire("beforeFocus")!==!1){var o=KISSY.trim(r.val()),a=e.get("sugConfig"),i=!0;i&&(a.autoCollapsed||""===o)&&t.sendRequest(o)}n.stopPropagation()}),r.on("focus",function(){e.fire("beforeFocus")}),r.on("blur",function(){return e.fire("beforeBlur")===!1?!1:void 0});var o=e.get("sugConfig").itemClick,a=!0;if(o&&KISSY.isFunction(o)){a=!1;var i=o.apply(this,arguments);i!==!1&&(a=!0)}a&&t.on("click",e.comboClick,e),t.on("afterCollapsedChange",e._addExtraEvent,e),t.on("afterCollapsedChange",function(t){e.fire("afterCollapsedChange",t)}),t.on("beforeQueryChange",function(t){e.fire("beforeQueryChange",t)}),t.on("beforeSetInputValue",function(){var t=e.get("label");t&&n.hide(t)}),e._formSubmitEvent(),e.query=r.val();var u=e.get("label");u&&u.on("click",function(){t.sendRequest(r.val())})},_formSubmitEvent:function(){var e,t=this,r=t.comboBox,n=r.get("input"),o=n.parent("form"),a=r.get("input");o.on("submit",function(r){t.fire("beforeSubmit",{el:o,isInitSearch:!0})!==!1?(e=o.attr("action"),""===KISSY.trim(a.val())&&t._emptyJump(o)===!1&&r.preventDefault(),t.serializeToForm(o,e)):r.halt()})},serializeToForm:function(e,t){var r,n,o,a="",i="";if(t&&e){if(-1===t.indexOf("?"))return;if(a=t.split("?")[1]){r=a.split("&");for(var u in r)n=r[u].split("="),o=n[0],o&&!e[0][o]&&(i+='<input type="hidden" name="'+n[0]+'" value="'+n[1]+'"/>');e.append(i)}}},_defaultPageJump:function(e){var t,r=this,n=r.tabNode;if(!n)return!1;if(t=e.attr("data-defaultpage")||n.attr("data-defaultpage")){if(!/(http(s:|:))?\/\//.test(t))return!1;e.attr("action",t)}},_emptyJump:function(e){{var t,r=this,n=e.one("label"),o=r.get("sugConfig");o.tab}return n?(t=n.one("span"),t&&""!==t.text()?(n.hide(),void r._holderJump(e,t.text())):r._defaultPageJump(e)):r._defaultPageJump(e)},_holderJump:function(e,t){var r=e[0].q;r&&(r.value=t),e.append('<input type="hidden" name="style" value="grid" />')},_sendSnapshot:function(e){for(var t=this,r=[],n=-1,o=0;o<e.children.length;o++){var a=e.children[o];e.selected==a.value?n=o:r.push(a.value+"/"+a.index)}var i="f_stats_show=xialalist:";i+=r.join(","),i=i+";query:"+e.query,i=i+";selected:"+e.selected+"/"+n,i=i+";time:"+KISSY.now(),i=i+";nick:"+t.getNick(),t.Stat.send(i,!0)},comboClick:function(e){var r,n=this,o=e.target.get?e.target.get("el"):t.one(e.currentTarget),a=n.comboBox,i=o.one(".item-text, .search-menu-key, .search-menu-history-key"),u=!1,s=n.get("form"),l=n.get("sugConfig").isSendByForm;if(i){r=i.text();var c=n.historyArr;if(c)for(var f=0,d=c.length-1;d>=f;f++)if(r===c[f]){u=!0;break}}for(var g=a.get("menu"),m=g.get("children"),p=[],f=0;f<m.length;f++){var h=m[f],v=h.get("value");v&&p.push({index:f,value:v[0]})}var b={query:n.query||"",children:p,selected:r||""};if(n._sendSnapshot(b),n.fire("beforeSubmit",{el:o,isInitSearch:!1,isNotSave:u})!==!1){var C=n.getRedirect(o);l?(n.serializeToForm(s,C),s[0].submit()):n.redirect(C)}},getRedirect:function(e){var t=this,r=(t.comboBox,t.query),o=t.query,a=n.children(e),i=n.attr(a,"data-key")||"q="+r,u=t.get("form")[0],s=n.attr(u,"action"),l=n.attr(a,"data-action")||t.get("action")||s,c=n.attr(a,"data-source-stat")||"source=suggest",f="&_input_charset=utf-8&wq="+encodeURIComponent(o)+"&suggest_query="+encodeURIComponent(r)+"&"+c,d=t._getInputsVal(u);return l+=l.indexOf("?")>-1?"&":"?",l+d+"&"+i+f},redirect:function(e){var t=this,r=t.get("sugConfig").isEncode;r?e=t.urlEncode(e):(e=e.replace(/(#)[^!]/g,function(e,t){return e.replace(t,"%23")}),e=e.replace(/#!/g,"#"));var n=document.createElement("a");n.setAttribute("href",e),n.setAttribute("target","_self"),n.style.display="none",document.body.appendChild(n),n.click()},urlEncode:function(e){var t=/[\u4e00-\u9fa5\uf900-\ufa2d+#\s]+/g.exec(e);if(t)try{e=e.replace("ï¼","?"),e=e.replace(/[\u4e00-\u9fa5\uf900-\ufa2d+#]+/g,function(e){return encodeURIComponent(e)}),e=e.replace(/\s/g,function(e){return"+"}),e+="&ie=utf-8"}catch(r){KISSY.log("urlç¼ç åºé!")}return e},_getInputsVal:function(e){var t,r,o=this,a=o.get("sugConfig"),i=a.excludeParam,u=[];inputs=n.query("input",e);for(var s=inputs.length-1;s>=0;s--)t=inputs[s],r=t.name,r&&!KISSY.inArray(r,i)&&u.push(r+"="+encodeURIComponent(t.value));return u.length<1?"":"&"+u.join("&")},_getDefComboCfg:function(){return{focused:!1,hasTrigger:!1,matchElWidth:!0,srcNode:".allWidth",highlightMatchItem:!1,menu:{align:{overflow:{adjustY:0}}},cache:!0}},_prepareHtml:function(e){var r=this,o=n.get(e.node),a=o.innerHTML,i=e.prefixCls,u=n.get(e.placeholderEl),s=u?u.outerHTML:"",l='<div class="{cls}combobox"><div class="{cls}combobox-input-wrap"></div></div>',c=l.replace(/{cls}/g,i).replace(/{label}/g,s).replace(/{input}/g,a),f=n.create(c),d={"aria-haspopup":"true","aria-combobox":"list",role:"combobox",autocomplete:"off","class":i+"combobox-input","x-webkit-grammar":"builtin:translate"};return n.attr(o,"aria-label")||(d["aria-label"]=r._isOpen("history")?"è¯·è¾å¥æç´¢æå­æä»æç´¢åå²ä¸­éæ©":"è¯·è¾å¥æç´¢æå­"),n.attr(o,d),n.wrap(o,f),this.get("sugConfig").focused&&n.get(o).focus(),t.one("."+i+"combobox")},_isOpen:function(e){var t=this,r=t.get("mods"),n=r.sort;return KISSY.inArray(e,n)},_getRenderMods:function(){var e=this,t=KISSY.merge(a,e.get("mods"));e.set("mods",t)},_getDataSourceCfg:function(){var e=this,t=e.get("sugConfig"),r=e.get("dataSourceCfg"),n=t.sourceUrl;return location.href.indexOf("debug=test")>-1&&(n=n.replace("suggest.taobao.com/sug?","suggest.proxy.taobao.org/sug?")),-1===n.indexOf("bucketid")&&(n+="&bucketid="+e._getBucketId()),r.xhrCfg.url=n,r.parse=KISSY.bind(e.parse,e),r},_getBucketId:function(){return(new i).getBucket()},_getComboCfg:function(e){var r=this,n=r.get("sugConfig"),o=r._getDefComboCfg(),a=n.prefixCls,i=t.one("."+a+"-combobox");return i||(i=r._prepareHtml(n)),o.srcNode=i,o.dataSource=e,o.format=KISSY.bind(r.format,r),o.prefixCls=n.prefixCls,o.holderEl=t.one(n.placeholderEl),o.maxItemCount=o.maxItemCount||e.maxItemCount,o},_initCombo:function(){var e,t,r=this,n=r._getDataSourceCfg(),a=r.get("sugConfig");r._getRenderMods(),a.sourceUrl?(e=new o.RemoteDataSource(n),e.maxItemCount=10):(e=new o.LocalDataSource(n),e.maxItemCount=0),r._setComboCache(e),t=r._getComboCfg(e);var i=new o(t);i.render(),r.comboBox=i,r._checkHasTab(),r._initComboEvent()},update:function(e){for(var t=this,r=t.get("plugins"),n=0,o=r.length-1;o>=n;n++){var a=r[n];a&&KISSY.isFunction(a.update)&&a.update.call(a,e)}},parse:function(e,t){var r,n=this,o=n.fire("beforeParse",{results:t,query:e});if(o===!1)return[[""]];if(o&&(t=o),!t||!t.result)return KISSY.log("æ¥å£æ æ°æ®!"),[[""]];r=t.result,delete t.result;var a=n.comboBox.get("dataSource");if((a.extraData||(a.extraData=[]))[e]=t,0===r.length)return[[""]];for(var i in r)r[i]||r.splice(i,1);return r},format:function(e,t){var r=this;return r.resultArr=[],r.render(e,t),r.resultArr},render:function(e,t){var r,n,o,a,i,u,s=this,l=s.get("mods"),c=l.sort,f=s._adjustExtra(e,l.showExtra);s.query=e;for(var d=0,g=c.length-1;g>=d;d++)if(u=c[d])if("list"!==u){if(i=s.getPlugin(u),i&&i.renderPlugin)i.renderPlugin({query:e,results:t});else if(n=l[u],n&&f&&(!(a=n.pos)||o!==a)){if(r=n.tmpl,!r)continue;var m=s.resultArr.length,p=s.diffLen||0;o=s.defaultRender({tmpl:r,name:u,pos:a,always:n.always&&t.length>0,callback:n.callback,index:m-p})}}else n=l[u],r=n.tmpl,s._list(e,t,r);s.fire("afterQueryChange",{query:e})},defaultRender:function(e){var t,r=this,n=e.tmpl,o=e.name,a=r.comboBox.get("dataSource"),i=r.query,u=r.get("sugConfig").prefixCls,s=a.extraData,l=e.pos,c=e.index;if(s&&s[i]||e.always){var f,d,g=r._getDate(),m={$query:i,$queryUrl:encodeURIComponent(i),$date:g,prefixCls:u};if(!e.always){if(f=s[i][o],d=!0,!f)return;if(KISSY.isArray(f)){f.length>2&&(f.length=2);for(var p=0,h=f.length;h>p;p++){var v=f[p];if(KISSY.isArray(v)){d=!1;for(var b=0,C=v.length;C>b;b++)m["$"+b]=v[b]||"";m.$3=encodeURIComponent(m.$2),m.$index=c+1+p,t=KISSY.substitute(n,m),r.addContent({html:t,query:i,position:l,callback:e.callback})}else m["$"+p]=v,m.$index=c+1+p}return d&&(t=KISSY.substitute(n,m),r.addContent({html:t,query:i,position:l,callback:e.callback})),l}if(KISSY.isObject(f)){for(var x in f)m[o+"_"+x]=f[x];"active"===o&&(m.$query=f.query+" "+f.tag)}else m[o]=f,m.$query=f}return m.$index=c+1,t=KISSY.substitute(n,m),r.addContent({html:t,query:m.$query||i,position:l,callback:e.callback}),l}},_adjustExtra:function(e,t){return""!==e?!0:!1},getNick:function(){var e=this;return e._getCookie("lgc")||e._getCookie("tracknick")},_getCookie:function(e){var t=window;if(t.userCookie&&!KISSY.isUndefined(t.userCookie[e]))return t.userCookie[e];if(t.SRP_COOKIES||(t.SRP_COOKIES={})&&KISSY.isUndefined(SRP_COOKIES[e])){var r=document.cookie.match("(?:^|;)\\s*"+e+"=([^;]*)");SRP_COOKIES[e]=r&&r[1]?decodeURIComponent(r[1]):""}return SRP_COOKIES[e]},_getDate:function(){var e=new Date;return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+(e.getDate()+1)},_list:function(e,t,r){var n,o=this,a=o.get("sugConfig").resultFormat,i=o.resultArr||(o.resultArr=[]);KISSY.each(t,function(o,u){if(!o||!o[0])return void t.splice(u,1);var s,l=o[0],c="",f=e;if(l.match(/<b>/))n=l.replace(/<b>(\S+?)<\/b>/g,function(e,t){return t}),c=l,l="";else{for(;l.indexOf(f)<0;)f=f.substr(0,f.length-1);""===f?(c=l,l=""):0===l.indexOf(f)?(c=f,l=l.replace(f,"")):(c=l,l=""),n=o[0]}for(var d in i)if(s=i[d],s.textContent===o[0]&&s.unique)return;r=r.replace("{format}",a),i.push({textContent:n,content:KISSY.substitute(r,{query:c,text:l,index:u+1,count:o[1],textContent:encodeURIComponent(n)}),list:!0})}),o.resultArr=i},addContent:function(e){var t=this,r=e.html,n=e.position,o=e.query;if(!n){var a=t.resultArr||[];return void a.push({content:r,textContent:o})}t["__"+n]={tmpl:r},t._addExtraEvent()},_renderHeader:function(e,r,n){var o=r&&r.type+"-header"||"";if(r){var a=this.get("sugConfig").prefixCls;e||(e=new t("<div class='"+a+"combobox-menu-header "+o+"'></div>").prependTo(n)),e.empty().append(r.tmpl)}else e&&e.remove()},_renderFooter:function(e,r,n){var o=this,a=o.get("sugConfig").prefixCls,i=r&&r.type+"-footer"||"";if(r){e||(e=new t("<div class='"+a+"combobox-menu-footer "+i+"'></div>").appendTo(n)),r.css&&e.css(r.css),e.empty().append(r.tmpl);var u=e.one("."+a+"menu-history-clean");u&&u.on("click",function(e){e.halt();var t=o.getPlugin("history");t._cleanHistory()})}else e&&e.remove()},_addExtraEvent:function(e){var t=this,r=t.comboBox||t,n=t.__header,o=t.__footer,a=t.__lastHeader,i=t.__lastFooter,u=t.get("sugConfig").prefixCls;if(!e||e&&!e.newVal){var s=r.get("menu");if(!s.get)return;var l=s.get("el");if(!l||l.all("."+u+"menuitem").length<1)return;var c=l.one("."+u+"combobox-menu-header"),f=l.one("."+u+"combobox-menu-footer");a!==n&&(t.__lastHeader=n,t._renderHeader(c,n,l)),i!==o&&(t.__lastFooter=o,t._renderFooter(f,o,l))}else t.__header=null,t.__footer=null}},{ATTRS:{sugConfig:{value:{extraPassParams:"",extraPostParams:"",sourceUrl:"",tab:"item",autoCollapsed:!0,focused:!1,prefixCls:"search-",excludeParam:["q"],resultFormat:"çº¦{count}ä¸ªå®è´"},setter:function(e){var t=this.get("sugConfig");return KISSY.mix(t,e,void 0,void 0,!0)}},mods:{value:{},setter:function(e){return e}},input:{getter:function(e){return e||(e=this.comboBox.get("input"))}},form:{getter:function(e){return e||(e=this.get("input").parent("form"))}},label:{getter:function(e){return e||(e=this.comboBox.get("holderEl"))}},menu:{getter:function(e){return e||(e=this.comboBox.get("menu"))}},dataSourceCfg:{value:{xhrCfg:{url:"",dataType:"jsonp",scriptCharset:"utf-8",data:{code:"utf-8"}},allowEmpty:!0,paramName:"q",cache:!0}}}}));return l},{requires:["node","base","dom","./suggest","./mods/mods","./mods/bts","./mods/utils","./mods/stat"]});KISSY.add("tbc/search-suggest/1.4.8/plugin/history",function(e,t,r,i,n){function a(e){a.superclass.constructor.call(this,e||{}),KISSY.sug=KISSY.bind(this._retSug,this)}var o;return KISSY.extend(a,t,{pluginInitializer:function(e){var t=this,r=e.get("sugConfig"),i=r.tab||"";o=e.Stat,e.set("extend",{history:!0}),t.set("caller",e),t.localQueryMap={},t.localQueryPinyingMap={},t.historyLocalQuery=t.localQueryMap[i]=new n({name:"history",tab:i,user:e.getNick()}),t.pinyingLocalQuery=t.localQueryPinyingMap[i]=new n({name:"pinyin",tab:i,user:e.getNick()}),t.hitedHistoryListMap={};var a=e.comboBox;setTimeout(function(){t.historyLocalQuery.checkFlash({onSuccess:function(){t.historyReady=!0,a.on("afterCollapsedChange",function(e){if(!e.newVal){a.detach("afterCollapsedChange",arguments.callee);var i=a.get("menu").get("el");i.delegate("mousedown","."+r.prefixCls+"menu-history-delete",t._historyDeleteMousedown,t)}}),e.on("beforeSubmit",function(e){var r=a.get("input").val(),i=e.isNotSave;""===KISSY.trim(r)||r.match(/[<>'"]/g)||t.pinyingLocalQuery&&!i&&t.pinyingLocalQuery.save(r,KISSY.trim(r))}),setTimeout(function(){t._getPinyinQuery()},1e3)},onFailure:function(){KISSY.log("loading flashStorage failure!")}})},500)},_dealUrl:function(e,t){var r="&area=history",i=e.indexOf(r)>-1;return t?!i&&e+r:i&&e.replace(r,"")},_getPinyinQuery:function(){var e=this,t=e.historyLocalQuery,r=e.pinyingLocalQuery.query();if(r.length>0){var i=decodeURIComponent(r[0].key);/[\u4e00-\u9fa5]/.test(i)?(e._getPinyin(r[0].key),e.pinyingLocalQuery.clearByDay(0)):(e.pinyingLocalQuery.clearByDay(0),t.save(i,KISSY.trim(i)))}},_renderHTML:function(e,t){var r,i=this,n=i.get("caller"),a="",o=n.get("mods").history.tmpl,t=t||{},s=n.resultArr||(n.resultArr=[]),l=[];e=KISSY.unique(e);for(var u=0,c=e.length-1;c>=u;u++)0!==u&&(t.attr=""),t.index=(u+1).toString(),t.historyItemValue=decodeURIComponent(e[u].key),t.historyItemQuery=e[u].key,a=KISSY.substitute(o,t),r=t.historyItemValue,l.push(r),s.push({content:a,textContent:r,unique:!0});n.historyArr=l},renderPlugin:function(){if(this.historyReady){var e,t,r=this,i=r.get("caller"),n=i.query,a=r.historyLocalQuery.query(n),o=r.get("limit"),s=i.get("sugConfig"),l=i.comboBox.get("dataSource"),u=l.extraData&&l.extraData[n];if(r.get("web")&&""===n&&u&&u.cloud)return void r._renderHTML(u.cloud,{prefixCls:s.prefixCls});""===n&&a.length>0?(i.__header={tmpl:'<div class="history-box"><span>æè¿æè¿</span></div>',type:"history"},i.__footer=null,e=o):(i.__header=null,i.__footer=null,e=2),t=a.splice(0,e),i._addExtraEvent(),r._renderHistoryItems(t),r.hitedHistoryListMap[n]=t}},_historyDeleteMousedown:function(e){for(var t=this,i=t.get("caller"),n=r.one(e.target),a=n.parent().attr("data-value"),o=n.parent(2),s=i.comboBox,l=s.get("menu"),u=l.get("children"),c=n.attr("data-type"),y=0;y<u.length;y++){var g=u[y];if(g.get("el")[0]===o[0]){l.removeChild(g,!0);break}}var d=t.historyLocalQuery;d&&("history"===c?d.deleteItem(a):"most"===c&&(d._setKey({name:"most"}),d.save(a,a),d._setKey({name:"history"}))),s.sendRequest(i.query),t._sendStat(a)},_sendStat:function(e){var t,r=this.get("caller"),i={},n=location.hostname,a="op=del&nk={nick}&src={host}&q={query}&app=sug";i.nick=r.getNick(),i.query=e,i.host=n.replace(/com|\./g,""),t=KISSY.substitute(a,i),o&&o.send(t)},_renderHistoryItems:function(e,t){var r=this,i={},n=r.get("caller"),a=n.get("sugConfig");i.prefixCls=a.prefixCls,i.attr=t&&t.attr||"",i.extraParam=t&&t.param||"history",r._renderHTML(e,i)},_getPinyin:function(e){var t=this,r=location.protocol+"//suggest.taobao.com/sug?code=utf-8&area=py&callback=KISSY.sug&q="+e;t._savedInputValue=decodeURIComponent(e),KISSY.getScript(r)},_retSug:function(e){if(e&&e.result){var t=e.result[0],r=this,i=r._savedInputValue;r.historyLocalQuery&&r.historyLocalQuery.save(i,KISSY.trim(t))}},_cleanHistory:function(){var e=this,t=e.get("caller"),r=t.comboBox,i=r.get("menu"),n=i.get("el"),a=r.get("input"),o=t.get("sugConfig"),s=o.prefixCls,l=n.one("."+s+"combobox-menu-header");e.historyLocalQuery.clearByDay(0),e.hitedHistoryListMap={};var u=l.siblings();u.css("display","none"),l.html('<div class="history-box"><span>æç´¢åå²å·²æ¸ç©º</span></div>');var c=new KISSY.Anim(n,{opacity:0},3,"easeIn",function(){u.css("display","block"),n.css({opacity:1,visibility:"hidden"})});c.run(),a.on("blur keydown mousedown",function(e){c.isRunning()&&c.stop(!0),t.__header=null,t.__footer=null,"keydown"===e.type&&this.value&&n.css("visibility","visible"),a.detach("blur keydown mousedown",arguments.callee)})},update:function(e){var t=this,r=encodeURI(e.tab);t.localQueryMap[r]||(t.localQueryMap[r]=new n({name:"history",tab:r,user:t.get("caller").getNick()}),t.localQueryPinyingMap[r]=new n({name:"pinyin",tab:r,user:t.get("caller").getNick()})),t.pinyingLocalQuery=t.localQueryPinyingMap[r],t.historyLocalQuery=t.localQueryMap[r],t._getPinyinQuery()}},{ATTRS:{pluginId:{value:"history"},limit:{value:10,setter:function(e){return KISSY.isNumber(e)?e:void 0}}}}),a},{requires:["base","node","event","../mods/local-query"]});KISSY.add("tbc/search-suggest/1.4.8/plugin/cloud",function(e,t,n,a,r,i,o,s){function l(e){l.superclass.constructor.call(this,e||{})}var u,d,h,c=a.all;return KISSY.extend(l,t,{pluginInitializer:function(e){var t,r,i=this,s=e.comboBox;i.isNotFirstRender=[],i.count=0,u=e,d=i.Utils,h=i.Stat,i.set("caller",e),i.initKeyEvent();var l=n.children(e.get("el")),c=e.get("form")[0],g=n.attr(c,"action"),m=n.attr(l,"data-action")||e.get("action")||g;i.set("action",m),s.on("beforeShow",function(e){if(i.isShowFirstItem){var t=s.get("menu"),n=t.get("children");t.set("highlightedItem",n[0]),i.show(n[0].get("el")[0])}else i.setCloudHeight()}),e.on("afterCollapsedChange",function(n){n.newVal||(e.detach("afterCollapsedChange",arguments.callee),i.mouseArr=[],r=e.get("menu"),t=r.get("el"),t.addClass("search-cloud-menu"),i.initMenu||(a.one(".search-menu")&&(i.initMenu=!0,i.menu=new o({wrap:".search-menu",menu:".search-contentbox,.search-menu-content",rows:".search-menuitem",cls:".search-wrap-cloud",tolerance:500,handler:{enterHandler:function(t){e.fire("beforeCloudShow",{inst:i,el:t})!==!1&&i.show(t)},leaveHandler:function(e){i.hide(e)}}})),r.on("afterHighlightedItemChange",function(){i.setCloudHeight()}),i.initMouseEvent(t)))})},initMouseEvent:function(e){return e?void e.delegate("click",".cloud-list a",function(e){var t=e.currentTarget,n=t.getAttribute("href");n&&(n=u.urlEncode(n),t.setAttribute("href",n))}):!1},show:function(e){var t=this;t._showCloud(e),t.setCloudHeight()},hide:function(){this._hideCloud()},setCloudHeight:function(){var e,t=u.get("menu").get("el"),n=a.one(".cloud-footer");if(t.width()<500?t.addClass("narrow-suggest-menu"):t.removeClass("narrow-suggest-menu"),n){if(e=n.one(".cloud-box"),e.css("height","auto"),t.css("height","auto"),e){var r=t.height(),i=e.height();i>r?t.height(i-1):(t.css("height","auto"),e.css("height","100%"))}}else t.css("height","auto")},_hideCloud:function(){c(".cloud-footer").hide(),c(".search-menu-item-hover").removeClass("search-menu-item-hover")},_showCloud:function(e){var t,n,r,i=this,o=c(".search-wrap-cloud",e),s=a.one(".cloud-footer");c(".search-menu-item-hover").removeClass("search-menu-item-hover"),c(e).addClass("search-menu-item-hover"),i.lastItemIndex&&(n=a.one("#J_CloudList"+i.lastItemIndex),n&&n.hide(),s&&s.hide()),o.length&&(t=o.attr("data-index")||o.one("div").attr("data-index"),i.lastItemIndex=t,n=a.one("#J_CloudList"+t),n&&(r=n.attr("data-align"),i.set("align",!("true"!==r)),n.show(),s&&s.show(),i.setPadding(c(e),n)))},_sendStat:function(){var e=(u.getPlugin("stat"),"f_stats_show=magic:1"),t=u.get("sugConfig").sourceUrl,n="";t&&t.match(/bucketid=\w+/)&&(n=t.match(/bucketid=(\w+)/)[1],e+=";bts:"+n),h&&h.send(e,!0)},getPadding:function(e,t){var n=32,r=a.one(".search-menu"),i=r.offset().top,o=e.offset().top,s=o-i,l=r.height(),u=t.height(),d=s-n,h=l-u-d-10;return d>0?h>=0?d:d-=39*Math.round(-h/39):void 0},initKeyEvent:function(){var e=this,t=u.comboBox,n=r.KeyCodes||a.KeyCode;t.on("beforeKeyDown",function(r){var i=this.get("menu");if(i.get){var o,s,l,d,h=r.event,c=i.get("highlightedItem"),g=i.get("children"),m=g.length;if(0===m)return void 0;switch(h.keyCode){case n.ENTER:var v=e.isShowMagic(),f=e.isShowItem(),p=v||f;return p&&(h.halt(),!v&&f&&KISSY.UA.ie>=10?c.fire("click"):p.click()),!1;case n.UP:case n.DOWN:var w,S;h.keyCode===n.UP?(S=m-1,w=-1):(S=0,w=1),e.isTriggerArrowKey=!0,c?(o=KISSY.indexOf(c,g),s=(o+w+m)%m):s=S;var C=a.one(".cloud-link-wrap-hover");return C&&C.removeClass("cloud-link-wrap-hover"),0===o&&-1===w||o===m-1&&1===w?(e._hideCloud(),i.set("highlightedItem",null),t._stopNotify=1,u.get("input").val(t._savedInputValue||t._savedValue),!1):(l=i._getNextEnabledHighlighted(s,w),i.set("highlightedItem",l),e.show(l.get("el")[0]),t._stopNotify=1,d=l.get("textContent"),t.setValueFromAutocomplete?t.setValueFromAutocomplete(d):(t._stopNotify=1,u.get("input").val(d)),t.fire("beforeSetInputValue",{event:h}),!1);case n.HOME:case n.END:return l=h.keyCode===n.END?i._getNextEnabledHighlighted(m-1,-1):i._getNextEnabledHighlighted(0,1),i.set("highlightedItem",l),e._showCloud(l.get("el")[0]),t.setValueFromAutocomplete?t.setValueFromAutocomplete(l.get("textContent")):(t._stopNotify=1,u.get("input").val(l.get("textContent"))),!1;default:e.directionEvent(h)}}})},isShowMagic:function(){var e,t,a,r=c(".J_cloud-handle");return r.each(function(t,a){"none"!==n.css(t,"display")&&(e=t)}),e?(t=n.query(".cloud-link-wrap-hover")[0],t&&(a="a"===t.tagName.toLowerCase()?t:n.query("a",t)[0]),a):void 0},isShowItem:function(){var e=this;return e.isTriggerArrowKey&&n.get(".search-menu-item-hover")},directionEvent:function(e){var t,n,r,i,o,s=this;switch(e.keyCode){case 39:case 37:if(o=u.get("menu"),t=o.get("activeItem")||o.get("highlightedItem"),!t)return!0;if(n=t.get("el").one(".item-wrapper"),!n)return!0;if(r=n.attr("data-index"),!r)return!0;if(i=a.one("#J_CloudList"+r),!i)return!0;var l=e.keyCode-37?"next":"prev";s.getHighLightItem(i,l)}},getHighLightItem:function(e,t){var n=e.one(".cloud-link-wrap-hover");if(n){var a=~~e.attr("data-select-index"),r=e.all(".cloud-link");a="next"==t?a<r.length-1?a+1:0:a>0?a-1:r.length-1,n.removeClass(".cloud-link-wrap-hover");var i=r.item(a);e.attr("data-select-index",a),i.parent().addClass("cloud-link-wrap-hover")}else{var o=e.one(".cloud-link").parent();o&&o.addClass("cloud-link-wrap-hover"),e.attr("data-select-index",0)}},setPadding:function(e,t){var n=this,a=t.one(".inner-wrap"),r=this.getPadding(e,a),i=n.get("align");i&&r&&a.css("paddingTop",r)},checkRender:function(e){var t,n=this,a=e.comboBox,r=e.query,i=a.get("dataSource"),o=i.extraData[r],s=e.resultArr;return t=""!==r&&o?{extra:o,query:r,results:s}:!1,n.extraData=o,n.isShowFirstItem=!1,t},isAutoShow:function(e){return!!(KISSY.isArray(e)&&e.length>0&&(e[0].list||e[0].tag))},renderPlugin:function(){var e=this,t=e.checkRender(u);if(!t)return!1;var n,a,r,i,o,s,l,d,h="",c=t.extra,g=t.results,m=t.query;e.isFirstShow=!1,n=KISSY.clone(c.magic);for(var v=e.isAutoShow(u.resultArr),f=0,p=g.length-1;p>=f;f++)if(a=g[f],o=a.content,r=o.match(/data-index='(\w+)'/),i=o.match(/data-key='([\S\s]+?)'/),r&&r[1]){r=r[1]-0,i&&i[1]&&(i=i[1]);for(var w in n)s=n[w],r===s.index-0&&(e._wrapItem(a,i),d=e._renderHTML({data:s,query:m,index:r,key:i,auto:v,type:s.type||"tag",tagTitle:decodeURIComponent(i.match(/q=([^&]+)/)[1]),action:e.get("action")}),d&&(h+=d),1===r&&d&&(l=!0))}var S={tmpl:'<div class="cloud-box">'+h+"</div>",type:"cloud"};if(v&&l?(S.css={display:"block"},e.isShowFirstItem=!0):(S.css={display:"none"},e.isShowFirstItem=!1),KISSY.UA.ie<7){var C=u.resultArr.length;S.css.height=26*C}u.__footer=S,u._addExtraEvent(),e.isTriggerArrowKey=!1},_wrapItem:function(e,t){var n;KISSY.isObject(e)&&(n=e.content,e.content="<div class='search-wrap-cloud' data-key='"+t+"'>"+n+"</div>")},_renderHTML:function(e){var t,n,a,r=this,i={},o=e.data,s=e.query,l=(e.tagTitle,e.index),u=r.extraData,d=e.type,h=e.auto&&1===l?"style='display:block'":"";if(u&&u.event&&1===l)t=r.get("event-tmpl"),n=r.get("event-param");else{if(!d)return KISSY.log("é­çç±»åä¸å­å¨!"),h="",!1;if(a=r.get(d),!a)return KISSY.log("æ¥å£è¿åçç±»å"+d+"ä¸å­å¨å¯¹åºçæ¨¡æ¿"),h="",!1;t=a.tmpl,a.length&&o.data&&o.data.length>a.length&&(o.data.length=a.length),a.sort&&r.sort(o.data),n=r.get("param")}i.param=n?"&"+n:"",i.query=s,i.index=l,i.prefix=e.prefix||l,i.tagTitle=e.tagTitle,i.action=e.action,o.count&&o.count<=3&&(i.ishidden="hidden"),i=KISSY.merge(i,o),i.autoAttr=h;var c=t(i);return c},sort:function(e){Array.prototype.sort.call(e,function(){return Math.random()>.5?-1:1})}},{ATTRS:{pluginId:{value:"cloud"},limit:{value:3,setter:function(e){return KISSY.isNumber(e)?e:void 0}},tag:{value:{tmpl:s.tag,sort:!0,length:10}},tag_group:{value:{tmpl:s.tag_group,length:10}},navi:{value:{tmpl:s.navi}},spu:{value:{tmpl:s.spu,length:3}},topbrand:{value:{tmpl:s.topbrand}},qrcode:{value:{tmpl:s.qrcode}},align:{value:!0}}}),l},{requires:["base","dom","node","event","cookie","../mods/menu","../tpl/cloud"]});KISSY.add("tbc/search-suggest/1.4.8/plugin/history-magic",function(t,e,a,i,r){function o(t){o.superclass.constructor.call(this,t||{})}return KISSY.extend(o,e,{pluginInitializer:function(t){var e=this,i=t.getPlugin("cloud"),r=500;this.sug=t,e.set("cloudPlugin",i),e.set("caller",t);var o;t.on("afterQueryChange",function(n){o&&clearTimeout(o),e.isGetData&&(r=0),o=setTimeout(function(){var r=t.get("menu").get("el");e.getPostData(r,function(t){if(t){var e=a.get(".search-menuitem");i.show(e)}})},r)})},getPostData:function(t,e){var i=this,r=".search-menu-history-key",o=a.query(r,t),n=a.query(".search-menu-extras-history",t),u=[],s=[],c=[],l=i.historyData||{},g=!0;if(!o)return!0;for(var d=0,h=n.length-1;h>=d;d++){var f=a.text(o[d]);u.push(a.attr(n[d],"data-index")),l[f]?l[f].index=d+1:(s.push(f),l[f]={}),c.push(f)}i.historyData=l,0===s.length&&(g=!1);var v={text:c,index:u,el:n,result:{content:a.outerHTML(t)}};if(g)var x=i.getMagicData(v,function(t){e.call(this,t)});else{var y=i.getLocalData(c);i.render(v,y,function(t){e.call(this,t)})}return x},getLocalData:function(t){for(var e,a={},i=this.historyData,r=0;r<t.length;r++)e=t[r],a[e]=i[e];return a},getMagicData:function(t,e){var a=this,o=t.text,n=a.get("dataUrl"),u=n.replace("{query}",o.join("%01"));-1===u.indexOf("bucketid")&&(u+="&bucketid="+(new r).getBucket()),i.jsonp(u,function(i){a.isGetData=!0,a.render(t,i.magic,e,!0)})},render:function(t,e,i,r){var o,n,u,s,c=this,l=c.get("cloudPlugin"),g=t.text,d=t.index,h=t.el,f=!1;if(!e)return!0;c.checkCloudBox();for(var v in e){var x=e[v],y=x.index-0;x.data&&(n="_his_"+y,s=KISSY.indexOf(n,d),u=g[s]||v,c.historyData[u]=e[v],s>-1&&a.addClass(h[s],"search-wrap-cloud"),o=l._renderHTML({result:t.result,data:e[v],query:u,index:n,key:u,auto:!1,type:e[v].type||"tag",tagTitle:u,prefix:n,action:c.sug.userConfig&&c.sug.userConfig.action}),a.get("#J_CloudList"+n)&&a.remove("#J_CloudList"+n),a.append(a.create(o),".cloud-box"),1===y&&(f=!0))}i.call(this,f)},checkCloudBox:function(){var t=this.get("caller"),e=t.get("menu").get("el");if(e&&!a.get(".cloud-box")){var i='<div class="search-combobox-menu-footer cloud-footer"><div class="cloud-box" style="height: auto"></div></div>';e.append(i)}},update:function(){}},{ATTRS:{pluginId:{value:"historyMagic"},dataUrl:{value:location.protocol+"//suggest.taobao.com/sug?area=history_magic&q={query}"},cloudPlugin:{value:null}}}),o},{requires:["base","dom","ajax","../mods/bts"]});KISSY.add("tbc/search-suggest/1.4.8/plugin/tab",function(t,a,o,e,r,s){function i(t){i.superclass.constructor.call(this,t||{})}return KISSY.extend(i,o,{pluginInitializer:function(t){this.tabConfig={},this._initPluginEvent.call(this,t)},tabClick:function(t){var o,r,s=this,i=s.get("caller"),c=t.currentTarget,n=e.attr(c,"data-searchtype"),l=e.attr(c,"data-defaultpage"),g=e.attr(c,"data-action"),u=i.comboBox.get("input"),f=e.parent(u,"form"),b=s.get("activeCls"),d=e.get("label",f),C=s.tabConfig;if(i.fire("beforeTabChange",{el:c,labelType:n})===!1)return!1;if(e.removeClass(e.siblings(c),b),e.addClass(c,b),i.tabNode=a.one(c),l&&f.setAttribute("data-defaultpage",l),g&&f.setAttribute("action",g),n){if(r=C[n]||s.getDefCfg(n),!r)return!1;g&&(r.action=g),i.update(r),s.tabConfig&&!s.tabConfig[n]&&s.saveTabConfig(r)}else{var m=i.query||u.val(),h=e.get("a",c);if(h){var p=e.attr(h,"href");p=p.replace("/?","/search?"),p=p+"&q="+m,e.attr(h,"href",p)}}d&&(o=d.getAttribute("data-searchtype-"+n)||"",d.innerHTML=o),t.preventDefault()},_initPluginEvent:function(t){var o=this,e=o.get("activeCls"),s=o.get("node")||t.get("sugConfig").tablist;o.set("caller",t),s&&(r.on(s,"click",o.tabClick,o),a.all(s).each(function(a,o){a.hasClass(e)&&(t.tabNode=a)}),o.saveTabConfig())},saveTabConfig:function(t){var a,o,e=this,r=e.get("caller"),s=r.get("form");a=r.tabNode.attr("data-searchtype"),o=r.userConfig||{},o.mods=r.get("mods"),o.tab=a,o.action=s.attr("action"),o.defaultpage=s.attr("data-defaultpage"),e.tabConfig||(e.tabConfig={}),e.tabConfig[a]=KISSY.clone(o),t&&t.sugConfig&&t.sugConfig.sourceUrl&&e.tabConfig[a].sugConfig&&(e.tabConfig[a].sugConfig.sourceUrl=t.sugConfig.sourceUrl,e.tabConfig[a].tab=a)},update:function(t){var a,o,r,i=this,c=i.get("caller"),n=c.comboBox,l=t.tab,g=c.configArr[l],u=t.sugConfig,f=n.get("input"),b=e.parent(f,"form");c.configArr=c.configArr||[],o=c.get("dataSourceCfg"),r=o.xhrCfg,r.url=u.sourceUrl,c.__attrVals.mods.sort=t.mods.sort,g||(g=c.configArr[l]=""===r.url?{data:new s.LocalDataSource({data:{},parse:o.parse})}:{data:new s.RemoteDataSource(o)}),a=g.data,n.set("maxItemCount",r.url?10:0),n.set("dataSource",g.data),b&&e.attr(b,"action",t.action),f[0].focus();var d=f.val();d&&n.sendRequest(d)},getDefCfg:function(t){var a;switch(t){case"shop":a={sugConfig:{sourceUrl:location.protocol+"//suggest.taobao.com/sug?area=ssrch&k=1",resultFormat:"",tab:"shop",excludeParam:["q"]},mods:{sort:["history","list"],showExtra:!1},action:location.protocol+"//shopsearch.taobao.com/search",tab:"shop"};break;case"item":a={sugConfig:{sourceUrl:location.protocol+"//suggest.taobao.com/sug?area=c2c&k=1",resultFormat:"",tab:"item",excludeParam:["q"]},mods:{sort:["history","cat","global","list","shop"]},tab:"item",action:location.protocol+"//s.taobao.com/search"};break;case"mall":a={sugConfig:{sourceUrl:location.protocol+"//suggest.taobao.com/sug?area=b2c&k=1",resultFormat:"",tab:"mall",excludeParam:["q"]},mods:{sort:["history","cat","global","list"]},tab:"mall",action:location.protocol+"//list.tmall.com/search_product.htm"};break;default:KISSY.isObject(t)?(a=t,a.sugConfig||(a.sugConfig={})):KISSY.isString(t)&&(a={sugConfig:{sourceUrl:location.protocol+"//suggest.taobao.com/sug?area=c2c&k=1",resultFormat:"",tab:t,excludeParam:["q"]},mods:{sort:["history","list"]},action:null})}return a.sugConfig&&!a.sugConfig.tab&&(a.sugConfig.tab=a.sugConfig.sourceUrl),a}},{ATTRS:{pluginId:{value:"tab"},caller:{value:null}}}),i},{requires:["node","base","dom","event","combobox"]});