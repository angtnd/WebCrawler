define(["jquery","swfobject","OK/logger","okVideoPlayerUtils"],function(g,c,D,y){var r=null;var z=null;var q={};g(window).on("onMusicPlaying",function(){if(q.isExternalPlayer){w();}else{C("pause");}});function m(K,H,E,F){var J=g("#"+K),G=g("<div/>",{"class":"vp_video_stub_w"}),I=g("<div/>",{"class":"vp_video_stub __na"}).appendTo(G);g("<div/>",{"class":"vp_video_stub_txt",html:(H||"")}).appendTo(I);if(F){J.replaceWith(G);J=G;}else{J.append(G);}if(E){g("<img/>",{width:"100%",src:E,"class":"vp-video_stub_i"}).insertBefore(G);}return J;}function B(E){for(var F in E){if(E.hasOwnProperty(F)){if(typeof E[F]!=="string"){E[F]=encodeURIComponent(JSON.stringify(E[F]));}}}return E;}function a(E){E.isExternalPlayer&&g.ajax({url:"/dk?cmd=videoStatNew",contentType:"application/json",type:"POST",data:JSON.stringify({duration:0,contentId:E.url,location:E.flashvars.location,providerId:E.provider,batch:[{name:"started"}]})}).error(function(){D.error("OKVideoStart","failOG");});}function j(E){return g.ajax({url:decodeURIComponent(E),dataType:"json",type:"GET",headers:{TKN:OK.tkn.get()}});}function s(F,E){return g.ajax({url:"/dk?cmd=videoCommand&a=getVideoPlayerAttributes&st.vv_movieId="+F+"&st.location="+E,dataType:"json",type:"GET",headers:{TKN:OK.tkn.get()}});}function e(G){var H=G.flashvars.metadata.liveStreamInfo;if(!H){return true;}var I=parseInt(H.startTime,10),E=parseInt(H.endTime,10),F=Date.now()+G.timeshift;return !!((!E||F<=E)&&(!I||F>I));}function k(F,E){require(["okHtml5Player"],function(G){G.embedPlayer(E,E,F.flashvars);});}function h(H,G){if(c.getObjectById(G)){return;}var I=c.hasFlashPlayerVersion(H.minFlashVersionNewPlayer||"11.2.0")&&H.url11?H.url11:H.url;var F={id:G,name:G};var J={allowScriptAccess:H.asa?"always":"never",wmode:H.wmode||"opaque",allowFullScreen:true,menu:false,bgcolor:"#000000"};var E=B(g.extend({},H.flashvars,{autoplay:true,wmode:J.wmode,stageVideo:J.wmode=="direct"||J.wmode=="gpu",playerId:H.playerId}));c.embedSWF(I,G,"100%","100%","10.0.0",null,E,J,F);a(H);}function u(F,E){var G=document.createElement("iframe");G.id=E;G.width="100%";G.height="100%";G.tabIndex="999";G.frameBorder="no";G.scrolling="no";G.allowFullscreen=true;G.src=F.url;var H=document.getElementById(E);H.parentNode.replaceChild(G,H);a(F);}function p(R,J,H){var P=R.flashvars.metadata.liveStreamInfo,I=Date.now()+R.timeshift,G=parseInt(P.startTime,10),L=parseInt(P.endTime,10),Q=g("#"+J);function M(X,W){var V=~~((X-W)/1000),U=~~(V/3600),S=~~(V/60)%60,T=V%60;return(U<10?"0"+U:U)+":"+(S<10?"0"+S:S)+":"+(T<10?"0"+T:T);}var F=g("<div/>",{id:H,"class":"vp_broadcast-stub_w"}),K=g("<div/>",{"class":"vp_video_stub_w"}).appendTo(F),N=g("<div/>",{"class":"vp_broadcast-stub"}).appendTo(K);g("<img/>",{width:"100%",src:R.poster,"class":"vp-video_stub_i"}).appendTo(F);g("<div/>",{"class":"vp_broadcast-stub_tx",html:L&&L<I?R.liveEndedText:R.liveUnstartedText}).appendTo(N);g("#"+H).replaceWith(F);if(G>I){var E=g("<div/>",{"class":"vp_broadcast-stub_time js-live-time",text:M(G,I)}).appendTo(N);var O=setInterval(function(){I=Date.now()+R.timeshift;if(G<I){clearInterval(O);v(R,J,H);return;}E.text(M(G,I));},1000);Q.data("startTimer",O.toString());}}function v(T,I,G){if(typeof T.flashvars.metadata==="string"){T.flashvars.metadata=JSON.parse(T.flashvars.metadata);}if(typeof T.flashvars.translations==="string"){T.flashvars.translations=JSON.parse(T.flashvars.translations);}var N=y.dash,P=y.mp4,L=c.getFlashPlayerVersion().major>=10,F=!!(T.flashvars.metadata&&T.flashvars.metadata.metadataEmbedded),Q=T.flashvars.metadata.liveStreamInfo,S=g("#"+I),O=g("#"+G);function K(){try{u(T,G);}catch(U){m(I,null,null,true);}}function R(){if(P){k(T,G);}else{m(I,T.noFlashText,T.noFlashImage,true);}}function H(){if(!L){m(I,T.noFlashText,T.noFlashImage,true);}else{y.checkFlashStatus(function(U){if(U===y.FLASH_BLOCKED){m(I,T.noFlashText,T.noFlashImage,true);}else{h(T,G);}});}}function J(){if(N){k(T,G);}else{if(!L){R();}else{y.checkFlashStatus(function(U){if(U===y.FLASH_BLOCKED){R();}else{h(T,G);}});}}}function M(){if(T.isIframePlayer){K();}else{if(T.isExternalPlayer||!T.isHtml5Player){H();}else{if(F){J();}else{if(P){k(T,G);}else{H();}}}}}function E(){var V=parseInt(Q.endTime,10),X=Date.now()+T.timeshift;if(V&&X<V){var W=~~((parseInt(Q.endTime,10)-X)/1000);var U=setTimeout(function(){v(T,I,G);},W*1000+3000);S.data("endTimer",U.toString());}}w();if(T.isExternalPlayer&&window.__getMusicFlash){window.__getMusicFlash().lcPause();}r=G;z=I;q=T;if(!O.length){S.hide();g("<div>",{id:G}).insertAfter(S);}if(e(T)){Q&&E();M();}else{p(T,I,G);}}function l(E){return E+"C";}function x(E){return E+"E";}function f(E,G,F){G=G||l(E.playerId);F=F||x(E.playerId);if(!E.timeshift){E.timeshift=E.timestamp?parseInt(E.timestamp,10)-Date.now():0;}if(!E.flashvars.metadata&&E.flashvars.metadataUrl){j(E.flashvars.metadataUrl).done(function(H){E.flashvars.metadata=H;delete E.flashvars.metadataUrl;v(E,G,F);}).error(function(){m(G,null,null,true);});}else{v(E,G,F);}}function w(){if(r&&z){g("#"+r).remove();g("#"+z).show();r=null;z=null;q={};}}function t(){return r?document.getElementById(r):null;}function A(){return r;}function i(){return z;}function o(){return q;}function C(F){var E=t();if(E&&E.call){E.call(F);}}function n(G,H,I,E,F){s(G,F).always(function(J){J=J||{flashvars:{}};J.playerId=H||J.playerId||null;J.width=I||J.width||null;J.height=E||J.height||null;if(J.error||!J.url){var K=m(l(J.playerId),J.error).css("display","block");J.width&&K.width(J.width);J.height&&K.height(J.height);}else{f(J);}});}function d(K){var Q=g(K),G=Q.data("playerContainerId"),F=Q.data("playerElementId"),S=Q.data("options"),R=Q.data("autostart"),P=Q.data("viewportTimeout"),M=Q.data("viewportDisabledIfMusic"),E=Q.data("hoverTimeout"),I=Q.data("hoverDisabledIfMusic"),J=Q.data("isBannerVideo");S.timeshift=S.timestamp?parseInt(S.timestamp,10)-Date.now():0;if(J){var L,N=Q.closest(".js-banner-wrapper-pointer");if(N.length){L=g("#"+N.data("bannerWrapperId"));}else{L=Q.closest(".js-banner-wrapper");}if(L.length){var O=L.children(".adv-px");if(O.length){var H={};O.each(function(){var U=g(this),T=U.data("type"),V=U.data("src");if(typeof H[T]==="undefined"){H[T]=[];}H[T].push(V);});S.flashvars.pixels=H;}}}if(!Q.find("#"+G).length){g("<div>",{id:G,"class":"vid-card_cnt_w"}).css({width:"100%",height:"100%"}).append(g("<i>",{"class":"vid_play"})).appendTo(Q);}Q.find("#"+G).on("click",function(T){T.preventDefault();f(g.extend(true,{},S),G,F);});if(R){f(g.extend(true,{},S),G,F);}if(P){require(["OK/VideoAutoplayFlow"],function(T){T.activateViewportPlayer(g.extend(true,{},S),G,F,P,M);});}if(E){require(["OK/VideoAutoplayFlow"],function(T){T.activateHoverPlayer(g.extend(true,{},S),G,F,E,I);});}}function b(G){var F=g(G),K=F.data("playerContainerId"),J=F.data("viewportTimeout"),H=F.data("hoverTimeout"),L=g("#"+K),I=parseInt(L.data("startTimer"),10),E=parseInt(L.data("endTimer"),10);if(J||H){require(["OK/VideoAutoplayFlow"],function(M){M.deactivateHoverPlayer(K);M.deactivateViewportPlayer(K);});}if(I||E){clearInterval(I);clearTimeout(E);}}return{activate:d,deactivate:b,createPlayer:n,start:f,stop:w,getPlayer:t,getPlayerId:A,getContainerId:i,getOptions:o,callPlayer:C,createPlayerContainerId:l,createPlayerElementId:x};});