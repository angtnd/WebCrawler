define(["OK/utils/utils","OK/capture"],function(b,c){function a(m,j,n){function i(){this.hookElement.classList.remove("in-progress");this.loading=false;}var l=this.list,k=l.lastChild;if(n.getResponseHeader("fetchedAll")==="true"){this.deactivate();}this.lastElement=n.getResponseHeader("lastelem");if(m===null||m.length===0){i.call(this);return;}l.insertAdjacentHTML("beforeend",m);var h=k.nextSibling;while(h!==null){c.activate(h);h=h.nextSibling;}this.page=this.page+1;this.autoPage=this.autoPage+1;if(this.isManual){if(!this.isDeactivated){this.hookElement.classList.remove("loader-container");}this.switchToAuto();}else{this.switchToManual();}i.call(this);}function e(){if(window.pageYOffset!==undefined){return window.pageYOffset;}return document.documentElement.scrollTop;}function d(){var h=document.body,i=document.documentElement;return Math.max(h.scrollHeight,h.offsetHeight,i.clientHeight,i.scrollHeight,i.offsetHeight);}var g=function(){this.loading=false;};function f(h){return e()>d()-document.documentElement.clientHeight-h;}g.prototype={handleEvent:function(h){switch(h.type){case"click":if(!this.loading){this.hookElement.classList.add("in-progress");this.hookElement.classList.add("loader-container");this.loadMore();}h.preventDefault();break;case"scroll":if(!this.loading&&f(this.forceBottomEdge)){this.hookElement.classList.add("in-progress");this.loadMore();}break;}},activate:function(h){this.hookElement=h;this.list=this.hookElement.firstChild;this.showMoreButton=this.hookElement.getElementsByClassName("link-show-more")[0];this.url=this.hookElement.getAttribute("data-url");this.dynamic=this.hookElement.getAttribute("data-dynamic");this.forceBottomEdge=this.hookElement.getAttribute("data-forcedbottomedge")||100;this.dataMax=this.hookElement.getAttribute("data-max")||0;this.manualPagesCount=this.hookElement.getAttribute("data-manualpagescount")||0;this.dynamicParams=this.dynamic?this.dynamic.split(","):[];this.lastElement=this.hookElement.getAttribute("data-last-element");this.page=2;this.autoPage=this.page;this.isManual=false;this.isDeactivated=false;this.switchToManual();if(!this.isManual){window.addEventListener("scroll",this,false);}},deactivate:function(){window.removeEventListener("scroll",this,false);this.showMoreButton.removeEventListener("click",this,false);this.hookElement.classList.add("loader-container");this.isDeactivated=true;},switchToManual:function(){function h(){return this.page>this.autoPage&&this.autoPage>this.manualPagesCount;}function i(){return this.page==this.autoPage&&this.page>this.dataMax;}if(!this.isManual&&!this.isDeactivated){if(i.call(this)||h.call(this)){this.hookElement.classList.remove("loader-container");window.removeEventListener("scroll",this,false);this.showMoreButton.addEventListener("click",this,false);this.isManual=true;}}},switchToAuto:function(){if(this.manualPagesCount>1&&this.isManual&&!this.isDeactivated){this.hookElement.classList.add("loader-container");window.addEventListener("scroll",this,false);this.showMoreButton.removeEventListener("click",this,false);this.isManual=false;this.autoPage=1;}},loadMore:function(){this.loading=true;var l={"st.page":this.page,fetch:false},k=this.list.lastChild,i=this.url,m=this.dynamicParams,n=this.lastElement,h,j;if(m.length){for(h=0;h<m.length;h+=1){j=m[h];l[j]=k.getAttribute(j);}}if(n){l["st.lastelem"]=n;}b.ajax({type:"GET",url:i,data:l}).done(a.bind(this));}};return g;});