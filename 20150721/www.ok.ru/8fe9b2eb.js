define(["jquery","OK/logger"],function(ao,P){var am,U=null,S=null,ai="mtLayer",J="mtLayerMain",aa="mtLayerBack",av="mtLayerForward",c="scrollToTopMtLayer",ag="media-layer media-layer__topic grid",i="media-layer_hld",ah="mlr_disc",Y="media-layer_close",aq="media-layer_close_ico",d="sticky-plank_cnt",R="media-layer_fixer",ac=310,h=null,D=null,v=null,n=null,b=null,u=null,ax=null,m=null,ar=null,K=1145,B={id:null,to:75},I="MediaTopicLayerBody",k="layer__disabled",s="invisible",f=false,ap,N,a=false;function y(aB,az){var aA=document.getElementById(aB),t;if(!aA){return false;}for(t=0;t<az.length;t+=1){if(aA.classList.contains(az[t])){return false;}}return true;}function V(){return am.isActive&&!ao("#hook_Block_PopLayerMediaTopic").hasClass(k);}function r(){return am.isActive&&ao("#hook_Block_PopLayerMediaTopic").hasClass(k);}function w(t){if(V()){if(!a&&h[0]!==document.activeElement&&h.find(document.activeElement).length===0){h.focus();a=true;}if(h.find(".__edit").length>0){return;}if(h.find(".tag-box__editable").length>0){return;}if(y("hook_Modal_popLayerModal",[k])){return;}if(y("photoLayerWrapper",[k,s])){return;}if(y("video-poplayer-cnt",[k,s])){return;}if(t.keyCode===39&&m){m.click();OK.stop(t);}else{if(t.keyCode===37&&ax){ax.click();OK.stop(t);}}}}function x(t){if(t){OK.Layers.register(ai,function(){M("cr_esc");},undefined,false,w);}else{OK.Layers.remove(ai);}}function W(t,az){OK.loader.use("OKCustomJs",function(){if(t){x(az);}if(az){if(OK.Layers.onLayerShown){OK.Layers.onLayerShown();}}else{if(OK.Layers.onLayerHidden){OK.Layers.onLayerHidden();}}});}function G(){S.toggleClass("__layer",!!am.isActive);}function au(){var t=ag;if(am.isActive){t+=" __active";}if(am.isProcess){t+=" __process";}if(am.redesign){t+=" __redesign";}h.attr("class",t);}function ak(){W(true,am.isActive);G();au();}function C(az){var t=am.isActive!==az;am.isActive=az;if(t){ak();}else{if(r()){W(false,true);}}document.getElementById("hook_Block_PopLayerMediaTopic").classList.remove(k);}function ae(t){var az=am.isProcess!==t;am.isProcess=t;if(az){au();}}function p(t){D.toggleClass("__process",t);}function E(aA,t){var aB=aA.length,az=aB;while(--aB+1){aA[aB].toggleClass(t);}setTimeout(function(){while(--az+1){aA[az].toggleClass(t);}},1);}function z(){if(n){var t=0;ao(".comments_i",n).each(function(){var az=ao(this).data("unread");if(az){t=this.getBoundingClientRect().top;}return !az;});h.each(function(){this.scrollTop=(t!==0)?this.scrollTop+t:this.scrollHeight;});setTimeout(function(){ao(".js-comments_add",n).focus();},50);}}function o(aD,aA,aC){var az=ao(window),t=az.height(),aB=az.width();if(B.id){clearTimeout(B.id);}B.id=setTimeout(function(){E([u,m,ax,ar],R);B.id=null;j();},aD?0:B.to);h.toggleClass("__compact",aB<=K);h.toggleClass("__min-height",(t<ac));if(aA){z();}if(aC){ad(aC);}j();}var O;function j(t,az){if(am.redesign){return;}az=az||20;if(az>0){if(b&&v){O&&clearTimeout(O);O=setTimeout(function(){var aA=v.outerWidth();b.css({width:aA});b.parent().css({width:aA});t!==aA&&j(aA,--az);},50);}else{!v&&(v=h.find("."+i));b=v.find("."+d);j(undefined,--az);}}}function q(t){if(f){return;}f=true;U=ao(window);S=ao(document.body);h=ao("#"+ai);D=ao("#"+J);ax=ao("#"+aa);m=ao("#"+av);ar=ao("#"+c);am={isActive:h.hasClass("__active"),isProcess:h.hasClass("__process")};v=h.find("."+i);u=v.find("."+Y);u.click(function(aB){var aA="cr_shadow",az=OK.eventTarget(aB);if(ao(az).hasClass(aq)){aA="cr_close";}M(aA);});if(am.isActive){ak();if(!am.isProcess){o(true,t);}}if(t){z();}U.on("resize.mtLayer",function(){o();});}var e;var T;var aw;function Q(az,t){if(t==null||t.length==0){return;}OK.historyManager.putItemToCache(az,t);}function an(az){if(OK.historyManager.isHistorySupported()){var aA=az.indexOf("?");if(aA>0){aw=az.substr(aA+1);T=az.substr(0,aA);if(aw.length>0){aw+="&mt.scrollTop="+ao(window).scrollTop();}else{aw=null;}Q(T,aw);}else{T=az;aw=null;}var aB=H()==T&&!N;var t;if(!e){if(aB){t=true;}else{if(N){at(N,true);}}e=H();}else{t=!am.closeTopicId;}N="";if(!aB){at(T,t);}}}function F(){if(!e&&T==H()){at(e,true);}e=null;T=null;aw=null;}function H(){return OK.historyManager.getState();}function at(az,t){if(t){OK.historyManager.replaceState(az);}else{OK.historyManager.pushState(az);}}function M(aC){a=false;am.topicId=null;am.owner=null;var aB=am.closeTopicId,t=am.closeOwnerType;am.closeTopicId=null;am.closeOwnerType=null;if(aB&&(aC==="cr_esc"||aC==="cr_shadow"||aC==="cr_close"||aC==="cr_fail")){if(aC){Z(aC+"_ct");}setTimeout(function(){if(OK.historyManager.isHistorySupported()){OK.historyManager.back();}else{al(aB,t,"");}},0);return;}var aA=V();var az=false;if(aA){if(e&&T==H()){if(e==T){az=true;OK.historyManager.back();}else{at(e,true);}}}if(!az){C(false);ae(false);p(false);l();af();ar.removeClass("__active __animated");OK.hookModel.setHookContent(I,"");}e=null;if(aC){Z(aC);}h.trigger("mtLayer.close");}function Z(t){P.success("mtlayer",ap||"",t);}function l(){ax.removeClass("__active");m.removeClass("__active");}function L(t,az){if(ax){ax.toggleClass("__active",!!t&&!!az);ax.unbind("click.back").bind("click.back",function(aB){if(ax.hasClass("__active")){var aA=m.hasClass("__active");al(t,az,"MT_GoBack_"+az,false,"","BACK",aA);}OK.stop(aB);});}}function g(t,az){if(m){m.toggleClass("__active",!!t&&!!az);m.unbind("click.forward").bind("click.forward",function(aB){if(m.hasClass("__active")){var aA=ax.hasClass("__active");al(t,az,"MT_GoForward_"+az,false,"","FORWARD",aA);}OK.stop(aB);});}}function ad(aA){if(aA){var aB=h.find("[data-scroll-to='"+aA+"']");if(aB.length>0){var aF=aB[0],aE=aF.offsetTop,t=aF.offsetParent;while(t&&t.nodeType===1&&t!==h[0]){aE+=t.offsetTop;t=t.offsetParent;}var aD=h,aC=aD.height(),az=aD.scrollTop(),aG=aC;if(az+aC<=aE+aG){aD.scrollTop(aE+aG-aC-5);}else{if(az>aE){aD.scrollTop(aE-5);}}}}}function af(){var t=S;var az=t.find(".gwt-shortcutMenu__show");if(az.length){az.removeClass("gwt-shortcutMenu__show");}var aA=t.find(".sc-menu:not(.sc-menu__hidden,.poll_ans_cnt)");if(aA.length){aA=aA.not("#ownProfileLSMnu");aA.addClass("sc-menu__hidden");}}var ay=[0,1,2,3,5,8,13,21,34,55,89,144,233,377,610];function aj(az,aB){var aA=(aB-az)/100;var t;for(t=1;t<ay.length;t++){if(aA<ay[t]){break;}}return ay[t-1]+"00";}function X(){if(h){h.scrollTop(0);}}function ab(t){if(am.isProcess){ae(false);}else{p(false);}t&&t();}function A(aB,aI,aE,aL,aM){N=aI;q(aE);var az=ao("#"+I);var aH=az.attr("data-log");if(aH){Z(aH);}var aA=az.attr("data-url");if(aA){an(aA);}else{F();}if(am.closeTopicId||aL){}else{var aD=az.attr("data-back-id");L(aD,aB);var aC=az.attr("data-forward-id");g(aC,aB);}var aK=az.attr("data-id");if(aK){am.topicId=aK;am.owner=aB;}var t=az.attr("data-log-click");if(t){h.attr("data-log-click",t);}else{h.removeAttr("data-log-click");}var aG=!!az.attr("data-redesign");var aJ=am.redesign;am.redesign=aG;if(aJ!==aG&&!am.isProcess){au();}ab(aM);E([m,ax,ar],R);X();n=v.find("."+ah);b=v.find("."+d);var aF=az.attr("data-scroll-to-marker");o(true,aE,aF);}function al(aH,aA,az,aC,aG,aK,aM,aL,aJ,aF,aI){var aE=+new Date();var aB;q(aC);if(!aK){am.closeTopicId=null;am.closeOwnerType=null;}if(az&&az.indexOf("st.mt.or=on")!==-1){aJ=am.topicId;aF=am.owner;}if(OK.photoLayer){OK.photoLayer.close();}OK.VideoPlayer.pauseAll();OK.loader.use("OKCustomJs",function(){var aO=OK.Layers.stack;var aP=aO&&aO.length>0&&aO[aO.length-1].id===ai;if(!aP&&am.isActive){x(true);}});function aN(aQ){var aP=Date.now();var aO="";if(aQ){aO+="r_";}if(aK){aO+="dt";}else{aO+="ot";}Z(aO+aj(aE,aP));if(aB){Z("js_"+aO+aj(aB,aP));}}ap=aA;N=aG;if(N){Z("shortlink");}l();if(am.isActive&&!am.isProcess){p(true);af();}else{ae(true);}C(true);var t;if(OK.getCurrentStateLink){t=OK.getCurrentStateLink();}else{t="/dk?"+window.pageCtx.state.replace("&amp;","&");}t+=t.indexOf("?")===-1?"?":"&";t=t.replace(/st\.mt\.(id|ot|bi|dir|hn).*?(&|$)/g,"");t+="cmd="+I+"&st._aid="+az;var aD=ao.ajax({type:"POST",url:t,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":aH,"st.mt.ot":aA,"st.mt.dir":aK,"st.mt.wc":aL?"on":"off","st.mt.hn":aI?"on":"off"},headers:{TKN:OK.tkn.get()}});aD.done(function(aQ,aO,aW){aB=Date.now();if(aJ){am.closeTopicId=aJ;am.closeOwnerType=aF;}var aT=aW.getResponseHeader("Redirect-Location");if(aT){var aU=function(aX){if(OK.navigation.redirect){OK.navigation.redirect(aT);}if(aX===0||OK.navigation.redirect){M();aN();}else{setTimeout(function(){aU(aX-1);},200);}};aU(5);}else{var aR=aW.getResponseHeader("End-Reached");if(aR==="yes"){if(aK==="FORWARD"){if(aM){ax.toggleClass("__active",true);}}else{if(aK=="BACK"){if(aM){m.toggleClass("__active",true);}}}ab(aN);return;}var aS=aQ.split(OK.navigation.SPLITER),aV=aW.getResponseHeader(OK.navigation.HEADER).split(",");for(var aP=0;aP<aS.length;aP++){if(aV[aP]){OK.hookModel.setHookContent(aV[aP],aS[aP]);}}A(aA,N,aC,aI,aN);}});aD.fail(function(){M("cr_fail");aN();});return aD;}return{show:function(){q();C(true);X();},showPreloaded:A,showTopicInLayer:al,closeLayer:function(){if(f){M();}},hideLayer:function(){a=false;if(am&&am.isActive){if(e&&H()==T){at(e,true);}W(false,false);}},restoreLayer:function(){if(am&&am.isActive){E([u,m,ax,ar],R);if(e&&H()!==T){at(T,true);}W(false,true);}},refreshLayerBody:function(aB){function t(){if(aB){aB();}}if(!am||!am.topicId||!am.owner){t();return;}var az="/";if(OK.getCurrentStateLink){az=OK.getCurrentStateLink();}az+=az.indexOf("?")===-1?"?":"&";az+="cmd="+I+"&st._aid=PLPhotoUserBackToView";var aA=ao.ajax({type:"POST",url:az,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":am.topicId,"st.mt.ot":am.owner},headers:{TKN:OK.tkn.get()}});aA.done(function(aG,aI,aH){var aD=aH.getResponseHeader("Redirect-Location");if(aD){if(OK.navigation.redirect){OK.navigation.redirect(aD);}M();}else{var aC=aG.split(OK.navigation.SPLITER),aF=aH.getResponseHeader(OK.navigation.HEADER).split(",");for(var aE=0;aE<aC.length;aE++){if(aF[aE]){OK.hookModel.setHookContent(aF[aE],aC[aE]);}}}t();});aA.fail(t);},deactivate:function(){ao(window).off(".mtLayer");C(false);}};});