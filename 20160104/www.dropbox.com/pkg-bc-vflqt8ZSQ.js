define("modules/clean/unity/features/destiny_logger",["jquery","modules/core/uri","modules/clean/ajax","modules/clean/gandalf_util","modules/clean/unity/versions"],function(e,n,t,i,r){var _;return _={report_event:function(e,_){var o;return null==_&&(_=null),o={event_name:e,extra:JSON.stringify(_||{}),local_ts:(new Date).getTime(),server_path:window.location.pathname,session_id:Constants.sess_id,web_unity_version:r.LATEST},t.WebRequest({url:n({path:"/destiny_log"}),data:o}),i.getGandalfRule("destiny-web-debug")?console.log(o):void 0}}});var bind=function(e,n){return function(){return e.apply(n,arguments)}};define("modules/clean/unity/features/web_destiny",["external/modernizr","jquery","modules/clean/ajax","modules/clean/unity/features","modules/clean/unity/features/destiny_logger","modules/core/browser","modules/core/exception","modules/core/uri"],function(e,n,t,i,r,_,o,s){var u;if(null!=i)return u=function(){function u(){this._assert_is_initialized=bind(this._assert_is_initialized,this),this._direct_web_destiny=bind(this._direct_web_destiny,this),this.is_direct_allowed=bind(this.is_direct_allowed,this),this.user_display_name=bind(this.user_display_name,this),this.continue_as_user=bind(this.continue_as_user,this),this._cached_web_destiny_info=null}return u.Error={UNITY_CONNECTION_ERROR:"unity_connection_error",REFRESH_TIMEOUT:"refresh_timeout",LOGIN_REQUEST_ERROR:"login_request_error"},u._DESTINY_REFRESH_TOKEN_KEY="web-destiny-refresh-token",u._DESTINY_MANUAL_REFRESH_TIMEOUT=5e3,u._DESTINY_REFRESH_TIMEOUT=1e4,u.finish_indirect_web_destiny=function(t){var i;return r.report_event("web_destiny_opened_new_tab"),n(window).on("beforeunload",function(){return r.report_event("web_destiny_new_tab_redirecting")}),e.localstorage?(localStorage.setItem(this._DESTINY_REFRESH_TOKEN_KEY,t),i=localStorage.getItem("web-destiny-redirect-uri"),localStorage.removeItem("web-destiny-redirect-uri"),_.redirect(i?i:"/")):_.redirect("/")},u.prototype.start_connection=function(e,n){return null==n&&(n=null),null==this._cached_web_destiny_info?i.web_destiny_info(function(n){return function(t){return null!=t?(n._cached_web_destiny_info=t,e(t.user_display_name)):void 0}}(this),n):void 0},u.prototype.continue_as_user=function(e,n){var t,i;return null==e&&(e=null),null==n&&(n=null),this._assert_is_initialized(),t=function(){return null!=e?_.redirect(e):window.location.reload()},i=function(e){return null!=n?n(e):void 0},this._cached_web_destiny_info.is_direct_allowed?this._direct_web_destiny(t,i):this._indirect_web_destiny(t,i)},u.prototype.user_display_name=function(){return this._assert_is_initialized(),this._cached_web_destiny_info.user_display_name},u.prototype.is_direct_allowed=function(){return this._assert_is_initialized(),this._cached_web_destiny_info.is_direct_allowed},u.prototype._indirect_web_destiny=function(n,t){var r,o,s,d;return d=null,s=null,e.localstorage&&(d=(new Date).getTime().toString(),o=function(e){return e.key===u._DESTINY_REFRESH_TOKEN_KEY&&e.newValue===d?(window.clearTimeout(s),n()):void 0},null!=window.addEventListener?window.addEventListener("storage",o,!1):window.attachEvent("onstorage",o)),r=function(){return s=e.localstorage?window.setTimeout(function(){return t(u.Error.REFRESH_TIMEOUT)},u._DESTINY_REFRESH_TIMEOUT):window.setTimeout(n,u._DESTINY_MANUAL_REFRESH_TIMEOUT)},i.continue_as_user(_.browser_name,d,r,function(){return t(u.Error.UNITY_CONNECTION_ERROR)})},u.prototype._direct_web_destiny=function(e,n){var r;return o.assert(this._cached_web_destiny_info.is_direct_allowed,"Direct Web Destiny is not allowed."),r=function(i){var r,_,o;return r={i:function(){var e;e=[];for(_ in i)o=i[_],e.push(_);return e}(),n:function(){var e;e=[];for(_ in i)o=i[_],e.push(o);return e}(),return_json:!0},t.WebRequest({url:s({path:"/desktop_login"}),data:r,success:e,error:function(){return n(u.Error.LOGIN_REQUEST_ERROR)}})},i.continue_as_user_direct(r,function(){return n(u.Error.UNITY_CONNECTION_ERROR)})},u.prototype._assert_is_initialized=function(){return o.assert(null!=this._cached_web_destiny_info,"Method not allowed. WebDestiny was not initialized.")},u}()});