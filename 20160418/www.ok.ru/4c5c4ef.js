define(["jquery","OK/logger","OK/utils/utils"],function(e,y,u){var q=e("body"),b="ShortcutMenu",x=e("<div>").attr("id","hook_Block_"+b).appendTo(q),g=e(document),o=e(window),d="ontouchstart" in document.documentElement;OK.hookModel.captureBlockHook("body",b,x[0]);var i=function(A){this.hookId=A;this.stopClick=true;this.ajaxProcessing=false;this.ajaxTimeout=0;this.showTimeout=null;this.hideTimeout=null;this.menuElement=null;this.cacheable=true;this.loaded=false;this.showOnClick=true;this.listenersPostfix=".shortcut";};i.prototype={activate:function(B){var C=e(B);this.hookElem=C;this.blockId=C.attr("data-blockid");this.block=C.find("#hook_Block_"+this.blockId);this.inplace=C.attr("data-inplace");this.loaded=C.attr("data-loaded");this.holder=C.prev();this.showDelay=parseInt(C.attr("data-show"),10)||300;this.hideDelay=parseInt(C.attr("data-hide"),10)||100;this.cacheable=!C.attr("data-nocache");this.saveChanges=C.attr("data-save-changes");this.direction=C.attr("data-direction");this.position=C.attr("data-position")||"center";this.showOnClick=C.attr("data-onClick");this.showImmediately=C.attr("data-showImmediately");this.listenersPostfix=".shortcut"+Date.now();if(d){var A=this.holder.find("a").first()[0];if(A){A.addEventListener("click",this,true);this.link=A;}this.holder.on("touchstart"+this.listenersPostfix,p);}this.holder.on("mouseleave"+this.listenersPostfix,f.bind(this));if(this.showOnClick){this.holder.one("click"+this.listenersPostfix,w.bind(this));}else{this.holder.on("mouseenter"+this.listenersPostfix,j.bind(this));}if(this.inplace){if(this.block.length){v(this,this.block);}}else{v(this,x);}if(this.showImmediately){setTimeout(w.bind(this),1);}},deactivate:function(){if(this.menuElement){k.apply(this);}if(d&&this.link){this.link.removeEventListener("click",this,true);}g.off(this.listenersPostfix);t(this).off(this.listenersPostfix);this.holder.off(this.listenersPostfix);this.ajaxTimeout=true;this.hookElem=null;},handleEvent:function(A){if(this.stopClick){A.preventDefault();A.stopPropagation();this.stopClick=false;this.holder.trigger("mouseenter");return false;}}};return i;function v(A,B){B.on("click"+A.listenersPostfix,".sc-menu:not(.js-doNotHide) a",n.bind(A));B.on("click"+A.listenersPostfix,".sc-menu .js-hide",n.bind(A));B.on("mouseenter"+A.listenersPostfix,".sc-menu",c.bind(A)).on("mouseleave"+A.listenersPostfix,".sc-menu",f.bind(A)).on("touchstart"+A.listenersPostfix,".sc-menu a",l);}function a(A){if(A.hookElem&&!A.block.length){var C=A.hookElem.children(".posR");if(!C.length){var B=e("<div>").attr("id","hook_Block_"+A.blockId).attr("class","posR").appendTo(A.hookElem);A.block=B;OK.hookModel.captureBlockHook(A.hookId,A.blockId,B[0]);if(A.inplace){v(A,B);}}else{A.block=C;}}}function t(A){if(A.inplace){a(A);return A.block;}return x;}function z(A){if(!A.block.length){return"";}var B=A.block.html();if(!A.inplace||!A.cacheable){OK.hookModel.setHookContent(A.blockId,"");if(A.cacheable){A.block.html(B);}}return B;}function w(){this.showTimeout=null;if(this.holder.hasClass("__vis")){return;}if(this.showOnClick){this.holder.one("click"+this.listenersPostfix,k.bind(this));}this.showTimeout=null;if(d){q.one("touchstart"+this.listenersPostfix,f.bind(this));}if(this.ajaxProcessing){return;}this.startTime=Date.now();if(this.loaded){var B=z(this);r.call(this,B);y.success("asm","show","cache");}else{this.ajaxProcessing=true;var A=this.hookElem.attr("data-url");u.ajax({type:"GET",url:A,dataType:"html"}).fail(m.bind(this)).done(s.bind(this));}}function k(){this.hideTimeout=null;this.stopClick=true;if(this.showOnClick){this.holder.one("click"+this.listenersPostfix,w.bind(this));}if(this.ajaxProcessing){this.ajaxTimeout=true;y.success("asm","ajax","to");}if(this.menuElement){this.menuElement.addClass("sc-menu__hidden");z(this);if(this.saveChanges&&!this.inplace&&this.loaded&&this.cacheable){a(this);this.block.html(x.html());}OK.hookModel.setHookContent(b,"");this.menuElement=null;}this.holder.removeClass("__vis");if(!this.inplace){x.off("change");}}function j(A){if(this.hideTimeout){this.hideTimeout=clearTimeout(this.hideTimeout);}if(!this.showTimeout){this.showTimeout=setTimeout(w.bind(this),this.showDelay);}}function f(){if(this.showTimeout){this.showTimeout=clearTimeout(this.showTimeout);}if(!this.hideTimeout){this.hideTimeout=setTimeout(k.bind(this),this.hideDelay);}}function c(A){if(this.hideTimeout){this.hideTimeout=clearTimeout(this.hideTimeout);}}function n(A){if(true===this.hideTimeout){this.hideTimeout=null;}f.apply(this);}function p(A){A.stopPropagation();}function l(A){A.preventDefault();e(this).trigger("click");}function m(){y.error("asm","ajax");this.ajaxProcessing=false;}function s(C,A,D){y.duration("asm",Date.now()-this.startTime,"ajax");this.ajaxProcessing=false;var B;if(!C||(B=C.split(OK.navigation.SPLITER)[0]).length==0){y.success("asm","ajax","e");return;}y.success("asm","show","ajax");if(this.cacheable&&this.hookElem){this.loaded=true;a(this);this.block.html(B);}if(this.ajaxTimeout){this.ajaxTimeout=false;}else{r.call(this,C,D);}}function r(D,E){var B,C=[];if(E&&(B=E.getResponseHeader(OK.navigation.HEADER))){C=B.split(",");}var A;if(this.inplace){a(this);C[0]=this.blockId;A=this.block;}else{C[0]=b;A=x;}u.updateBlocks(D,status,C);this.menuElement=A.find(".sc-menu");if(!this.inplace){x.off("change");x.on("change",h.bind(this));}h.call(this);this.menuElement.removeClass("sc-menu__hidden");this.holder.addClass("__vis");}function h(){var E=this.holder.outerHeight(true),D=this.inplace?{top:0,left:0}:this.holder.offset(),F=this.holder.outerWidth(true),C=this.menuElement.outerHeight(true),H=this.menuElement.outerWidth(true);var A;if(this.direction){A=this.direction==="top";}else{A=o.height()-((this.holder.offset().top+E)-OK.util.getDocumentScrollYPos())<C;}var G=D.top;if(A){this.menuElement.addClass("sc-menu__top");var B;if(this.inplace){B=G+E;this.menuElement.css("bottom",Math.round(B));this.menuElement.css("top","auto");}else{G-=C;this.menuElement.css("top",Math.round(G));this.menuElement.css("bottom","auto");}}else{this.menuElement.removeClass("sc-menu__top");if(!this.inplace){G+=E;}this.menuElement.css("top",Math.round(G));this.menuElement.css("bottom","auto");}switch(this.position){case"left":this.menuElement.css("left",Math.round(D.left-(H-F)));this.menuElement.addClass("__noarrow");break;case"right":this.menuElement.css("left",Math.round(D.left-F));this.menuElement.addClass("__noarrow");break;default:this.menuElement.css("left",Math.round(D.left+((F-H)/2)));break;}}});