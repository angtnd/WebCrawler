define("idcta/idCookie",["idcta/id-config","idcta/webtoolkit.base64","idcta/apiUtils"],function(h,g,b){var f={};var j=86400000;f.USER_DETAILS_COOKIE_NAME="ckns_id";f.USER_DETAILS_COOKIE_EXPIRE_TIME=7200000;f.ENCODE=true;f.DECODE=true;var a;function d(){if(a){a.refreshCookie();return a}a=new e();return a}function c(l){a=l}function i(){if(typeof(document)!="undefined"&&typeof(document.cookie)!="undefined"){var m=d();var l=1445925600000;if(m.hasCookie()&&m.timestamp!==""&&parseInt(m.timestamp)>0&&parseInt(m.timestamp)<l&&!m.isDowngraded()){m.downgrade()}}}function k(o){var m=g.decode(o);var l=m.lastIndexOf("}");var p=m.substring(0,l+1);var n=JSON.parse(p);return n}function e(){var z=this;this.valid=false;this.id="";this.username="~";this.displayname="";this.timestamp="";this.cookieAgeDays=(typeof h.identity!="undefined"&&h.identity.cookieAgeDays)?h.identity.cookieAgeDays:730;this.isIdv5On=h["bbcid-v5"]!=="RED";r();this.refreshCookie=function(){m()};this.hasCookie=function(){if(x(z.timestamp)){w()}return z.valid};this.hasAccessTokenExpired=function(){var C=this.getUserDetailsFromCookie();if(!C){return true}var B=Math.floor((new Date()).getTime()/1000);var A=C["tkn-exp"]||0;return A<=B};this.hasJwtTokenExpired=function(){var C=this.getUserDetailsFromCookie();if(!C){return true}var B=Math.floor((new Date()).getTime()/1000);var A=C["jwt-exp"]||0;return A<=B};this.isHybridApp=function(){var A=this.getUserDetailsFromCookie();return A?(A.hy||false):false};this.getError=function(){var A=this.getUserDetailsFromCookie();return A?(A.ec||null):null};this.getIdFromCookie=function(){if(x(z.timestamp)){w()}if(z.isIdv5On){var A=this.getUserDetailsFromCookie();return A?A.ps:null}else{return z.id?z.id:null}};this.getUserDetailsFromCookie=function(){if(z.isIdv5On){var B=/ckns_id=([\w]+)/;var D=document.cookie.match(B);if(D){var A=decodeURIComponent(D[1]).split("|");var C=k(A.toString());if(u(C)){return C}}return null}else{return null}};this.getNameFromCookie=function(){if(x(z.timestamp)){w()}if(z.displayname&&z.displayname!==""){return z.displayname.replace(/\+/g," ")}if(z.username&&z.username.charAt(0)!=="~"){return z.username}return null};this.getAccessToken=function(D){var A,C,B;D=(typeof D!="undefined")?D:s();if(!this.hasCookie()||D.indexOf("https")==-1){return null}A=(typeof h.identity.accessTokenCookieName!="undefined")?h.identity.accessTokenCookieName:"ckns_IDA-ATKN";B=new RegExp(A+"=([^;]*)");C=document.cookie.match(B);return(C!==null)?C[1]:null};this.isDowngraded=function(){var A=document.cookie.match(/ckpf_ID_DOWNGRADED=1/);if(A){return true}return false};this.hasIplayerUplift=function(){return document.cookie.match(/ckpf_tviplayer_uplift=([^;]*)/)};this.downgrade=function(){var C="ckpf_ID_DOWNGRADED=1;";var B=Date.now()+(z.cookieAgeDays*j);var A=new Date(B-(Date.now()-z.timestamp));document.cookie=C+" Expires="+A.toUTCString()+"; Domain=.bbc.co.uk; Path=/";if(z.hasIplayerUplift()){document.cookie="ckpf_tviplayer_uplift=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Domain=.bbc.co.uk; Path=/iplayer"}document.cookie="ckns_IDA-RTKN=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Domain=.bbc.co.uk; Path=/; secure";document.cookie="ckns_IDA-IDTKN=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Domain=.bbc.co.uk; Path=/; secure";document.cookie="ckns_IDA-ATKN=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Domain=.bbc.co.uk; Path=/; secure";document.cookie="ckns_authToken=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Domain=.bbc.co.uk; Path=/; secure"};this.setDualMode=function(){var D="ckns_dual=1;";var A=Date.now()+(j*30);var C=parseInt(z.timestamp)+(z.cookieAgeDays*j);var B=new Date(Math.min(A,C));document.cookie=D+" Expires="+B.toUTCString()+"; Domain=.bbc.co.uk; Path=/"};this.isDualMode=function(){var B=document.cookie.match(/ckns_dual=1/);var C=(typeof C!="undefined")?C:s();var A=(C.indexOf("https")==-1);if(A&&B){return true}return false};this.setCookie=function(C,F,B,D){F=F||"";var A="";if(B){var E=new Date();E.setTime(E.getTime()+B);A="Expires="+E.toUTCString()+"; "}F=D?g.encode(F):F;document.cookie=C+"="+F+"; "+A+"Domain=.bbc.co.uk; Path=/"};this.getCookie=function(B,D){var A=new RegExp("/"+B+"=([w]+)/");var C=document.cookie.match(A);if(!C){return null}return D?g.decode(C[1]):C[1]};this.setCknsIdCookieProperty=function(A,C){var D=this.getUserDetailsFromCookie();D[A]=C;var B=D["jwt-exp"]?D["jwt-exp"]*1000:f.USER_DETAILS_COOKIE_EXPIRE_TIME;this.setCookie(f.USER_DETAILS_COOKIE_NAME,JSON.stringify(D),B,true)};this.unsetCookie=function(A){document.cookie=A+"=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Domain=.bbc.co.uk; Path=/"};function s(){return window.location.protocol}function r(){v();m()}function v(){if(typeof window.bbccookies==="object"){var A=document.cookie.match(/ckpf_APHID=([^;]*)/);if(A){if(!window.bbccookies.isAllowed("ckpf_APHID")){l()}}}}function m(){var A=z.isIdv5On?/ckns_id=([\w]+)/:/IDENTITY=([^;]*)/;var B=document.cookie.match(A);if(B&&!z.isIdv5On){y(B)}else{if(B&&z.isIdv5On){q(B)}else{n()}}}function y(B){var A=decodeURIComponent(B[1]).split("|");if(o(A)&&!x(A[3])){z.valid=true;z.id=A[0];z.username=A[1];z.displayname=decodeURIComponent(A[2]);z.timestamp=A[3]}else{w()}}function q(A){var B=k(A[1]);if(u(B)&&!p(B)){z.valid=true;z.displayname=B.dn}else{w()}}function o(A){return(6<=A.length)}function x(B){var C=z.cookieAgeDays*j;var A=(new Date()).getTime();if(z.isIdv5On){A=Math.floor(A/1000)}return(A-B>=C)}function u(A){var B=(A.hasOwnProperty("ses-exp")&&A.hasOwnProperty("jwt-exp")&&A.hasOwnProperty("tkn-exp"));return B}function p(B){var D=Math.floor((new Date()).getTime()/1000);var F=B["ses-exp"];var A=B["jwt-exp"];var C=B["tkn-exp"];var E=(F<=D&&A<=D&&C<=D);return E}function w(){n();t()}function n(){z.valid=false;z.id="";z.username="~";z.displayname="";z.timestamp=""}function t(){if(z.isIdv5On){document.cookie="ckns_id=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Domain=.bbc.co.uk; Path=/"}else{document.cookie="IDENTITY=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Domain=.bbc.co.uk; Path=/";document.cookie="IDENTITY_ENV=; Expires=Thu, 01 Jan 1970 01:00:00 GMT; Domain=.bbc.co.uk; Path=/";l()}}function l(){document.cookie="ckpf_APHID=; Expires=Thu, 01 Jan 1970 01:00:00 GMT; Domain=.bbc.co.uk; Path=/"}}f.getInstance=d;f.setInstance=c;f.downgradeUser=i;return f});