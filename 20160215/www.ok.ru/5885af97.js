define(["jquery","OK/logger","OK/utils/utils"],function(d,w,t){var p=d("body"),a="ShortcutMenu",v=d("<div>").attr("id","hook_Block_"+a).appendTo(p),f=d(document),n=d(window),c="ontouchstart" in document.documentElement;OK.hookModel.captureBlockHook("body",a,v[0]);var h=function(){this.stopClick=true;this.ajaxProcessing=false;this.ajaxTimeout=0;this.showTimeout=null;this.hideTimeout=null;this.menuElement=null;this.cacheable=true;this.loaded=false;this.showOnClick=true;this.listenersPostfix=".shortcut";};h.prototype={activate:function(z){var A=d(z);this.hookElem=A;this.blockId=A.attr("data-blockid");this.block=A.find("#hook_Block_"+this.blockId);this.inplace=A.attr("data-inplace");this.loaded=A.attr("data-loaded");this.holder=A.prev();this.showDelay=parseInt(A.attr("data-show"),10)||100;this.hideDelay=parseInt(A.attr("data-hide"),10)||100;this.cacheable=!A.attr("data-nocache");this.direction=A.attr("data-direction");this.position=A.attr("data-position")||"center";this.showOnClick=A.attr("data-onClick");this.listenersPostfix=".shortcut"+Date.now();if(c){var y=this.holder.find("a").first()[0];if(y){y.addEventListener("click",this,true);this.link=y;}this.holder.on("touchstart"+this.listenersPostfix,o);}this.holder.on("mouseleave"+this.listenersPostfix,e.bind(this));if(this.showOnClick){this.holder.one("click"+this.listenersPostfix,u.bind(this));}else{this.holder.on("mouseenter"+this.listenersPostfix,i.bind(this));}s(this).on("click"+this.listenersPostfix,".sc-menu:not(.js-doNotHide) a",m.bind(this));s(this).on("click"+this.listenersPostfix,".sc-menu .js-hide",m.bind(this));s(this).on("mouseenter"+this.listenersPostfix,".sc-menu",b.bind(this)).on("mouseleave"+this.listenersPostfix,".sc-menu",e.bind(this)).on("touchstart"+this.listenersPostfix,".sc-menu a",k);},deactivate:function(){if(this.menuElement){j.apply(this);}if(c&&this.link){this.link.removeEventListener("click",this,true);}f.off(this.listenersPostfix);s(this).off(this.listenersPostfix);this.holder.off(this.listenersPostfix);this.ajaxTimeout=true;this.hookElem=null;},handleEvent:function(y){if(this.stopClick){y.preventDefault();y.stopPropagation();this.stopClick=false;this.holder.trigger("mouseenter");return false;}}};return h;function s(y){return y.inplace?y.block:v;}function x(y){var z=y.block.html();if(!y.inplace||!y.cacheable){OK.hookModel.setHookContent(y.blockId,"");if(y.cacheable){y.block.html(z);}}return z;}function u(){this.showTimeout=null;if(this.holder.hasClass("__vis")){return;}if(this.showOnClick){this.holder.one("click"+this.listenersPostfix,j.bind(this));}this.showTimeout=null;var y=this.hookElem.attr("data-url");if(c){p.one("touchstart"+this.listenersPostfix,e.bind(this));}if(this.ajaxProcessing){return;}this.startTime=Date.now();if(this.loaded){var z=x(this);q.call(this,z);w.success("asm","show","cache");}else{this.ajaxProcessing=true;t.ajax({type:"GET",url:y,dataType:"html"}).fail(l.bind(this)).done(r.bind(this));}}function j(){this.hideTimeout=null;this.stopClick=true;if(this.showOnClick){this.holder.one("click"+this.listenersPostfix,u.bind(this));}if(this.ajaxProcessing){this.ajaxTimeout=true;w.success("asm","ajax","to");}if(this.menuElement){this.menuElement.addClass("sc-menu__hidden");x(this);OK.hookModel.setHookContent(a,"");this.menuElement=null;}this.holder.removeClass("__vis");if(!this.inplace){v.off("change");}}function i(y){if(this.hideTimeout){this.hideTimeout=clearTimeout(this.hideTimeout);}if(!this.showTimeout){this.showTimeout=setTimeout(u.bind(this),this.showDelay);}}function e(){if(this.showTimeout){this.showTimeout=clearTimeout(this.showTimeout);}if(!this.hideTimeout){this.hideTimeout=setTimeout(j.bind(this),this.hideDelay);}}function b(y){if(this.hideTimeout){this.hideTimeout=clearTimeout(this.hideTimeout);}}function m(y){if(true===this.hideTimeout){this.hideTimeout=null;}e.apply(this);}function o(y){y.stopPropagation();}function k(y){y.preventDefault();d(this).trigger("click");}function l(){w.error("asm","ajax");this.ajaxProcessing=false;}function r(A,y,B){w.duration("asm",Date.now()-this.startTime,"ajax");this.ajaxProcessing=false;var z;if(!A||(z=A.split(OK.navigation.SPLITER)[0]).length==0){w.success("asm","ajax","e");return;}w.success("asm","show","ajax");if(this.cacheable&&this.hookElem){this.loaded=true;this.block.html(z);}if(this.ajaxTimeout){this.ajaxTimeout=false;}else{q.call(this,A,B);}}function q(A,B){var y,z=[];if(B&&(y=B.getResponseHeader(OK.navigation.HEADER))){z=y.split(",");}z[0]=this.inplace?this.blockId:a;t.updateBlocks(A,status,z);this.menuElement=s(this).find(".sc-menu");if(!this.inplace){v.off("change");v.on("change",g.bind(this));}g.call(this);this.menuElement.removeClass("sc-menu__hidden");this.holder.addClass("__vis");}function g(){var C=this.holder.outerHeight(true),B=this.inplace?{top:0,left:0}:this.holder.offset(),D=this.holder.outerWidth(true),A=this.menuElement.outerHeight(true),F=this.menuElement.outerWidth(true);var y;if(this.direction){y=this.direction==="top";}else{y=n.height()-((this.holder.offset().top+C)-OK.util.getDocumentScrollYPos())<A;}var E=B.top;if(y){this.menuElement.addClass("sc-menu__top");var z;if(this.inplace){z=E+C;this.menuElement.css("bottom",Math.round(z));this.menuElement.css("top","auto");}else{E-=A;this.menuElement.css("top",Math.round(E));this.menuElement.css("bottom","auto");}}else{this.menuElement.removeClass("sc-menu__top");if(!this.inplace){E+=C;}this.menuElement.css("top",Math.round(E));this.menuElement.css("bottom","auto");}switch(this.position){case"left":this.menuElement.css("left",Math.round(B.left-(F-D)));this.menuElement.addClass("__noarrow");break;case"right":this.menuElement.css("left",Math.round(B.left-D));this.menuElement.addClass("__noarrow");break;default:this.menuElement.css("left",Math.round(B.left+((D-F)/2)));break;}}});