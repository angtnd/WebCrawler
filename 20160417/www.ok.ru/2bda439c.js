define(["jquery","OK/utils/throttle"],function(d,l){var b="__loading",k="__playing",h="gif_video",e="gif_preview",c="gif_cnt",i="photo.gif",a="photo.gif.inplace";var g=[],j=d("#hook_Block_ShortcutMenu");var f=function(m){this.autoplay=m.getAttribute("data-autoplay")==="true";this.playOnClick=m.getAttribute("data-playOnClick")==="true";this.nostop=m.getAttribute("data-nostop")==="true";this.inMessages=m.getAttribute("data-messages")==="true";this.playOnParent=m.getAttribute("data-playOnParent")==="true";this.autoplayType=parseInt(m.getAttribute("data-autoplayType")||"0",10);this.location=m.getAttribute("data-location")||"u";this.volume=parseInt(m.getAttribute("data-volume"),10)||1;this.element=m;this.el=d(m);this.addEl=this.playOnParent?this.el.closest(".js-gifPlay").find(".gif-add"):this.el.closest(".media-photos_i").find(".gif-add");if(this.autoplay){if(this.nostop){this.play();}else{this.playOrStop();}}else{if(this.playOnClick){this.el.on("click.gif",d.proxy(this.togglePlay,this));}else{(this.playOnParent?this.el.parents("div.js-gifPlay"):this.el.parent()).on("mouseenter.gif",d.proxy(this.play,this)).on("mouseleave.gif",d.proxy(this.stop,this));}}};f.prototype={deactivate:function(){(this.playOnParent?this.el.parents("div.js-gifPlay"):this.el.parent()).off(".gif");if(this.playOnClick){this.el.off(".gif");}},playOrStop:function(){if(!this.autoplay){return;}var o=d(window),v=o.scrollTop(),m=v+o.height(),n=this.el.offset().top,t=n+this.el.height(),u=(n+t)/2,w=n>=v&&n<=m,r=t>=v&&t<=m,q=u>=v&&u<=m,s=false,p=this.el.hasClass(k)||this.el.hasClass(b);switch(this.autoplayType){case 0:s=w||r;break;case 1:s=w&&r;break;case 2:s=q;break;}if(s&&!p){this.play();}else{if(!s&&p&&!this.nostop){this.stop();}}},togglePlay:function(){var m=this.el.hasClass(k)||this.el.hasClass(b);if(!m){this.play();}else{this.stop();}},play:function(){var v,m=false,q=false,x=false,o=this.el.attr("data-mp4Src"),r=this.el.attr("data-webmSrc"),u=this.el.attr("data-width"),s=this.el.attr("data-height"),t=this.el.attr("data-style"),A=this.el.attr("data-imageSrc"),z=this.el.attr("data-gifSrc"),n=this.el.attr("data-preferWebm"),w=this.location,y=this;if(!this.skipMp4||!this.skipWebm){v=window.document.createElement("video");v.volume=this.volume;if(v&&typeof v.canPlayType==="function"){m=!this.skipMp4&&v.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"').length>0;q=!this.skipWebm&&v.canPlayType("video/webm").length>0;}v=d(v);}this.startTime=Date.now();if(m&&o!=null||q&&r!=null){v.attr("width",u);v.attr("height",s);v.attr("class",h);v.attr("style",t);v.attr("loop","true");v.on({"canplay.gif":function(){v.get(0).play();if(!x){OK.logging.logger.duration(i,Math.max(Date.now()-y.startTime,0),"video_start",w);}},"playing.gif":function(){y.el.addClass(k);y.addEl.addClass(k);y.el.removeClass(b);if(!x){x=true;OK.logging.logger.duration(i,Math.max(Date.now()-y.startTime,0),"video_play",w);OK.logging.logger.success(a,w,y.autoplay?"a":"m");}},"error.gif":function(){var B="und";var C=v.get(0);this.stop(true);if(C.error&&C.error.code){if(m){this.skipMp4=true;B="mp4";}else{if(q){this.skipWebm=true;B="webm";}}OK.logging.logger.success(i,"video_fail_"+B+"_"+C.error.code,w);this.play();}else{OK.logging.logger.success(i,"video_fail_"+B,w);}}.bind(this)});v.attr("src",n?q&&r||m&&o:m&&o||q&&r);v.attr("poster",A);d("."+c,this.el).append(v);this.el.addClass(b);v.get(0).load();v.get(0).play();OK.logging.logger.success(i,"video_load",w);}else{d("."+e,this.el).attr("src",z);var p=new Image();p.src=z;p.onload=function(){y.el.removeClass(b).addClass(k);y.addEl.addClass(k);OK.logging.logger.duration(i,Math.max(Date.now()-y.startTime,0),"gif_play",w);OK.logging.logger.success(a,w,y.autoplay?"a":"m");};p.onerror=function(){y.stop(true);OK.logging.logger.success(i,"gif_fail",w);};if(!p.complete){this.el.addClass(b);}else{this.el.removeClass(b).addClass(k);this.addEl.addClass(k);}OK.logging.logger.success(i,"gif_load",w);}},stop:function(m){var o=d("."+h,this.el),n=o.length>0;o.off(".gif");this.el.removeClass(b);this.el.removeClass(k);this.addEl.removeClass(k);o.remove();d("."+e,this.el).attr("src",this.el.attr("data-imageSrc"));if(!m){OK.logging.logger.duration(i,Math.max(Date.now()-this.startTime,0),n?"video_stop":"gif_stop",this.location);}},updateDimensions:function(n,m){var o=this;var p=function(){var q=d(this);var r=parseInt(o.el.attr("data-width"),10);var t=parseInt(o.el.attr("data-height"),10);var s=Math.max(1,Math.max(r/n,t/m));q.attr("width",Math.round(r/s));q.attr("height",Math.round(t/s));};d("."+e,this.el).each(p);d("."+h,this.el).each(p);}};return{activate:function(n){var m=this,o=d(n);if(o.hasClass("gif-add_item")){o.on("click",function(p){m.add(p.currentTarget,false);});}else{if(g.length===0){d(window).on("scroll.gif",l(500,function(){m.scroll(false);}));}g.push(new f(n));}},deactivate:function(n){var m=0;for(;m<g.length;++m){if(g[m].element===n){g[m].deactivate();g.splice(m,1);break;}}if(g.length===0){d(window).off("scroll.gif");}},add:function(p,m){var n=p.getAttribute("data-id"),q=p.getAttribute("data-type"),o=p.getAttribute("data-tkn"),r=p.getAttribute("data-container-id");if(m===true){d("#clonePhoto").addClass("invisible");d("#clonePhotoDone").removeClass("invisible");}else{d(p).closest("div.ovr-menu_soh").addClass("__success").end().closest(".gif-add").addClass("__gif-success").find(".sc-menu").addClass("__gif-success");j.find(".sc-menu").addClass("__gif-success").trigger("change");}d.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:"/web-api/photo/add",timeout:60000,data:JSON.stringify({photoId:n,type:q,tkn:o,cntId:r})});},scroll:function(n){for(var m=0;m<g.length;++m){if(g[m].inMessages===n){g[m].playOrStop();}}},stopInMessagesGifs:function(){for(var m=0;m<g.length;++m){if(g[m].inMessages){g[m].stop();}}},updateDimensions:function(o,p,m){for(var n=0;n<g.length;++n){if(g[n].element===o){g[n].updateDimensions(p,m);break;}}}};});