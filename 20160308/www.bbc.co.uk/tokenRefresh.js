define(["idcta/id-config","idcta/idCookie","idcta/apiUtils"],function(f,d,c){var k=5000;var h=15;var e=3600;var b="idapp_end";var p="error";var l="invalid";var n=[b,p,l];var r={};r.RETRY_AFTER_SHORT=h;r.RETRY_AFTER_LONG=e;r.MESSAGE_SUCCESS=b;r.MESSAGE_ERROR=p;r.MESSAGE_INVALID=l;r.RETRY_AFTER_SHORT=h;r.RETRY_AFTER_LONG=e;var m=d.getInstance();r.refreshTokensIfExpired=function(){if(!m.hasAccessTokenExpired()){return c.Promise.resolve()}return r.refreshTokens()};r.refreshTokens=function(){if(m.isHybridApp()){return c.Promise.reject({code:401,message:"Unauthorised"})}var s=m.getError();if(s&&c.timestampInFuture(s.retryAfter)){return c.Promise.reject(s)}if(m.hasJwtTokenExpired()){return o().then(function(){throw {code:401,message:"Invalid session"}})}return c.loadUrlInHiddenIframe(f.tokenRefresh_url,k,n).then(null,j).then(i).then(g).then(null,a).then(null,q)};var j=function(){var s=Math.floor((new Date()).getTime()/1000)+(f.flagpole.tokenRefresh?h:e);var t={code:408,message:"Request timeout",retryAfter:s};m.setCknsIdCookieProperty("ec",t);throw t};var i=function(s){if(s!==l){return s}throw {code:401,message:"Invalid session"}};var g=function(s){if(s===b){return s}throw m.getError()};var a=function(s){if(s){throw s}s={code:500,message:"Internal service error",retryAfter:Math.floor((new Date()).getTime()/1000)+h};m.setCknsIdCookieProperty("ec",s);throw s};var q=function(s){if(s.code!=401){throw s}return o().then(function(){throw s})};function o(){return c.loadUrlInHiddenIframe(f.signout_url,k).then(function(){if(m.getUserDetailsFromCookie()){m.unsetCookie("ckns_id")}},function(){m.unsetCookie("ckns_id")})}return r});