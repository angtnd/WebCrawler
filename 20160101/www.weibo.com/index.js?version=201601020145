(function(){if(!a)var a=function(){var a={},b="theia",c=[],d=200,e;a[b]={IE:/msie/i.test(navigator.userAgent),E:function(a){return typeof a=="string"?document.getElementById(a):a},C:function(a){var b;a=a.toUpperCase();a=="TEXT"?b=document.createTextNode(""):a=="BUFFER"?b=document.createDocumentFragment():b=document.createElement(a);return b},log:function(){var a,b=arguments,f=b.length,g=[].slice.apply(b,[0,f]),h="error",i;while(g[--f])if(g[f]instanceof Error){a=g.splice(f,1)[0];break}if(!a){a=new Error;h="log"}i=[g,h,(new Date).getTime(),a.message,a.stack];if(e)try{e.apply(null,i)}catch(j){}else{c.length>=d&&c.shift();c.push(i)}},_regLogFn:function(a){e=a},_clearLogList:function(){return c.splice(0,c.length)}};var f=a[b];f.register=function(c,d,e){if(!e||typeof e!="string")e=b;a[e]||(a[e]={});var f=a[e],h=c.split("."),i=f,j=null;while(j=h.shift())if(h.length){i[j]===undefined&&(i[j]={});i=i[j]}else if(i[j]===undefined)try{if(e&&e!==b){if(c==="core.util.listener"){i[j]=a[b].core.util.listener;return!0}if(c==="core.util.connect"){i[j]=a[b].core.util.connect;return!0}}i[j]=d(f);return!0}catch(k){setTimeout(function(){console.log(k)},0)}return!1};f.unRegister=function(c,d){if(!d||typeof d!="string")d=b;var e=a[d],f=c.split("."),h=e,i=null;while(i=f.shift())if(f.length){if(h[i]===undefined)return!1;h=h[i]}else if(h[i]!==undefined){delete h[i];return!0}return!1};f.regShort=function(a,b){if(f[a]!==undefined)throw"["+a+"] : short : has been register";f[a]=b};f.shortRegister=function(c,d,e){if(!e||typeof e!="string")e=b;var f=a[e],h=c.split(".");if(!d)return!1;if(f[d])return!1;var i=f,j=null;while(j=h.shift())if(h.length){if(i[j]===undefined)return!1;i=i[j]}else if(i[j]!==undefined){if(f[d])return!1;f[d]=i[j];return!0}return!1};f.getPKG=function(c){if(!c||typeof c!="string")c=b;return a[c]};return f}();a.register("core.util.listener",function(a){return function(){var a={},b=[],c,d=function(){if(b.length!=0){clearTimeout(c);var a=b.splice(0,1)[0];try{a.func.apply(a.func,[].concat(a.data))}catch(g){}c=setTimeout(d,25)}};return{register:function(b,c,d){a[b]=a[b]||{};a[b][c]=a[b][c]||[];a[b][c].push(d)},fire:function(c,g,h){var i,j,k;if(a[c]&&a[c][g]&&a[c][g].length>0){i=a[c][g];i.data_cache=h;for(j=0,k=i.length;j<k;j++)b.push({channel:c,evt:g,func:i[j],data:h});d()}},remove:function(b,c,d){if(a[b]&&a[b][c])for(var e=0,f=a[b][c].length;e<f;e++)if(a[b][c][e]===d){a[b][c].splice(e,1);break}},list:function(){return a},cache:function(b,c){if(a[b]&&a[b][c])return a[b][c].data_cache}}}()});a.register("core.obj.parseParam",function(a){return function(a,b,c){var d,e={};b=b||{};for(d in a){e[d]=a[d];b[d]!=null&&(c?a.hasOwnProperty(d)&&(e[d]=b[d]):e[d]=b[d])}return e}});a.register("core.dom.removeNode",function(a){return function(c){c=a.E(c)||c;try{c.parentNode.removeChild(c)}catch(d){}}});a.register("core.util.getUniqueKey",function(a){var b=(new Date).getTime().toString(),c=1;return function(){return b+c++}});a.register("core.func.empty",function(){return function(){}});a.register("core.str.parseURL",function(a){return function(a){var b=/^(?:([A-Za-z]+):(\/{0,3}))?([0-9.\-A-Za-z]+\.[0-9A-Za-z]+)?(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/,c=["url","scheme","slash","host","port","path","query","hash"],d=b.exec(a),e={};for(var f=0,g=c.length;f<g;f+=1)e[c[f]]=d[f]||"";return e}});a.register("core.arr.isArray",function(a){return function(a){return Object.prototype.toString.call(a)==="[object Array]"}});a.register("core.str.trim",function(a){return function(a){if(typeof a!="string")throw"trim need a string as parameter";var b=a.length,c=0,d=/(\u3000|\s|\t|\u00A0)/;while(c<b){if(!d.test(a.charAt(c)))break;c+=1}while(b>c){if(!d.test(a.charAt(b-1)))break;b-=1}return a.slice(c,b)}});a.register("core.json.queryToJson",function(a){return function(c,d){var e=a.core.str.trim(c).split("&"),f={},g=function(a){return d?decodeURIComponent(a):a};for(var h=0,i=e.length;h<i;h++)if(e[h]){var j=e[h].split("="),k=j[0],l=j[1];if(j.length<2){l=k;k="$nullName"}if(!f[k])f[k]=g(l);else{a.core.arr.isArray(f[k])!=!0&&(f[k]=[f[k]]);f[k].push(g(l))}}return f}});a.register("core.json.jsonToQuery",function(a){var b=function(b,c){b=b==null?"":b;b=a.core.str.trim(b.toString());return c?encodeURIComponent(b):b};return function(a,d){var e=[];if(typeof a=="object")for(var f in a){if(f==="$nullName"){e=e.concat(a[f]);continue}if(a[f]instanceof Array)for(var g=0,h=a[f].length;g<h;g++)e.push(f+"="+b(a[f][g],d));else typeof a[f]!="function"&&e.push(f+"="+b(a[f],d))}return e.length?e.join("&"):""}});a.register("core.util.URL",function(a){return function(c,d){var e=a.core.obj.parseParam({isEncodeQuery:!1,isEncodeHash:!1},d||{}),f={},g=a.core.str.parseURL(c),h=a.core.json.queryToJson(g.query),i=a.core.json.queryToJson(g.hash);f.setParam=function(a,b){h[a]=b;return this};f.getParam=function(a){return h[a]};f.setParams=function(a){for(var b in a)f.setParam(b,a[b]);return this};f.setHash=function(a,b){i[a]=b;return this};f.getHash=function(a){return i[a]};f.valueOf=f.toString=function(){var c=[],d=a.core.json.jsonToQuery(h,e.isEncodeQuery),f=a.core.json.jsonToQuery(i,e.isEncodeQuery);if(g.scheme!=""){c.push(g.scheme+":");c.push(g.slash)}if(g.host!=""){c.push(g.host);if(g.port!=""){c.push(":");c.push(g.port)}}c.push("/");c.push(g.path);d!=""&&c.push("?"+d);f!=""&&c.push("#"+f);return c.join("")};return f}});a.register("core.io.scriptLoader",function(a){var b={},c={url:"",charset:"UTF-8",timeout:3e4,args:{},onComplete:a.core.func.empty,onTimeout:a.core.func.empty,isEncode:!1,uniqueID:null};return function(e){var f,g,h=a.core.obj.parseParam(c,e);if(h.url=="")throw"scriptLoader: url is null";var i=h.uniqueID||a.core.util.getUniqueKey();f=b[i];if(f!=null&&a.IE!=!0){a.core.dom.removeNode(f);f=null}f==null&&(f=b[i]=a.C("script"));f.charset=h.charset;f.id="scriptRequest_script_"+i;f.type="text/javascript";h.onComplete!=null&&(a.IE?f.onreadystatechange=function(){if(f.readyState.toLowerCase()=="loaded"||f.readyState.toLowerCase()=="complete"){try{clearTimeout(g);document.getElementsByTagName("head")[0].removeChild(f);f.onreadystatechange=null}catch(a){}h.onComplete()}}:f.onload=function(){try{clearTimeout(g);a.core.dom.removeNode(f)}catch(b){}h.onComplete()});f.src=a.core.util.URL(h.url,{isEncodeQuery:h.isEncode}).setParams(h.args).toString();document.getElementsByTagName("head")[0].appendChild(f);h.timeout>0&&(g=setTimeout(function(){try{document.getElementsByTagName("head")[0].removeChild(f)}catch(a){}h.onTimeout()},h.timeout));return f}});a.register("core.io.jsonp",function(a){return function(c){var d=a.core.obj.parseParam({url:"",charset:"UTF-8",timeout:3e4,args:{},onComplete:null,onTimeout:null,responseName:null,isEncode:!1,varkey:"callback"},c),e=-1,f=d.responseName||"STK_"+a.core.util.getUniqueKey();d.args[d.varkey]=f;var g=d.onComplete,h=d.onTimeout;window[f]=function(a){if(e!=2&&g!=null){e=1;g(a)}};d.onComplete=null;d.onTimeout=function(){if(e!=1&&h!=null){e=2;h()}};return a.core.io.scriptLoader(d)}});a.register("common.listener",function(a){var b={},c={};c.define=function(c,e){if(b[c]!=null)throw"common.listener.define: é¢éå·²è¢«å ç¨";b[c]=e;var f={};f.register=function(e,f){if(b[c]==null)throw"common.listener.define: é¢éæªå®ä¹";a.core.util.listener.register(c,e,f)};f.fire=function(e,f){if(b[c]==null)throw"commonlistener.define: é¢éæªå®ä¹";a.core.util.listener.fire(c,e,f)};f.remove=function(b,d){a.core.util.listener.remove(c,b,d)};return f};return c});a.register("common.channel.qrcode_login",function(a){return a.common.listener.define("common.channel.qrcode_login",["qrcode_scanned","qrcode_used","qrcode_timeout","qrcode_exception","login_failure","login_success"])});a.register("jobs.qrcode_login",function(a){var b={},c=a.common.channel.qrcode_login,d={entry:"sso",domain:"weibo.com",get_image_timeout:1e4,check_request_timeout:1e4,qrcode_size:180,crossdomain_timeout:3e3,savestate:30},e={qrcode_image:"//login.sina.com.cn/sso/qrcode/image",qrcode_check:"//login.sina.com.cn/sso/qrcode/check",qrcode_login:"//login.sina.com.cn/sso/login.php"},f,g=0,h=3e3,i;b.set=function(a){for(var c in a)d[c]=a[c];return b};b.getQRcode=function(a){return j(function(b){a(b)})};b.getQRcodeId=function(){return f};b.start=function(){i=!1;g++;k(g)};b.cancel=function(){i=!0};b.register=function(a,d){c.register(a,d);return b};b.remove=function(a,d){c.remove(a,d);return b};var j=function(g){a.core.io.jsonp({url:e.qrcode_image,timeout:d.get_image_timeout,args:{entry:d.entry,size:d.qrcode_size},onComplete:function(a){if(!a||a.retcode!=2e7)g(a);else{var b=a.data;b.interval&&(h=b.interval);f=b.qrid;g(a)}},onTimeout:function(){c.fire("get_image_timeout")},isEncode:!0,varkey:"callback"});return b},k=function(a){var b=function(d){d.retcode==2e7?m(d):d.retcode==50114002?c.fire("qrcode_scanned",[d]):d.retcode==50114003?c.fire("qrcode_timeout",[d]):d.retcode==50114004&&c.fire("qrcode_used",[d]);(d.retcode==50114001||d.retcode==50114002)&&setTimeout(function(){if(!(a<g)){if(i)return;l(b)}},h)};l(b)},l=function(b){a.core.io.jsonp({url:e.qrcode_check,timeout:d.check_request_timeout,args:{entry:d.entry,qrid:f},onComplete:function(a){a?b(a):b({retcode:-1})},onTimeout:function(){c.fire("check_timeout")},isEncode:!0,varkey:"callback"})},m=function(b){a.core.io.jsonp({url:e.qrcode_login,timeout:d.login_request_timeout,args:{entry:d.entry,returntype:"TEXT",crossdomain:1,cdult:3,domain:d.domain,alt:b.data.alt,savestate:d.savestate},onComplete:function(a){a.retcode!=0?c.fire("login_failure",{retcode:a.retcode,msg:a.reason}):n(a,function(b){b.result===!1?c.fire("login_failure",{retcode:-2,msg:"ç»å½å¤±è´¥"}):c.fire("login_success",a)})},onTimeout:function(){c.fire("login_failure",{retcode:-1,msg:"ç»å½è¶æ¶"})},isEncode:!0,varkey:"callback"})},n=function(b,c){var e=b.crossDomainUrlList.length;if(e==0)c({result:!0});else{var f=setTimeout(function(){e=-1;c({result:!1})},d.crossdomain_timeout);for(var g in b.crossDomainUrlList)a.core.io.scriptLoader({url:b.crossDomainUrlList[g],charset:"UTF-8",args:{action:"login"},onComplete:function(){e--;if(e==0){clearTimeout(f);c({result:!0})}}})}};return b});(function(a){var b=a.jobs.qrcode_login;b.getVersion=function(){return"qrcode_login.js(v1.0.1) 2013-12-02"};b.STK=a;this.SINA_QRCODE_LOGIN=b}).call(this,a)}).call(this);
STK.register("common.listener",function(a){var b={},c={};c.define=function(c,d){if(b[c]!=null)throw"common.listener.define: é¢éå·²è¢«å ç¨";b[c]=d;var e={};e.register=function(d,e){if(b[c]==null)throw"common.listener.define: é¢éæªå®ä¹";a.listener.register(c,d,e)};e.fire=function(d,e){if(b[c]==null)throw"commonlistener.define: é¢éæªå®ä¹";a.listener.fire(c,d,e)};e.remove=function(b,d){a.listener.remove(c,b,d)};e.cache=function(b){return a.listener.cache(c,b)};return e};return c});
STK.register("common.channel.sso.qrcode",function(a){var b=["qrcode_scanned","qrcode_used","qrcode_timeout","qrcode_exception","login_success","login_failure","getQRcode","getQRcode_success","start","cancel","set"];return a.common.listener.define("common.channel.sso.qrcode",b)});
STK.register("common.login.sso.qrcodebridge",function(a){var b=window.SINA_QRCODE_LOGIN,c=a.common.channel.sso.qrcode;return function(a){var d=!1,e={init:function(){if(!d){e.bind();d=!0}},bind:function(){for(var a in e.send)b.register(a,e.send[a]);for(var a in e.handle)c.register(a,e.handle[a])},unbind:function(){},send:{qrcode_scanned:function(a){c.fire("qrcode_scanned",a)},qrcode_used:function(a){c.fire("qrcode_used",a)},qrcode_timeout:function(a){c.fire("qrcode_timeout",a)},qrcode_exception:function(a){c.fire("qrcode_exception",a)},login_success:function(a){c.fire("login_success",a)},login_failure:function(a){c.fire("login_failure",a)}},handle:{getQRcode:function(){b.getQRcode(function(a){if(a.retcode=="20000000"){c.fire("getQRcode_success",a);b.start()}})},cancel:function(){b.cancel()},start:function(){b.start()},set:function(a){b.set(a)}}},f={};e.init();return f}});
STK.pageletM.register("pl.plugin.sso.qrcode.index",function(a){return a.common.login.sso.qrcodebridge()});
