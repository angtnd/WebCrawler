define(["jquery","OK/logger"],function(aq,R){var ao,W=null,U=null,ak="mtLayer",M="mtLayerMain",ac="mtLayerBack",ax="mtLayerForward",c="scrollToTopMtLayer",ai="media-layer media-layer__topic __redesign",j="media-layer_hld",aj="mlr_disc",aa="media-layer_close",at="media-layer_close_ico",d="sticky-plank_cnt",T="media-layer_fixer",af=310,i=null,F=null,x=null,o=null,b=null,w=null,aA=null,n=null,au=null,N=1145,D={id:null,to:75},L="MediaTopicLayerBody",l="layer__disabled",v="invisible",p="data-open-count",g="data-slide-count",az="data-slide-count-per-open",f=false,ar,Q,a=false,G={showIfAllowed:function(){},hide:function(){},};function A(aG,aE){var aF=document.getElementById(aG),aD;if(!aF){return false;}for(aD=0;aD<aE.length;aD+=1){if(aF.classList.contains(aE[aD])){return false;}}return true;}function X(){return ao.isActive&&!aq("#hook_Block_PopLayerMediaTopic").hasClass(l);}function u(){return ao.isActive&&aq("#hook_Block_PopLayerMediaTopic").hasClass(l);}function y(aD){if(X()){if(!a&&i[0]!==document.activeElement&&i.find(document.activeElement).length===0){i.focus();a=true;}if(i.find(".__edit").length>0){return;}if(i.find(".tag-box__editable").length>0){return;}if(A("hook_Modal_popLayerModal",[l])){return;}if(A("photoLayerWrapper",[l,v])){return;}if(A("video-poplayer-cnt",[l,v])){return;}if(aD.keyCode===39&&n){n.click();OK.stop(aD);}else{if(aD.keyCode===37&&aA){aA.click();OK.stop(aD);}}}}function z(aD){if(aD){OK.Layers.register(ak,function(){P("cr_esc");},undefined,false,y);}else{OK.Layers.remove(ak);}}function Y(aD,aE){OK.loader.use("OKCustomJs",function(){if(aD){z(aE);}if(aE){if(OK.Layers.onLayerShown){OK.Layers.onLayerShown();}}else{if(OK.Layers.onLayerHidden){OK.Layers.onLayerHidden();}}});}function J(){U.toggleClass("__layer",!!ao.isActive);}function aw(){var aD=ai;if(ao.isActive){aD+=" __active";}if(ao.isProcess){aD+=" __process";}i.attr("class",aD);}function am(){Y(true,ao.isActive);J();aw();if(ao.isActive){q();}}function q(){k(p);i.attr(az,0);}function aB(){k(g);k(az);}function k(aD){var aE=parseInt(i.attr(aD),10);if(isNaN(aE)){aE=0;}i.attr(aD,aE+1);}function E(aE){var aD=ao.isActive!==aE;ao.isActive=aE;if(aD){am();}else{if(u()){Y(false,true);}}document.getElementById("hook_Block_PopLayerMediaTopic").classList.remove(l);}function ag(aD){var aE=ao.isProcess!==aD;ao.isProcess=aD;if(aE){aw();}}function s(aD){F.toggleClass("__process",aD);}function H(aF,aD){var aG=aF.length,aE=aG;while(--aG+1){aF[aG].toggleClass(aD);}setTimeout(function(){while(--aE+1){aF[aE].toggleClass(aD);}},1);}function B(){if(o){var aD=0;aq(".comments_i",o).each(function(){var aE=aq(this).data("unread");if(aE){aD=this.getBoundingClientRect().top;}return !aE;});i.each(function(){this.scrollTop=(aD!==0)?this.scrollTop+aD:this.scrollHeight;});setTimeout(function(){aq(".js-comments_add",o).focus();},50);}}function r(aI,aF,aH){var aE=aq(window),aD=aE.height(),aG=aE.width();if(D.id){clearTimeout(D.id);}D.id=setTimeout(function(){H([w,n,aA,au],T);D.id=null;},aI?0:D.to);i.toggleClass("__compact",aG<=N);i.toggleClass("__min-height",(aD<af));if(aF){B();}if(aH){ae(aH);}}function t(aD){if(f){return;}f=true;W=aq(window);U=aq(document.body);i=aq("#"+ak);F=aq("#"+M);aA=aq("#"+ac);n=aq("#"+ax);au=aq("#"+c);ao={isActive:i.hasClass("__active"),isProcess:i.hasClass("__process")};x=i.find("."+j);w=x.find("."+aa);w.click(function(aG){var aF="cr_shadow",aE=OK.eventTarget(aG);if(aq(aE).hasClass(at)){aF="cr_close";}P(aF);});if(ao.isActive){am();if(!ao.isProcess){r(true,aD);}}if(aD){B();}W.on("resize.mtLayer",function(){r();});}var e;var V;var ay;function S(aE,aD){if(aD==null||aD.length==0){return;}OK.historyManager.putItemToCache(aE,aD);}function ap(aE){if(OK.historyManager.isHistorySupported()){var aF=aE.indexOf("?");if(aF>0){ay=aE.substr(aF+1);V=aE.substr(0,aF);if(ay.length>0){ay+="&mt.scrollTop="+aq(window).scrollTop();}else{ay=null;}S(V,ay);}else{V=aE;ay=null;}var aG=K()==V&&!Q;var aD;if(!e){if(aG){aD=true;}else{if(Q){av(Q,true);}}e=K();}else{aD=!ao.closeTopicId;}Q="";if(!aG){av(V,aD);}}}function I(){if(!e&&V==K()){av(e,true);}e=null;V=null;ay=null;}function K(){return OK.historyManager.getState();}function av(aE,aD){if(aD){OK.historyManager.replaceState(aE);}else{OK.historyManager.pushState(aE);}}function P(aI){a=false;ao.topicId=null;ao.owner=null;var aG=ao.closeTopicId,aD=ao.closeOwnerType;ao.closeTopicId=null;ao.closeOwnerType=null;if(aG&&(aI==="cr_esc"||aI==="cr_shadow"||aI==="cr_close"||aI==="cr_fail")){if(aI){ab(aI+"_ct");}setTimeout(function(){if(OK.historyManager.isHistorySupported()){OK.historyManager.back();}else{an(aG,aD,"");}},0);return;}var aF=X();var aE=false;if(aF){if(e&&V==K()){if(e==V){aE=true;OK.historyManager.back();}else{av(e,true);}}}if(!aE){E(false);ag(false);s(false);m();ah();au.removeClass("__active __animated");OK.hookModel.setHookContent(L,"");}e=null;if(aI){ab(aI);}i.trigger("mtLayer.close");try{G.hide();}catch(aH){ab("adsCloseError");}}function ab(aD){R.success("mtlayer",ar||"",aD);}function m(){aA.removeClass("__active");n.removeClass("__active");}function O(aD,aE){if(aA){aA.toggleClass("__active",!!aD&&!!aE);aA.unbind("click.back").bind("click.back",function(aG){if(aA.hasClass("__active")){var aF=n.hasClass("__active");an(aD,aE,"MT_GoBack_"+aE,false,"","BACK",aF);}OK.stop(aG);});}}function h(aD,aE){if(n){n.toggleClass("__active",!!aD&&!!aE);n.unbind("click.forward").bind("click.forward",function(aG){if(n.hasClass("__active")){var aF=aA.hasClass("__active");an(aD,aE,"MT_GoForward_"+aE,false,"","FORWARD",aF);}OK.stop(aG);});}}function ae(aF){if(aF){var aG=i.find("[data-scroll-to='"+aF+"']");if(aG.length>0){var aK=aG[0],aJ=aK.offsetTop,aD=aK.offsetParent;while(aD&&aD.nodeType===1&&aD!==i[0]){aJ+=aD.offsetTop;aD=aD.offsetParent;}var aI=i,aH=aI.height(),aE=aI.scrollTop(),aL=aH;if(aE+aH<=aJ+aL){aI.scrollTop(aJ+aL-aH-5);}else{if(aE>aJ){aI.scrollTop(aJ-5);}}}}}function ah(){var aD=U;var aE=aD.find(".gwt-shortcutMenu__show");if(aE.length){aE.removeClass("gwt-shortcutMenu__show");}var aF=aD.find(".sc-menu:not(.sc-menu__hidden,.poll_ans_cnt)");if(aF.length){aF=aF.not("#ownProfileLSMnu");aF.addClass("sc-menu__hidden");}}var aC=[0,1,2,3,5,8,13,21,34,55,89,144,233,377,610];function al(aE,aG){var aF=(aG-aE)/100;var aD;for(aD=1;aD<aC.length;aD++){if(aF<aC[aD]){break;}}return aC[aD-1]+"00";}function Z(){if(i){i.scrollTop(0);}}function ad(aD){if(ao.isProcess){ag(false);}else{s(false);}aD&&aD();}function C(aG,aM,aJ,aO,aP){Q=aM;t(aJ);var aE=aq("#"+L);var aL=aE.attr("data-log");if(aL){ab(aL);}var aF=aE.attr("data-url");if(aF){ap(aF);}else{I();}if(ao.closeTopicId||aO){}else{var aI=aE.attr("data-back-id");O(aI,aG);var aH=aE.attr("data-forward-id");h(aH,aG);}var aN=aE.attr("data-id");if(aN){ao.topicId=aN;ao.owner=aG;}var aD=aE.attr("data-log-click");if(aD){i.attr("data-log-click",aD);}else{i.removeAttr("data-log-click");}if(!ao.isProcess){aw();}ad(aP);H([n,aA,au],T);Z();o=x.find("."+aj);b=x.find("."+d);var aK=aE.attr("data-scroll-to-marker");r(true,aJ,aK);}function an(aM,aF,aE,aH,aL,aP,aR,aQ,aO,aK,aN){var aJ=+new Date();var aG;t(aH);if(!aP){ao.closeTopicId=null;ao.closeOwnerType=null;}if(aE&&aE.indexOf("st.mt.or=on")!==-1){aO=ao.topicId;aK=ao.owner;}if(OK.photoLayer){OK.photoLayer.close();}OK.VideoPlayer.pauseAll();OK.loader.use("OKCustomJs",function(){var aT=OK.Layers.stack;var aU=aT&&aT.length>0&&aT[aT.length-1].id===ak;if(!aU&&ao.isActive){z(true);}});function aS(aV){var aU=Date.now();var aT="";if(aV){aT+="r_";}if(aP){aT+="dt";}else{aT+="ot";}ab(aT+al(aJ,aU));if(aG){ab("js_"+aT+al(aG,aU));}}ar=aF;Q=aL;if(Q){ab("shortlink");}m();if(ao.isActive&&!ao.isProcess){s(true);ah();}else{ag(true);}E(true);var aD;if(OK.getCurrentStateLink){aD=OK.getCurrentStateLink();}else{aD="/dk?"+window.pageCtx.state.replace("&amp;","&");}aD+=aD.indexOf("?")===-1?"?":"&";aD=aD.replace(/st\.mt\.(id|ot|bi|dir|hn).*?(&|$)/g,"");aD+="cmd="+L+"&st._aid="+aE;var aI=aq.ajax({type:"POST",url:aD,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":aM,"st.mt.ot":aF,"st.mt.dir":aP,"st.mt.wc":aQ?"on":"off","st.mt.hn":aN?"on":"off"},headers:{TKN:OK.tkn.get()}});aI.done(function(aV,aT,a2){aG=Date.now();if(aO){ao.closeTopicId=aO;ao.closeOwnerType=aK;}var aY=a2.getResponseHeader("Redirect-Location");if(aY){var aZ=function(a3){if(OK.navigation.redirect){OK.navigation.redirect(aY);}if(a3===0||OK.navigation.redirect){P();aS();}else{setTimeout(function(){aZ(a3-1);},200);}};aZ(5);}else{var aW=a2.getResponseHeader("End-Reached");if(aW==="yes"){if(aP==="FORWARD"){if(aR){aA.toggleClass("__active",true);}}else{if(aP=="BACK"){if(aR){n.toggleClass("__active",true);}}}ad(aS);return;}var aX=aV.split(OK.navigation.SPLITER),a0=a2.getResponseHeader(OK.navigation.HEADER).split(",");for(var aU=0;aU<aX.length;aU++){if(a0[aU]){OK.hookModel.setHookContent(a0[aU],aX[aU]);}}if(aP){aB();}try{G.showIfAllowed();}catch(a1){ab("adsOpenError");}C(aF,Q,aH,aN,aS);}});aI.fail(function(){P("cr_fail");aS();});return aI;}return{show:function(){t();E(true);Z();},showPreloaded:C,showTopicInLayer:an,closeLayer:function(){if(f){P();}},hideLayer:function(){a=false;if(ao&&ao.isActive){if(e&&K()==V){av(e,true);}Y(false,false);}},restoreLayer:function(){if(ao&&ao.isActive){H([w,n,aA,au],T);if(e&&K()!==V){av(V,true);}Y(false,true);}},refreshLayerBody:function(aG){function aD(){if(aG){aG();}}if(!ao||!ao.topicId||!ao.owner){aD();return;}var aE="/";if(OK.getCurrentStateLink){aE=OK.getCurrentStateLink();}aE+=aE.indexOf("?")===-1?"?":"&";aE+="cmd="+L+"&st._aid=PLPhotoUserBackToView";var aF=aq.ajax({type:"POST",url:aE,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":ao.topicId,"st.mt.ot":ao.owner},headers:{TKN:OK.tkn.get()}});aF.done(function(aL,aN,aM){var aI=aM.getResponseHeader("Redirect-Location");if(aI){if(OK.navigation.redirect){OK.navigation.redirect(aI);}P();}else{var aH=aL.split(OK.navigation.SPLITER),aK=aM.getResponseHeader(OK.navigation.HEADER).split(",");for(var aJ=0;aJ<aH.length;aJ++){if(aK[aJ]){OK.hookModel.setHookContent(aK[aJ],aH[aJ]);}}}aD();});aF.fail(aD);},deactivate:function(){aq(window).off(".mtLayer");E(false);},isActiveAndNotHidden:function(){if(!f){return false;}return X();},adsHandlers:function(){return G;},logAdsOpen:function(){ab("adsOpen");}};});