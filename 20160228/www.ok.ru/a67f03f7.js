define(["jquery","OK/logger","okVideoPlayerUtils"],function(g,D,x){var q=null;var y=null;var p={};g(window).on("onMusicPlaying",function(){if(p.isExternalPlayer){v();}else{B("pause");}});function m(K,H,E,F){var J=g("#"+K),G=g("<div/>",{"class":"vp_video_stub_w"}),I=g("<div/>",{"class":"vp_video_stub __na"}).appendTo(G);g("<div/>",{"class":"vp_video_stub_txt",html:(H||"")}).appendTo(I);if(F){J.replaceWith(G);J=G;}else{J.append(G);}if(E){g("<img/>",{width:"100%",src:E,"class":"vp-video_stub_i"}).insertBefore(G);}return J;}function A(E){for(var F in E){if(E.hasOwnProperty(F)){if(typeof E[F]!=="string"){E[F]=encodeURIComponent(JSON.stringify(E[F]));}}}return E;}function a(E){E.isExternalPlayer&&g.ajax({url:"/dk?cmd=videoStatNew",contentType:"application/json",type:"POST",data:JSON.stringify({duration:0,contentId:E.url,location:E.flashvars.location,providerId:E.provider,batch:[{name:"started"}]})}).error(function(){D.error("OKVideoStart","failOG");});}function j(E){return g.ajax({url:decodeURIComponent(E),dataType:"json",type:"GET",headers:{TKN:OK.tkn.get()}});}function r(F,E){return g.ajax({url:"/dk?cmd=videoCommand&a=getVideoPlayerAttributes&st.vv_movieId="+F+"&st.location="+E,dataType:"json",type:"GET",headers:{TKN:OK.tkn.get()}});}function d(G){var H=G.flashvars.metadata.liveStreamInfo;if(!H){return true;}var I=parseInt(H.startTime,10),E=parseInt(H.endTime,10),F=Date.now()+G.timeshift;return !!((!E||F<=E)&&(!I||F>I));}function k(F,E){require(["okHtml5Player"],function(G){G.embedPlayer(E,E,F.flashvars);});}function h(F,E){require(["swfobject"],function(I){if(I.getObjectById(E)){return;}var J=I.hasFlashPlayerVersion(F.minFlashVersionNewPlayer||"11.2.0")&&F.url11?F.url11:F.url;var H={id:E,name:E};var K={allowScriptAccess:F.asa?"always":"never",wmode:F.wmode||"opaque",allowFullScreen:true,menu:false,bgcolor:"#000000"};var G=A(g.extend({},F.flashvars,{autoplay:true,wmode:K.wmode,stageVideo:K.wmode=="direct"||K.wmode=="gpu",playerId:F.playerId}));I.embedSWF(J,E,"100%","100%","10.0.0",null,G,K,H);});a(F);}function t(F,E){var G=document.createElement("iframe");G.id=E;G.width="100%";G.height="100%";G.tabIndex="999";G.frameBorder="no";G.scrolling="no";G.allowFullScreen=true;G.setAttribute("allowfullscreen","");G.src=F.url;var H=document.getElementById(E);H.parentNode.replaceChild(G,H);a(F);}function o(R,J,H){var P=R.flashvars.metadata.liveStreamInfo,I=Date.now()+R.timeshift,G=parseInt(P.startTime,10),L=parseInt(P.endTime,10),Q=g("#"+J);function M(X,W){var V=~~((X-W)/1000),U=~~(V/3600),S=~~(V/60)%60,T=V%60;return(U<10?"0"+U:U)+":"+(S<10?"0"+S:S)+":"+(T<10?"0"+T:T);}var F=g("<div/>",{id:H,"class":"vp_broadcast-stub_w"}),K=g("<div/>",{"class":"vp_video_stub_w"}).appendTo(F),N=g("<div/>",{"class":"vp_broadcast-stub"}).appendTo(K);g("<img/>",{width:"100%",src:R.poster,"class":"vp-video_stub_i"}).appendTo(F);g("<div/>",{"class":"vp_broadcast-stub_tx",html:L&&L<I?R.liveEndedText:R.liveUnstartedText}).appendTo(N);g("#"+H).replaceWith(F);if(G>I){var E=g("<div/>",{"class":"vp_broadcast-stub_time js-live-time",text:M(G,I)}).appendTo(N);var O=setInterval(function(){I=Date.now()+R.timeshift;if(G<I){clearInterval(O);u(R,J,H);return;}E.text(M(G,I));},1000);Q.data("startTimer",O.toString());}}function u(G,J,T){if(typeof G.flashvars.metadata==="string"){G.flashvars.metadata=JSON.parse(G.flashvars.metadata);}if(typeof G.flashvars.translations==="string"){G.flashvars.translations=JSON.parse(G.flashvars.translations);}var M=x.dash,E=x.mp4,F=x.flash.major>=10,K=!!(G.flashvars.metadata&&G.flashvars.metadata.metadataEmbedded),L=!!(G.flashvars.metadata&&G.flashvars.metadata.hlsMasterPlaylistUrl),H=!!(G.flashvars.metadata&&G.flashvars.metadata.liveDashManifestUrl),V=G.flashvars.metadata.liveStreamInfo,Q=g("#"+J),N=g("#"+T);function I(){try{t(G,T);}catch(X){m(J,null,null,true);}}function R(){if(E){k(G,T);}else{m(J,G.noFlashText,G.noFlashImage,true);}}function O(){if(M&&H){k(G,T);}else{P();}}function P(){if(!F){m(J,G.noFlashText,G.noFlashImage,true);}else{h(G,T);}}function S(){if(M){k(G,T);}else{if(!F){R();}else{h(G,T);}}}function U(){if(G.isIframePlayer){I();}else{if(G.isExternalPlayer||!G.isHtml5Player){P();}else{if(H||L){O();}else{if(K){S();}else{if(E){k(G,T);}else{P();}}}}}}function W(){var Y=parseInt(V.endTime,10),aa=Date.now()+G.timeshift;if(Y&&aa<Y){var Z=~~((parseInt(V.endTime,10)-aa)/1000);var X=setTimeout(function(){u(G,J,T);},Z*1000+3000);Q.data("endTimer",X.toString());}}if(q!==T){v();}if(G.isExternalPlayer&&window.__getMusicFlash){window.__getMusicFlash().lcPause();}q=T;y=J;p=G;if(!N.length){Q.hide();g("<div>",{id:T}).insertAfter(Q);}if(d(G)){V&&W();U();}else{o(G,J,T);}}function l(E){return E+"C";}function w(E){return E+"E";}function f(E,G,F){G=G||l(E.playerId);F=F||w(E.playerId);if(!E.timeshift){E.timeshift=E.timestamp?parseInt(E.timestamp,10)-Date.now():0;}if(!E.flashvars.metadata&&E.flashvars.metadataUrl){j(E.flashvars.metadataUrl).done(function(H){E.flashvars.metadata=H;delete E.flashvars.metadataUrl;u(E,G,F);}).error(function(){m(G,null,null,true);});}else{u(E,G,F);}}function v(){if(q&&y){g("#"+q).remove();g("#"+y).show();q=null;y=null;p={};}}function s(){return q?document.getElementById(q):null;}function z(){return q;}function e(){var E=s();return E&&E.isPlaying&&E.isPlaying();}function i(){return y;}function n(){return p;}function B(F){var E=s();if(E&&E.call){E.call(F);}}function C(G,H,I,E,F){r(G,F).always(function(J){J=J||{flashvars:{}};J.playerId=H||J.playerId||null;J.width=I||J.width||null;J.height=E||J.height||null;if(window.odklMusic&&window.odklMusic.playingTrack()){J.flashvars.silent="1";}if(J.error||!J.url){var K=m(l(J.playerId),J.error).css("display","block");J.width&&K.width(J.width);J.height&&K.height(J.height);}else{f(J);}});}function c(K){var Q=g(K),G=Q.data("playerContainerId"),F=Q.data("playerElementId"),S=Q.data("options"),R=Q.data("autostart"),P=Q.data("viewportTimeout"),M=Q.data("viewportDisabledIfMusic"),E=Q.data("hoverTimeout"),I=Q.data("hoverDisabledIfMusic"),J=Q.data("isBannerVideo");S.timeshift=S.timestamp?parseInt(S.timestamp,10)-Date.now():0;if(J){var L,N=Q.closest(".js-banner-wrapper-pointer");if(N.length){L=g("#"+N.data("bannerWrapperId"));}else{L=Q.closest(".js-banner-wrapper");}if(L.length){var O=L.children(".adv-px");if(O.length){var H={};O.each(function(){var U=g(this),T=U.data("type"),V=U.data("src");if(typeof H[T]==="undefined"){H[T]=[];}H[T].push(V);});S.flashvars.pixels=H;}}}if(!Q.find("#"+G).length){g("<div>",{id:G,"class":"vid-card_cnt_w"}).css({width:"100%",height:"100%"}).append(g("<i>",{"class":"vid_play"})).appendTo(Q);}Q.find("#"+G).on("click",function(T){T.preventDefault();f(g.extend(true,{},S),G,F);});if(R){f(g.extend(true,{},S),G,F);}if(P&&!S.isExternalPlayer){require(["OK/VideoAutoplayFlow"],function(T){T.activateViewportPlayer(g.extend(true,{},S),G,F,P,M);});}if(E){require(["OK/VideoAutoplayFlow"],function(T){T.activateHoverPlayer(g.extend(true,{},S),G,F,E,I);});}}function b(G){var F=g(G),K=F.data("playerContainerId"),J=F.data("viewportTimeout"),H=F.data("hoverTimeout"),L=g("#"+K),I=parseInt(L.data("startTimer"),10),E=parseInt(L.data("endTimer"),10);if(J||H){require(["OK/VideoAutoplayFlow"],function(M){M.deactivateHoverPlayer(K);M.deactivateViewportPlayer(K);});}if(I||E){clearInterval(I);clearTimeout(E);}}return{activate:c,deactivate:b,createMusicPreview:C,start:f,stop:v,getPlayer:s,getPlayerId:z,getContainerId:i,getOptions:n,isPlaying:e,callPlayer:B,createPlayerContainerId:l,createPlayerElementId:w};});