define(["OK/utils/utils","OK/capture"],function(b,c){function a(l,i,m){var k=this.list,j=k.lastChild;if(m.getResponseHeader("fetchedAll")==="true"){this.deactivate();}if(l===null||l.length===0){this.hookElement.classList.remove("in-progress");this.loading=false;return;}k.insertAdjacentHTML("beforeend",l);var h=j.nextSibling;while(h!==null){c.activate(h);h=h.nextSibling;}this.page=this.page+1;this.hookElement.classList.remove("in-progress");this.loading=false;}function e(){if(window.pageYOffset!==undefined){return window.pageYOffset;}return document.documentElement.scrollTop;}function d(){var h=document.body,i=document.documentElement;return Math.max(h.scrollHeight,h.offsetHeight,i.clientHeight,i.scrollHeight,i.offsetHeight);}var g=function(){this.loading=false;};function f(){return e()>d()-document.documentElement.clientHeight-100;}g.prototype={handleEvent:function(){if(!this.loading&&f()){this.loading=true;this.hookElement.classList.add("in-progress");var l={"st.page":this.page,fetch:false},k=this.list.lastChild,i=this.url,m=this.dynamicParams,h,j;if(m.length){for(h=0;h<m.length;h+=1){j=m[h];l[j]=k.getAttribute(j);}}b.ajax({type:"GET",url:i,data:l}).done(a.bind(this));}},activate:function(h){this.hookElement=h;this.list=this.hookElement.firstChild;this.url=this.hookElement.getAttribute("data-url");this.dynamic=this.hookElement.getAttribute("data-dynamic");this.dynamicParams=this.dynamic?this.dynamic.split(","):[];this.page=2;window.addEventListener("scroll",this,false);},deactivate:function(){window.removeEventListener("scroll",this,false);}};return g;});