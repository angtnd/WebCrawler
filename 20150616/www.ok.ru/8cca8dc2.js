define(["jquery","OK/utils/throttle"],function(c,j){var a="__loading",i="__playing",g="gif_video",d="gif_preview",b="gif_cnt",h="photo.gif";var f=[];var e=function(k){this.autoplay=k.getAttribute("data-autoplay")==="true";this.nostop=k.getAttribute("data-nostop")==="true";this.inMessages=k.getAttribute("data-messages")==="true";this.hoverOnParent=k.getAttribute("data-hoverOnParent")==="true";this.element=k;this.el=c(k);if(this.autoplay){if(this.nostop){this.play();}else{this.playOrStop();}}else{(this.hoverOnParent?this.el.parent():this.el).on("mouseenter.gif",this.play.bind(this)).on("mouseleave.gif",this.stop.bind(this));}};e.prototype={deactivate:function(){(this.hoverOnParent?this.el.parent():this.el).off(".gif");},playOrStop:function(){if(!this.autoplay){return;}var n=c(window),q=n.scrollTop(),m=q+n.height(),l=this.el.offset().top,o=l+this.el.height(),k=(l>=q&&l<=m)||(o>=q&&o<=m),p=this.el.hasClass(i)||this.el.hasClass(a);if(k&&!p){this.play();}else{if(!k&&p&&!this.nostop){this.stop();}}},play:function(){var l=this.el.attr("data-mp4Src"),o=this.el.attr("data-webmSrc"),s=this.el.attr("data-width"),p=this.el.attr("data-height"),q=this.el.attr("data-style"),w=this.el.attr("data-imageSrc"),u=this.el.attr("data-gifSrc"),v=this;var r=window.document.createElement("video");var k=false,n=false,t=false;if(r&&typeof r.canPlayType==="function"){k=r.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"').length>0;n=r.canPlayType("video/webm").length>0;}r=c(r);this.startTime=Date.now();if(k&&l!=null||n&&o!=null){r.attr("width",s);r.attr("height",p);r.attr("class",g);r.attr("style",q);r.attr("loop","true");r.on({"canplay.gif":function(){r.get(0).play();if(!t){OK.logging.logger.duration(h,Math.max(Date.now()-v.startTime,0),"video_start");}},"playing.gif":function(){v.el.addClass(i);v.el.removeClass(a);if(!t){t=true;OK.logging.logger.duration(h,Math.max(Date.now()-v.startTime,0),"video_play");}},"error.gif":function(){this.stop(true);OK.logging.logger.success(h,"video_fail");}.bind(this)});r.attr("src",k&&l||n&&o);r.attr("poster",w);c("."+b,this.el).append(r);this.el.addClass(a);r.get(0).load();r.get(0).play();OK.logging.logger.success(h,"video_load");}else{c("."+d,this.el).attr("src",u);var m=new Image();m.src=u;m.onload=function(){v.el.removeClass(a).addClass(i);OK.logging.logger.duration(h,Math.max(Date.now()-v.startTime,0),"gif_play");};m.onerror=function(){v.stop(true);OK.logging.logger.success(h,"gif_fail");};if(!m.complete){this.el.addClass(a);}else{this.el.removeClass(a).addClass(i);}OK.logging.logger.success(h,"gif_load");}},stop:function(k){var m=c("."+g,this.el),l=m.length>0;m.off(".gif");this.el.removeClass(a);this.el.removeClass(i);m.remove();c("."+d,this.el).attr("src",this.el.attr("data-imageSrc"));if(!k){OK.logging.logger.duration(h,Math.max(Date.now()-this.startTime,0),l?"video_stop":"gif_stop");}},updateDimensions:function(l,k){var m=this;var n=function(){var o=c(this);var p=parseInt(m.el.attr("data-width"));var r=parseInt(m.el.attr("data-height"));var q=Math.max(1,Math.max(p/l,r/k));o.attr("width",Math.round(p/q));o.attr("height",Math.round(r/q));};c("."+d,this.el).each(n);c("."+g,this.el).each(n);}};return{activate:function(l){var k=this;if(f.length===0){c(window).on("scroll.gif",j(500,function(){k.scroll(false);}));}f.push(new e(l));},deactivate:function(l){var k=0;for(;k<f.length;++k){if(f[k].element===l){f[k].deactivate();f.splice(k,1);break;}}if(f.length===0){c(window).off("scroll.gif");}},add:function(n,k){var l=n.getAttribute("data-id"),o=n.getAttribute("data-type"),m=n.getAttribute("data-tkn");if(k===true){c("#clonePhoto").addClass("invisible");c("#clonePhotoDone").removeClass("invisible");}else{c(n).closest("div.ovr-menu_soh").addClass("__success");}c.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:"/web-api/photo/add",timeout:60000,data:JSON.stringify({photoId:l,type:o,tkn:m})});},scroll:function(l){for(var k=0;k<f.length;++k){if(f[k].inMessages===l){f[k].playOrStop();}}},stopInMessagesGifs:function(){for(var k=0;k<f.length;++k){if(f[k].inMessages){f[k].stop();}}},updateDimensions:function(m,n,k){for(var l=0;l<f.length;++l){if(f[l].element===m){f[l].updateDimensions(n,k);break;}}}};});