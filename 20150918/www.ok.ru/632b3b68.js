define(["jquery","OK/utils/throttle"],function(d,k){var b="__loading",j="__playing",h="gif_video",e="gif_preview",c="gif_cnt",i="photo.gif",a="photo.gif.inplace";var g=[];var f=function(l){this.autoplay=l.getAttribute("data-autoplay")==="true";this.nostop=l.getAttribute("data-nostop")==="true";this.inMessages=l.getAttribute("data-messages")==="true";this.playOnParent=l.getAttribute("data-playOnParent")==="true";this.autoplayType=parseInt(l.getAttribute("data-autoplayType")||"0",10);this.location=l.getAttribute("data-location")||"u";this.element=l;this.el=d(l);if(this.autoplay){if(this.nostop){this.play();}else{this.playOrStop();}}else{(this.playOnParent?this.el.parents("div.js-gifPlay"):this.el.parent()).on("mouseenter.gif",d.proxy(this.play,this)).on("mouseleave.gif",d.proxy(this.stop,this));}};f.prototype={deactivate:function(){(this.playOnParent?this.el.parents("div.js-gifPlay"):this.el.parent()).off(".gif");},playOrStop:function(){if(!this.autoplay){return;}var n=d(window),t=n.scrollTop(),l=t+n.height(),m=this.el.offset().top,r=m+this.el.height(),s=(m+r)/2,u=m>=t&&m<=l,p=r>=t&&r<=l,o=s>=t&&s<=l,q=false;isPlaying=this.el.hasClass(j)||this.el.hasClass(b);switch(this.autoplayType){case 0:q=u||p;break;case 1:q=u&&p;break;case 2:q=o;break;}if(q&&!isPlaying){this.play();}else{if(!q&&isPlaying&&!this.nostop){this.stop();}}},play:function(){var u,l=false,p=false,w=false,n=this.el.attr("data-mp4Src"),q=this.el.attr("data-webmSrc"),t=this.el.attr("data-width"),r=this.el.attr("data-height"),s=this.el.attr("data-style"),z=this.el.attr("data-imageSrc"),y=this.el.attr("data-gifSrc"),m=this.el.attr("data-preferWebm"),v=this.location,x=this;if(!this.skipMp4||!this.skipWebm){u=window.document.createElement("video");if(u&&typeof u.canPlayType==="function"){l=!this.skipMp4&&u.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"').length>0;p=!this.skipWebm&&u.canPlayType("video/webm").length>0;}u=d(u);}this.startTime=Date.now();if(l&&n!=null||p&&q!=null){u.attr("width",t);u.attr("height",r);u.attr("class",h);u.attr("style",s);u.attr("loop","true");u.on({"canplay.gif":function(){u.get(0).play();if(!w){OK.logging.logger.duration(i,Math.max(Date.now()-x.startTime,0),"video_start",v);}},"playing.gif":function(){x.el.addClass(j);x.el.removeClass(b);if(!w){w=true;OK.logging.logger.duration(i,Math.max(Date.now()-x.startTime,0),"video_play",v);OK.logging.logger.success(a,v,x.autoplay?"a":"m");}},"error.gif":function(){var A="und";var B=u.get(0);this.stop(true);if(B.error&&B.error.code){if(l){this.skipMp4=true;A="mp4";}else{if(p){this.skipWebm=true;A="webm";}}OK.logging.logger.success(i,"video_fail_"+A+"_"+B.error.code,v);this.play();}else{OK.logging.logger.success(i,"video_fail_"+A,v);}}.bind(this)});u.attr("src",m?p&&q||l&&n:l&&n||p&&q);u.attr("poster",z);d("."+c,this.el).append(u);this.el.addClass(b);u.get(0).load();u.get(0).play();OK.logging.logger.success(i,"video_load",v);}else{d("."+e,this.el).attr("src",y);var o=new Image();o.src=y;o.onload=function(){x.el.removeClass(b).addClass(j);OK.logging.logger.duration(i,Math.max(Date.now()-x.startTime,0),"gif_play",v);OK.logging.logger.success(a,v,x.autoplay?"a":"m");};o.onerror=function(){x.stop(true);OK.logging.logger.success(i,"gif_fail",v);};if(!o.complete){this.el.addClass(b);}else{this.el.removeClass(b).addClass(j);}OK.logging.logger.success(i,"gif_load",v);}},stop:function(l){var n=d("."+h,this.el),m=n.length>0;n.off(".gif");this.el.removeClass(b);this.el.removeClass(j);n.remove();d("."+e,this.el).attr("src",this.el.attr("data-imageSrc"));if(!l){OK.logging.logger.duration(i,Math.max(Date.now()-this.startTime,0),m?"video_stop":"gif_stop",this.location);}},updateDimensions:function(m,l){var n=this;var o=function(){var p=d(this);var q=parseInt(n.el.attr("data-width"),10);var s=parseInt(n.el.attr("data-height"),10);var r=Math.max(1,Math.max(q/m,s/l));p.attr("width",Math.round(q/r));p.attr("height",Math.round(s/r));};d("."+e,this.el).each(o);d("."+h,this.el).each(o);}};return{activate:function(m){var l=this;if(g.length===0){d(window).on("scroll.gif",k(500,function(){l.scroll(false);}));}g.push(new f(m));},deactivate:function(m){var l=0;for(;l<g.length;++l){if(g[l].element===m){g[l].deactivate();g.splice(l,1);break;}}if(g.length===0){d(window).off("scroll.gif");}},add:function(p,l){var m=p.getAttribute("data-id"),q=p.getAttribute("data-type"),o=p.getAttribute("data-tkn"),n=p.getAttribute("data-comment-id");if(l===true){d("#clonePhoto").addClass("invisible");d("#clonePhotoDone").removeClass("invisible");}else{d(p).closest("div.ovr-menu_soh").addClass("__success");}d.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:"/web-api/photo/add",timeout:60000,data:JSON.stringify({photoId:m,type:q,tkn:o,cmtId:n})});},scroll:function(m){for(var l=0;l<g.length;++l){if(g[l].inMessages===m){g[l].playOrStop();}}},stopInMessagesGifs:function(){for(var l=0;l<g.length;++l){if(g[l].inMessages){g[l].stop();}}},updateDimensions:function(n,o,l){for(var m=0;m<g.length;++m){if(g[m].element===n){g[m].updateDimensions(o,l);break;}}}};});