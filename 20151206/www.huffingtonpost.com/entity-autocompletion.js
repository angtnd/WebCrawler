define(function(require){require("lib/fetch");var inputQuery=null;var suggestions=null;var insee=null;var searchTerm="";var previousSearchTerm="";var previousResultsCount=-1;var lastFetchTime=-1;var timeBetweenFetches=300;var searchInProgress=false;var entityTypeLabels={region:"R\u00e9gions",departement:"D\u00e9partements",commune:"Communes"};var selectedCategory="";var maxEntityPerType=20;var termRegex=/\w{2,50}/i;var fetchBaseUrl="/search/geo_entity/?s=";var handleEvent=function(event){searchTerm=
event.target.value;if(searchInProgress)return;if(previousResultsCount===0&&searchTerm.indexOf(previousSearchTerm)===0)return;if(!searchTerm.match(termRegex)){suggestions.innerHTML="";previousSearchTerm="";previousResultsCount=-1;return}if(Date.now()-lastFetchTime<timeBetweenFetches)return;searchInProgress=true;fetch(fetchBaseUrl+searchTerm,{headers:{"Content-Type":"application/json"}})["then"](processSearchResults)["catch"](function(){suggestions.innerHTML="Une erreur s\u2019est produite, veuillez r\u00e9essayer ult\u00e9rieurement.";
searchInProgress=false})};var processSearchResults=function(response){if(!response.ok){var err=new Error(response.statusText);err.response=response;throw err;}return response.json().then(function(data){suggestions.innerHTML="";suggestions.appendChild(extractEntities(data));suggestions.style.display="block";previousSearchTerm=searchTerm;previousResultsCount=suggestions.childNodes.length;lastFetchTime=Date.now();searchInProgress=false})};var extractEntities=function(data){var fragment=document.createDocumentFragment();
var type="";var entities=null;var entity=null;var list=null;var li=null;var index=0;var length=0;var a=null;list=initList();for(type in data)if(data.hasOwnProperty(type)){list.appendChild(initHeader(type));entities=data[type];length=entities.length<maxEntityPerType?entities.length:maxEntityPerType;for(index=0;index<length;index++){entity=entities[index];a=document.createElement("a");a.href=entity.link;a.name=entity.codeInsee;a.title=type;a.innerHTML=entity.name;li=document.createElement("li");li.className=
"ui-menu-item";li.appendChild(a);list.appendChild(li)}fragment.appendChild(list)}return fragment};var initList=function(){var list=document.createElement("ul");list.className="ui-autocomplete ui-front ui-menu ui-widget ui-widget-content ui-corner-all";list.setAttribute("style","width: 259px; top: 0px; left: 0.5px;");return list};var initHeader=function(entityType){var head;var div;var strong;head=document.createElement("li");head.setAttribute("style","padding: 8px 0");div=document.createElement("div");
strong=document.createElement("strong");strong.innerHTML=entityTypeLabels[entityType];div.appendChild(strong);head.appendChild(div);return head};return{addListener:function(eltId,eltHidden,entityType,eltSubmit){if(!entityType||!eltHidden||!eltId)return false;selectedCategory=document.getElementById(entityType);insee=document.getElementById(eltHidden);inputQuery=document.getElementById(eltId);suggestions=document.getElementById(eltId+"-suggestions");suggestions.addEventListener("click",function(event){if(event.target.nodeName===
"A"){event.preventDefault();inputQuery.value=event.target.innerHTML;insee.value=event.target.name;selectedCategory.value=event.target.title;suggestions.style.display="none";if(eltSubmit&&event.target.href)window.open(event.target.href,"_blank")}});if(eltSubmit){eltSubmit=document.getElementById(eltSubmit);eltSubmit.addEventListener("click",function(event){event.preventDefault();var urlDest=[window.location.protocol,"://",window.location.hostname,"/carte-departements/"].join("");window.open(urlDest,
"_blank")})}inputQuery.addEventListener("input",handleEvent);return true}}});
