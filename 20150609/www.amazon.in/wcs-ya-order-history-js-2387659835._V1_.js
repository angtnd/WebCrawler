var wcs=wcs||{};
wcs.metrics=wcs.metrics||{};
wcs.metrics.forester=(function(module){var SCHEME="https://";
var WCS_FEATURE_NAME_PATH="/1/action-impressions/1/OP/wcs/action/wcs_:";
var CLOCK_STRING_GENERATOR={generate:function(){return new Date().getTime();
}};
var IMAGE_BASED_URL_LOADER={load:function(url){new Image().src=url;
}};
var WEBLAB_VALUE_REGEX=/^C|T[1-9]$/;
module.globalUeObject=function(){var ue=window.ue||undefined;
return ue;
};
module.standardRecorder=function(){return module.recorder(module.globalUeObject(),WCS_FEATURE_NAME_PATH,CLOCK_STRING_GENERATOR,IMAGE_BASED_URL_LOADER);
};
module.weblabRecorder=function(weblabValue){return module.recorder(module.globalUeObject(),WCS_FEATURE_NAME_PATH,CLOCK_STRING_GENERATOR,IMAGE_BASED_URL_LOADER,weblabValue);
};
module.recorder=function(ue,featureNamePath,uniqueStringGenerator,urlLoader,weblabValue){var recorder_={};
var weblabParams=weblabQueryStringParams(validatedWeblabValue(weblabValue));
recorder_.recordCount=function(metricName,count){count=validatedCount(count);
if(count===0){return;
}if(ueIsTooIncompleteToUse(ue)){return;
}var foresterAuthority=ue.furl;
var ueQueryParameters="?marketplaceId="+ue.mid+"&requestId="+ue.rid+"&session="+ue.sid+"&marketplace="+ue.sn;
var foresterPath=SCHEME+foresterAuthority+featureNamePath+metricName+metadataSuffixFor(count);
var preventBrowserCachingResponse="&_="+uniqueStringGenerator.generate();
var foresterUrl=foresterPath+ueQueryParameters+weblabParams+preventBrowserCachingResponse;
urlLoader.load(foresterUrl);
};
return recorder_;
};
function weblabQueryStringParams(weblabValue){if(!weblabValue){return"";
}return"&class=weblab&instance="+weblabValue;
}function ueIsTooIncompleteToUse(ue){return typeof ue==="undefined"||!ue.furl||!ue.mid||!ue.rid||!ue.sid||!ue.sn;
}function validatedCount(count){count=(typeof count==="undefined"?1:count);
if(count<0){throw new Error("Negative counts are invalid but got "+count);
}return count;
}function validatedWeblabValue(weblabValue){return WEBLAB_VALUE_REGEX.exec(weblabValue);
}function metadataSuffixFor(count){return count===1?"":"@v="+count;
}return module;
}(wcs.metrics.forester||{}));
amznJQ.declareAvailable("wcs-forester-metrics");
var isAjaxAvailable=function(){try{var canThisBeCreated=window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest();
}catch(e){return 0;
}return 1;
};
amznJQ.declareAvailable("wcs-ya-order-history-js-isAjaxAvailable");
jQuery.fn.makeAjaxLinks=function(callerSettings){var settings=jQuery.extend({loader:"<div>Loading...</div>",retry:'<span>An error occurred.  Please <a href="#">try again</a></span>',clickFunction:function(){},eachFunction:function(index,item){}},callerSettings);
return this.filter(function(){var jq_this=jQuery(this);
return jq_this.is("a")&&!jq_this.data("AjaxLink");
}).one("click",settings.clickFunction).each(function(index){var jq_this=jQuery(this);
if(!jq_this.data("AjaxLink")){var loader=jQuery(settings.loader).insertAfter(jq_this);
var retry=jQuery(settings.retry).find("a").click(function(event){event.preventDefault();
settings.clickFunction.apply(jq_this,arguments);
}).end().insertAfter(jq_this);
var api={retryCount:0,showRetry:function(newRetryMessage,newErrorMessage){retry.show();
},hideRetry:function(newRetryMessage,newErrorMessage){retry.hide();
},showLoader:function(newRetryMessage,newErrorMessage){loader.show();
},hideLoader:function(newRetryMessage,newErrorMessage){loader.hide();
}};
jq_this.data("AjaxLink",api);
}settings.eachFunction(index,this);
}).end();
};
amznJQ.declareAvailable("wcs-ya-order-history-js-makeAjaxLinks");
amznJQ.onReady("wcs-ya-order-history-js-makeAjaxLinks",function(){var TrackButton=function(track_button,track_window,track_links,options,recorder){this.settings=jQuery.extend({find_track_enabled_button:function(trackButton){return trackButton.track_button.children("span.enabled");
},find_track_disabled_button:function(trackButton){return trackButton.track_button.children("span.disabled");
},find_track_close_button:function(trackButton){return trackButton.track_window.find(".track-close");
},create_loading_element:function(){return"<div>Retrieving package information... </div>";
},create_retry_element:function(){return'<span>An error occurred. Please <a href="#">try again</a></span>';
},create_error_message:function(){return"<span>An error occurred.  Please try again in a few minutes.</span>";
},max_retry_attempts:3},options);
this.track_window=track_window;
this.ajaxOnOpen=true;
this.showing=false;
this.track_button=track_button;
this.track_close_btn=this.settings.find_track_close_button(this);
this.track_disabled=this.settings.find_track_disabled_button(this);
this.track_enabled=this.settings.find_track_enabled_button(this);
this.track_links=track_links;
this.shipment=this.track_window.parents("div.ship-listing:first").prev();
this.reftagSuffix=track_button.attr("data-ref-suf");
this.recorder=recorder;
this.status=this.track_window.find("#ship-status").text();
this.addFunctionality();
};
jQuery.extend(TrackButton.prototype,{addFunctionality:function(){var self=this;
this.track_button.click(function(event){event.preventDefault();
self.showTrackingWindow();
var trackTop=self.shipment.offset().top-20;
var jqBody=jQuery("body");
if(jqBody.scrollTop()>trackTop){jqBody.animate({scrollTop:trackTop},400);
}});
this.track_close_btn.click(function(event){event.preventDefault();
event.stopPropagation();
self.hideTrackingWindow();
});
var first_track_window=this.track_window.find(".close-tracking").get(0);
jQuery(first_track_window).append(this.track_close_btn.show());
this.createRetryLinks();
},processOrderRequestResult:function(trackingLink,trackingData){var badResponse=typeof trackingData=="undefined";
trackingLink.data("AjaxLink").hideLoader();
var containerDiv;
if(badResponse){var ajaxLink=trackingLink.data("AjaxLink");
ajaxLink.retryCount++;
if(ajaxLink.retryCount<this.settings.max_retry_attempts){ajaxLink.showRetry();
return;
}else{trackingData=jQuery(this.settings.create_error_message());
containerDiv=this.track_window.find("div.loader");
}}else{containerDiv=trackingLink.parents(".track-package-parent");
trackingData=jQuery('<div style="position:relative">'+trackingData.html+"</div>");
}if(trackingLink.get(0)===this.track_links.get(0)){trackingData.find(".close-tracking").append(this.track_close_btn.show());
}trackingData.find(".tracking-page-link").append(containerDiv.find("a.complete-tracking"));
trackingData.find("a.reloader").click(function(e){e.preventDefault();
window.location.reload();
});
containerDiv.html("").prepend(trackingData);
},getTrackingData:function(trackingLink){var self=this;
jQuery.ajax({url:trackingLink.attr("href"),dataType:"json",timeout:10000,cache:false,error:function(){self.processOrderRequestResult(trackingLink);
},success:function(data,textStatus){self.processOrderRequestResult(trackingLink,data,textStatus);
}});
},createRetryLinks:function(){var self=this;
this.track_links.makeAjaxLinks({clickFunction:function(){var jq_this=jQuery(this);
var ajaxLink=jq_this.data("AjaxLink");
ajaxLink.hideRetry();
ajaxLink.showLoader();
jq_this.hide();
self.getTrackingData(jq_this);
},loader:self.settings.create_loading_element(),retry:self.settings.create_retry_element()});
},click:function(){this.track_button.click();
},getWindow:function(){return this.track_window;
},showTrackingWindow:function(){if(this.showing){var self=this;
var elementToAnimate=this.track_window;
elementToAnimate.animate({opacity:0.4},function(){elementToAnimate.animate({opacity:1});
});
return;
}this.track_window.show();
this.showing=true;
this.recordMetric();
this.disableTrackButton(true);
if(this.ajaxOnOpen){this.track_links.click();
this.ajaxOnOpen=false;
}},recordMetric:function(){this.recorder.recordCount("ya_oh_track_inline_"+this.status+this.reftagSuffix);
},hideTrackingWindow:function(){if(!this.showing){return;
}this.track_window.hide();
this.showing=false;
this.enableTrackButton(true);
},disableTrackButton:function(notify){this.showing=true;
this.track_enabled.hide();
this.track_disabled.show();
if(notify){this.track_button.trigger("disableTrackButton");
}},enableTrackButton:function(notify){this.showing=false;
this.track_disabled.hide();
this.track_enabled.show();
if(notify){this.track_button.trigger("enableTrackButton");
}}});
jQuery.fn.makeTrackButton=function(callerSettings,recorder){var settings=jQuery.extend({getWindowAndLinks:function(track_button){var action=track_button.parents("div.status").next();
action=action.add(track_button.parents("div.ship-listing"));
var track_window=action.find(".track-window");
return{track_window:track_window,track_links:track_window.find("a.track-location")};
}},callerSettings);
return this.each(function(){var self=jQuery(this);
var elements=settings.getWindowAndLinks(self);
self.data("CSTrackButton",new TrackButton(self,elements.track_window,elements.track_links,settings,recorder));
});
};
amznJQ.declareAvailable("wcs-ya-order-history-js-makeTrackButton");
});
jQuery.fn.makeConfirmItemButton=function(){var confirmItemRelatedButtons={};
var submitConfirmItem=function(destination){jQuery.ajax({url:destination,dateType:"json",timeout:2000,cache:false,success:function(result){}});
};
this.each(function(){var button=jQuery(this);
var destination=button.attr("href");
var key=destination.match(/\?.*/);
if(confirmItemRelatedButtons[key]===undefined){confirmItemRelatedButtons[key]=[];
}confirmItemRelatedButtons[key].push(button);
button.click(function(event){event.preventDefault();
submitConfirmItem(destination);
var relatedButtons=confirmItemRelatedButtons[key];
jQuery(relatedButtons).each(function(){if(jQuery.browser.msie&&jQuery.browser.version<7){this.hide();
}else{this.slideUp(500);
}});
});
});
};
amznJQ.declareAvailable("wcs-ya-order-history-js-makeConfirmItemButton");
jQuery(function(){if(yoJS.settings["YA_YO_SEARCH_NAV_REDESIGN_25361"]){jQuery("#orderFilter").change(function(){jQuery("#order-dropdown-form").submit();
});
}amznJQ.onReady("wcs-ya-order-history-js-makeTrackButton",function(){amznJQ.onReady("wcs-forester-metrics",function(){var recorder=wcs.metrics.forester.standardRecorder();
jQuery(".order-bar").each(function(){var shipmentCount=0;
var trackButtons=jQuery([]);
jQuery(this).find(".ship-contain").each(function(){trackButtons=trackButtons.add(jQuery(this).find("a.track").makeTrackButton({create_loading_element:function(){var tag=yoJS.images["loading_small"];
jQuery(tag).hide().appendTo(document.body).hide();
return"<div>"+yoJS.strings["retrieving-tracking-information"]+tag+"</div>";
},create_retry_element:function(){return"<span>"+yoJS.strings["ajax_retry_message"]+"</span>";
},create_error_message:function(){return"<span>"+yoJS.strings["tracking_error_message"]+"</span>";
}},recorder));
++shipmentCount;
if(shipmentCount>1){(function(trackList){shipmentCount=0;
trackList.bind("disableTrackButton",function(){trackList.each(function(){jQuery(this).data("CSTrackButton").disableTrackButton();
});
}).bind("enableTrackButton",function(){trackList.each(function(){jQuery(this).data("CSTrackButton").enableTrackButton();
});
});
}(trackButtons));
trackButtons=jQuery([]);
}});
});
});
});
jQuery("a.item-toggler").click(function(event){event.preventDefault();
event.stopPropagation();
jQuery(this).parents(".order-bar").find(".hidden-item").show();
jQuery(this).parents("li.more:first").remove();
});
var toggleCheckbox=jQuery("input.digital-toggle");
toggleCheckbox.click(function(){toggleCheckbox.attr("disabled",true);
var newLocation=toggleCheckbox.attr("data-toggle-url");
if(newLocation){window.location=newLocation;
}});
if((""+toggleCheckbox.attr("data-start-state"))!==(""+toggleCheckbox.is(":checked"))){toggleCheckbox.click();
}amznJQ.available("popover",function(){amznJQ.onReady("wcs-forester-metrics",function(){var recorder=wcs.metrics.forester.standardRecorder();
jQuery(".info-data.recipient").each(function(){var self=jQuery(this);
var popoverContents="";
var count=0;
self.parents(".order-details").find(".address").each(function(){popoverContents+=jQuery(this).html();
count++;
});
var addressStr=count==1?yoJS.strings["dsv-singular-address"]:yoJS.strings["addresses"];
self.amazonPopoverTrigger({literalContent:popoverContents,width:300,showOnHover:true,title:addressStr,closeEventInclude:"CLICK_OUTSIDE",onShow:function(){recorder.recordCount("ya_oh_rcpnt_addr_pop");
}});
});
jQuery(".displayDNRworkflow").each(function(){var self=jQuery(this);
var ajaxUrl=self.find("a:first").attr("data-dnr_popover_link");
self.amazonPopoverTrigger({destination:ajaxUrl,width:400,showOnHover:true,align:"right",closeEventInclude:["CLICK_TRIGGER","CLICK_OUTSIDE"],onShow:function(){recorder.recordCount("ya_oh_dnr_pop");
}});
});
});
jQuery(".item-action-button").each(function(){var self=jQuery(this);
var content=self.next();
content.find("a").click(function(e){self.click();
});
self.amazonPopoverTrigger({locationOffset:[0,-30],width:330,localContent:content,showOnHover:true,title:yoJS.strings["available_actions"],closeEventInclude:["CLICK_TRIGGER","CLICK_OUTSIDE"]});
});
if(yoJS.settings["purchase-delegation"]){var accountSelectionPopoverContents=jQuery("#account-select-popup-container").html();
jQuery("a.account-select-change").each(function(){var self=jQuery(this);
self.amazonPopoverTrigger({literalContent:accountSelectionPopoverContents,onShow:function(popover){popover.find("a.account-select-link").click(function(event){event.preventDefault();
var form=jQuery("#account-select-dropdown-form");
form.find("#delegatedCustId").val(jQuery(this).attr("id"));
form.submit();
});
},width:null,closeEventInclude:"CLICK_OUTSIDE",paddingBottom:1});
});
}var trackingInfoPopoverContents=jQuery(".tracking-why-container").html();
jQuery(".tracking-why-hover").each(function(){var self=jQuery(this);
self.amazonPopoverTrigger({literalContent:trackingInfoPopoverContents,showOnHover:true,title:yoJS.strings["tracking-help"],closeEventInclude:"CLICK_OUTSIDE"});
});
var honorSystemWhyPopoverContents=jQuery(".honor-system-why-container").html();
jQuery(".honor-system-why-hover").each(function(){var self=jQuery(this);
self.amazonPopoverTrigger({literalContent:honorSystemWhyPopoverContents,showOnHover:true,closeEventInclude:"CLICK_OUTSIDE"});
});
jQuery(".displayPopup").each(function(){var self=jQuery(this);
self.amazonPopoverTrigger({literalContent:self.next(".displayPopupContent").html(),width:400,showOnHover:true,align:"right",closeEventInclude:["CLICK_TRIGGER","CLICK_OUTSIDE"]});
});
if(yoJS.settings["YO_VAS_SHOW_POS_30763"]){jQuery(".show_pos_button").each(function(event){jQuery(this).click(function(event){event.preventDefault();
event.stopPropagation();
var url=event.target.parentElement.href;
jQuery.AmazonPopover.displayPopover({width:900,height:800,title:yoJS.strings["pos_image_header"],locationOffset:[75,0],draggable:false,modal:true,cacheable:false,location:"centered",closeEventExclude:"CLICK_OUTSIDE",skin:"default",destination:url});
});
});
}});
if(yoJS.settings["enable_ACTIONS_LEAVE_CONFIRM_ARRIVAL_FEEDBACK"]){var self=this;
amznJQ.onReady("wcs-ya-order-history-js-makeConfirmItemButton",function(){jQuery(self).find("a.confirm-item-arrival").makeConfirmItemButton();
});
}});
amznJQ.declareAvailable("wcs-ya-order-history-js");
