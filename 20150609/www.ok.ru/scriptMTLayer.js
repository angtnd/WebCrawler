OK.mtLayer=(function(){var ae,ak=null,Q=null,c="mtLayer",T="mtLayerMain",ai="mtLayerBack",f="mtLayerForward",ad="scrollToTopMtLayer",e="media-layer media-layer__topic grid",J="media-layer_hld",l="mlr_disc",X="media-layer_close",P="media-layer_close_ico",k="sticky-plank_cnt",C="media-layer_fixer",ao=310,aq=null,aj=null,n=null,p=null,U=null,Y=null,v=null,af=null,M=null,ag=1145,w={id:null,to:75},E="MediaTopicLayerBody";var x=false;var A;var j;var O=false;function r(at){if(N()){if(!O&&aq[0]!=document.activeElement&&aq.find(document.activeElement).length==0){aq.focus();O=true;}var ax=aq.find(".__edit").length>0;if(ax){return;}var az=aq.find(".tag-box__editable").length>0;if(az){return;}var ay=$("#hook_Block_PopLayerOver").find("#hook_Modal_popLayerModal");var aw=ay.length>0&&!ay.hasClass("layer__disabled");if(aw){return;}var ar=$("#hook_Block_PopLayerPhotoWrapper").find("#photoLayerWrapper");var av=ar.length>0&&!ar.hasClass("layer__disabled")&&!ar.hasClass("invisible");if(av){return;}var t=$("#video-poplayer-cnt");var au=t.length>0&&!t.hasClass("layer__disabled")&&!t.hasClass("invisible");if(au){return;}if((at.keyCode===39)&&af){af.click();OK.stop(at);}else{if((at.keyCode===37)&&v){v.click();OK.stop(at);}}}}function y(ar){var t=ae.isActive!=ar;ae.isActive=ar;if(t){L();}else{if(ap()){S(false,true);}}OK.css.removeClass(document.getElementById("hook_Block_PopLayerMediaTopic"),"layer__disabled");}function W(t){if(t){OK.Layers.register(c,function(){a("cr_esc");},undefined,false,r);}else{OK.Layers.remove(c);}}function S(t,ar){OK.loader.use("OKCustomJs",function(){if(t){W(ar);}if(ar){if(OK.Layers.onLayerShown){OK.Layers.onLayerShown();}}else{if(OK.Layers.onLayerHidden){OK.Layers.onLayerHidden();}}});}function L(){S(true,ae.isActive);ac();o();}function R(t){var ar=ae.isProcess!=t;ae.isProcess=t;if(ar){o();}}function ah(t){aj.toggleClass("__process",t);}function ac(){$(document.body).toggleClass("__layer",!!ae.isActive);}function o(){var t=e;if(ae.isActive){t+=" __active";}if(ae.isProcess){t+=" __process";}if(ae.redesign){t+=" __redesign";}aq.attr("class",t);}function aa(at,t){var au=at.length,ar=au;while(--au+1){at[au].toggleClass(t);}setTimeout(function(){while(--ar+1){at[ar].toggleClass(t);}},1);}function F(){if(p){var t=0;$(".comments_i",p).each(function(){var ar=$(this).data("unread");if(ar){t=this.getBoundingClientRect().top;}return !ar;});aq.each(function(){this.scrollTop=(t!==0)?this.scrollTop+t:this.scrollHeight;});setTimeout(function(){$(".js-comments_add",p).focus();},50);}}function G(aw,at,av){var ar=$(window),t=ar.height(),au=ar.width();if(w.id){clearTimeout(w.id);}w.id=setTimeout(function(){aa([Y,af,v,M],C);w.id=null;an();},aw?0:w.to);aq.toggleClass("__compact",au<=ag);aq.toggleClass("__min-height",(t<ao));if(at){F();}if(av){Z(av);}an();}var ab;function an(t,ar){if(ae.redesign){return;}ar=ar||20;if(ar>0){if(U&&n){ab&&clearTimeout(ab);ab=setTimeout(function(){var at=n.outerWidth();U.css({width:at});U.parent().css({width:at});t!=at&&an(at,--ar);},50);}else{!n&&(n=aq.find("."+J));U=n.find("."+k);an(undefined,--ar);}}}function I(t){if(x){return;}x=true;ak=$(window);Q=$(document.body);aq=$("#"+c);aj=$("#"+T);v=$("#"+ai);af=$("#"+f);M=$("#"+ad);ae={isActive:aq.hasClass("__active"),isProcess:aq.hasClass("__process")};n=aq.find("."+J);Y=n.find("."+X);Y.click(function(au){var at="cr_shadow";var ar=OK.eventTarget(au);if($(ar).hasClass(P)){at="cr_close";}a(at);});if(ae.isActive){L();if(!ae.isProcess){G(true,t);}}if(t){F();}ak.on("resize.mtLayer",function(){G();});}var i;var H;var B;function K(ar){if(OK.historyManager.isHistorySupported()){var at=ar.indexOf("?");if(at>0){B=ar.substr(at+1);H=ar.substr(0,at);if(B.length>0){B+="&mt.scrollTop="+$(window).scrollTop();}else{B=null;}q(H,B);}else{H=ar;B=null;}var au=h()==H&&!j;var t;if(!i){if(au){t=true;}else{if(j){am(j,true);}}i=h();}else{if(ae.closeTopicId){t=false;}else{t=true;}}j="";if(!au){am(H,t);}}}function z(){if(!i&&H==h()){am(i,true);}i=null;H=null;B=null;}function h(){return OK.historyManager.getState();}function am(ar,t){if(t){OK.historyManager.replaceState(ar);}else{OK.historyManager.pushState(ar);}}function q(ar,t){if(t==null||t.length==0){return;}OK.historyManager.putItemToCache(ar,t);}function N(){return ae.isActive&&!$("#hook_Block_PopLayerMediaTopic").hasClass("layer__disabled");}function ap(){return ae.isActive&&$("#hook_Block_PopLayerMediaTopic").hasClass("layer__disabled");}function a(av){O=false;ae.topicId=null;ae.owner=null;var au=ae.closeTopicId;var t=ae.closeOwnerType;ae.closeTopicId=null;ae.closeOwnerType=null;if(au&&(av=="cr_esc"||av=="cr_shadow"||av=="cr_close"||av=="cr_fail")){if(av){m(av+"_ct");}setTimeout(function(){if(OK.historyManager.isHistorySupported()){OK.historyManager.back();}else{OK.mtLayer.showTopicInLayer(au,t,"");}},0);return;}var at=N();var ar=false;if(at){if(i&&H==h()){if(i==H){ar=true;OK.historyManager.back();}else{am(i,true);}}}if(!ar){y(false);R(false);ah(false);b();V();M.removeClass("__active __animated");OK.hookModel.setHookContent(E,"");}i=null;if(av){m(av);}aq.trigger("mtLayer.close");}function m(t){OK.logger.success("mtlayer",A||"",t);}function b(){v.toggleClass("__active",false);af.toggleClass("__active",false);}function s(t,ar){if(v){v.toggleClass("__active",!!t&&!!ar);v.unbind("click.back").bind("click.back",function(au){if(v.hasClass("__active")){var at=af.hasClass("__active");OK.mtLayer.showTopicInLayer(t,ar,"MT_GoBack_"+ar,false,"","BACK",at);}OK.stop(au);});}}function d(t,ar){if(af){af.toggleClass("__active",!!t&&!!ar);af.unbind("click.forward").bind("click.forward",function(au){if(af.hasClass("__active")){var at=v.hasClass("__active");OK.mtLayer.showTopicInLayer(t,ar,"MT_GoForward_"+ar,false,"","FORWARD",at);}OK.stop(au);});}}function Z(at){if(at){var au=aq.find("[data-scroll-to='"+at+"']");if(au.length>0){var az=au[0];var ay=az.offsetTop;var t=az.offsetParent;while(t&&t.nodeType==1&&t!=aq[0]){ay+=t.offsetTop;t=t.offsetParent;}var ax=aq;var av=ax.height();var ar=ax.scrollTop();var aB=av;if(ar+av<=ay+aB){ax.scrollTop(ay+aB-av-5);}else{if(ar>ay){var aw=null;var aA=aw?aw.offsetHeight:0;ax.scrollTop(ay-aA-5);}}}}}function V(){var t=Q;var ar=t.find(".gwt-shortcutMenu__show");if(ar.length){ar.removeClass("gwt-shortcutMenu__show");}var at=t.find(".sc-menu:not(.sc-menu__hidden,.poll_ans_cnt)");if(at.length){at=at.not("#ownProfileLSMnu");at.addClass("sc-menu__hidden");}}var u=[0,1,2,3,5,8,13,21,34,55,89,144,233,377,610];function al(ar,au){var at=(au-ar)/100;var t;for(t=1;t<u.length;t++){if(at<u[t]){break;}}return u[t-1]+"00";}function g(){if(aq){aq.scrollTop(0);}}function D(t){if(ae.isProcess){R(false);}else{ah(false);}t&&t();}return{show:function(){I();y(true);g();},showPreloaded:function(av,ar,ax,aE){j=ar;I(ax);var at=$("#"+E);var aB=at.attr("data-log");if(aB){m(aB);}var au=at.attr("data-url");if(au){K(au);}else{z();}if(ae.closeTopicId||aE){}else{var ay=at.attr("data-back-id");s(ay,av);var aw=at.attr("data-forward-id");d(aw,av);}var aD=at.attr("data-id");if(aD){ae.topicId=aD;ae.owner=av;}var t=at.attr("data-log-click");if(t){aq.attr("data-log-click",t);}else{aq.removeAttr("data-log-click");}var aA=!!at.attr("data-redesign");var aC=ae.redesign;ae.redesign=aA;if(aC!=aA&&!ae.isProcess){o();}D();aa([af,v,M],C);g();p=n.find("."+l);U=n.find("."+k);var az=at.attr("data-scroll-to-marker");G(true,ax,az);},showTopicInLayer:function(aA,au,at,aw,t,aD,aF,aE,aC,az,aB){var ay=+new Date();var av;I(aw);if(!aD){ae.closeTopicId=null;ae.closeOwnerType=null;}if(at&&at.indexOf("st.mt.or=on")!=-1){aC=ae.topicId;az=ae.owner;}if(OK.photoLayer){OK.photoLayer.close();}OK.VideoPlayer.pauseAll();OK.loader.use("OKCustomJs",function(){var aH=OK.Layers.stack;var aI=aH&&aH.length>0&&aH[aH.length-1].id==c;if(!aI&&ae.isActive){W(true);}});function aG(aJ){var aI=Date.now();var aH="";if(aJ){aH+="r_";}if(aD){aH+="dt";}else{aH+="ot";}m(aH+al(ay,aI));if(av){m("js_"+aH+al(av,aI));}}A=au;j=t;if(t){m("shortlink");}b();if(ae.isActive&&!ae.isProcess){ah(true);V();}else{R(true);}y(true);var ar;if(OK.getCurrentStateLink){ar=OK.getCurrentStateLink();}else{ar="/dk?"+window.pageCtx.state.replace(/&amp;/g,"&");}ar+=ar.indexOf("?")==-1?"?":"&";ar=ar.replace(/st\.mt\.(id|ot|bi|dir|hn).*?(&|$)/g,"");ar+="cmd="+E+"&st._aid="+at;var ax=$.ajax({type:"POST",url:ar,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":aA,"st.mt.ot":au,"st.mt.dir":aD,"st.mt.wc":aE?"on":"off","st.mt.hn":aB?"on":"off"},headers:{TKN:OK.tkn.get()}});ax.done(function(aJ,aH,aP){av=Date.now();if(aC){ae.closeTopicId=aC;ae.closeOwnerType=az;}var aM=aP.getResponseHeader("Redirect-Location");if(aM){var aN=function(aQ){if(OK.navigation.redirect){OK.navigation.redirect(aM);}if(aQ==0||OK.navigation.redirect){a();aG();}else{setTimeout(function(){aN(aQ-1);},200);}};aN(5);}else{var aK=aP.getResponseHeader("End-Reached");if(aK=="yes"){if(aD=="FORWARD"){if(aF){v.toggleClass("__active",true);}}else{if(aD=="BACK"){if(aF){af.toggleClass("__active",true);}}}D(aG);return;}var aL=aJ.split(OK.navigation.SPLITER),aO=aP.getResponseHeader(OK.navigation.HEADER).split(",");for(var aI=0;aI<aL.length;aI++){if(aO[aI]){OK.hookModel.setHookContent(aO[aI],aL[aI]);}}OK.mtLayer.showPreloaded(au,t,aw,aB);}});ax.fail(function(){a("cr_fail");aG();});return ax;},closeLayer:function(){if(x){a();}},hideLayer:function(){O=false;if(ae&&ae.isActive){if(i&&h()==H){am(i,true);}S(false,false);}},restoreLayer:function(){if(ae&&ae.isActive){aa([Y,af,v,M],C);if(i&&h()!=H){am(H,true);}S(false,true);}},refreshLayerBody:function(au){function t(){if(au){au();}}if(!ae||!ae.topicId||!ae.owner){t();return;}var ar="/";if(OK.getCurrentStateLink){ar=OK.getCurrentStateLink();}ar+=ar.indexOf("?")==-1?"?":"&";ar+="cmd="+E+"&st._aid=PLPhotoUserBackToView";var at=$.ajax({type:"POST",url:ar,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":ae.topicId,"st.mt.ot":ae.owner},headers:{TKN:OK.tkn.get()}});at.done(function(az,aB,aA){var aw=aA.getResponseHeader("Redirect-Location");if(aw){if(OK.navigation.redirect){OK.navigation.redirect(aw);}a();}else{var av=az.split(OK.navigation.SPLITER),ay=aA.getResponseHeader(OK.navigation.HEADER).split(",");for(var ax=0;ax<av.length;ax++){if(ay[ax]){OK.hookModel.setHookContent(ay[ax],av[ax]);}}}t();});at.fail(t);},deactivate:function(){$(window).off(".mtLayer");y(false);},isReady:function(){return !!document.getElementById("hook_Block_PopLayerMediaTopic");}};})();