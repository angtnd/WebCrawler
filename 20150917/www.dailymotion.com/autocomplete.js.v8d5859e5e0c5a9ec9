_DM.define("Autocomplete",function(){var a=function(c,b){if(!a.instances){a.instances=[]}this.instanceId=a.instances.push(this)-1;this.searchFieldId=c;this.suggestionsId="autocomplete_"+c;this.container=null;this.suggestions=[];this.$iframeLayer=null;this.selectedIndex=-1;this.boundKiller=null;this.ignoreValueChange=false;this.cachedResponse=[];this.onChangeInterval=null;this.typedValue="";this.inputValue="";this.lastTypedValue="";this.refineLocally=false;this.dataValue=null;this.shadowTimeout=null;this.options={serviceUrl:"",autoSubmit:true,minChars:1,maxChars:0,deferRequestBy:0,showInfo:true,autoPosition:false,appendMode:false,allowRefineLocally:true,suggestMax:10,headerOffset:36,suggestHeight:20,postConfigureSearchField:null,withShadow:false,withIframeLayer:false,cleanStringOnValueChange:true,cleanStringOnProcessResponse:true,processResponse:null,suggest:null,onKeyUp:null,suggestionsProvider:null};for(var d in b){if(!b.hasOwnProperty(d)){continue}if(d in this){this[d]=b[d];delete (b[d])}}$.extend(this.options,b);this.configureSearchField()};a.prototype={version:3,configureSearchField:function(){var b=$("#"+this.searchFieldId);this.el=b[0];b.attr("autocomplete","off");b.on("keydown",$.proxy(this.onKeyDown,this)).on("keyup",$.proxy(this.onKeyUp,this)).on("blur",$.proxy(this.enablekiller,this));if(this.options.withShadow){var d=b.position();var c=$('<input id="input_search_shadow" type="text" tabindex="-1" />').show().css({left:d.left+"px",top:d.top+"px",width:b.width("width")+"px"});this.shadowEl=c[0];b.after(c)}if(this.options.postConfigureSearchField&&typeof this.options.postConfigureSearchField==="function"){this.options.postConfigureSearchField(this)}},createSuggestionsContainer:function(){log("_self","createSuggestionsContainer()");var c=$("<div>"),b={display:"none"},d=$(this.el);if(this.options.withIframeLayer){this.$iframeLayer=$('<iframe class="search_iframe_layer">')}c.addClass("autocomplete").attr("id",this.suggestionsId);if(this.options.autoPosition){b.top=(d.position().top+d.height()+parseInt(d.css("padding-top"),10)+parseInt(d.css("padding-bottom"),10)+2)+"px"}d.after(c.css(b));if(this.options.withIframeLayer){d.before(this.$iframeLayer.css("top",c.css("top")))}this.container=$("#"+this.suggestionsId)[0]},onKeyDown:function(b){if(this.options.withShadow){if(this.shadowEl.value.indexOf(this.el.value+String.fromCharCode(b.keyCode).toLowerCase())===-1){this.updateShadow()}}switch(b.keyCode){case 27:this.el.value=this.inputValue;this.hide();break;case 13:if(!this.options.autoSubmit){b.preventDefault()}this.onSelect(this.selectedIndex);break;case 38:this.moveUp();break;case 40:this.moveDown();break;case 8:case 32:this.updateShadow();return;default:return}b.preventDefault()},onKeyUp:function(b){switch(b.keyCode){case 38:case 40:case 13:return;default:break}clearInterval(this.onChangeInterval);this.ignoreValueChange=false;if(this.typedValue!==this.el.value.toLowerCase()){if(this.options.deferRequestBy>0){this.onChangeInterval=setInterval($.proxy(this.onValueChange,this),this.options.deferRequestBy)}else{this.onValueChange()}}},enablekiller:function(){if(this.boundKiller===null){this.boundKiller=$.proxy(this.killer,this);$(document).on("click",this.boundKiller)}},disablekiller:function(){if(this.boundKiller!==null){$(document).off("click",this.boundKiller);this.boundKiller=null}},killer:function(b){if(!$(b.target).closest("#"+this.suggestionsId)[0]&&!$(b.target).closest("#"+this.searchFieldId)[0]){this.hide();this.disablekiller()}},hide:function(){this.selectedIndex=-1;if(this.container){$(this.container).hide();if(this.options.withIframeLayer){$(this.$iframeLayer).hide()}$(".sd_header__search input[name=search]").removeClass("no_border_bottom_left_radius")}},updateInput:function(f,c){log("_self","update input text with new value",f);if(this.options.appendMode&&!c){var b=this.el.value.split(" "),e=b[b.length-1],d=new RegExp(e+"$");this.el.value=this.el.value.replace(d,f)}else{this.el.value=f}this.updateShadow(this.el.value)},moveUp:function(){this.updateShadow();if(this.selectedIndex===-1){this.selectedIndex=this.suggestions.length;this.activate(this.selectedIndex-1);if(this.suggestions[this.selectedIndex].name){this.updateInput(this.suggestions[this.selectedIndex].name)}else{this.updateInput(this.suggestions[this.selectedIndex][0])}return}if(this.selectedIndex===0){$(this.container).find(".selected").removeClass("selected");this.selectedIndex=-1;this.updateInput(this.inputValue,true);return}this.activate(this.selectedIndex-1);if(this.suggestions[this.selectedIndex].name){this.updateInput(this.suggestions[this.selectedIndex].name)}else{this.updateInput(this.suggestions[this.selectedIndex][0])}},moveDown:function(){this.updateShadow();if(this.selectedIndex===(this.suggestions.length-1)){$(this.container).find(".selected").removeClass("selected");this.selectedIndex=-1;this.updateInput(this.inputValue,true);return}this.activate(this.selectedIndex+1);if(this.suggestions[this.selectedIndex].name){this.updateInput(this.suggestions[this.selectedIndex].name)}else{this.updateInput(this.suggestions[this.selectedIndex][0])}},onValueChange:function(){clearInterval(this.onChangeInterval);this.lastTypedValue=this.typedValue.toLowerCase();this.typedValue=this.el.value.toLowerCase();this.inputValue=this.el.value;this.selectedIndex=-1;log("_self","onValueChange(), new value",this.typedValue);if(!$("#"+this.suggestionsId)[0]){this.createSuggestionsContainer()}if(this.ignoreValueChange){this.ignoreValueChange=false;return}if(this.options.cleanStringOnValueChange){this.typedValue=this.cleansSearchString(this.typedValue)}if(this.typedValue===""||this.typedValue.length<this.options.minChars||(this.options.maxChars&&this.typedValue.length>this.options.maxChars)){log("_self","typed value empty || < minChars || > maxChars");this.hide();this.updateShadow()}else{this.getSuggestions()}},onSelect:function(c,d){var b=this.suggestions[c]||[this.cleansSearchString(this.el.value)];if(this.options.onSelectSuggestion&&typeof this.options.onSelectSuggestion==="function"){this.options.onSelectSuggestion(b,this.suggestions,d)}else{if(b[0]){this.updateShadow();this.updateInput(b[0]);this.ignoreValueChange=true}}this.hide();if(this.options.autoSubmit&&$(this.el).closest("form")[0]&&!d){$(this.el).closest("form").submit();this.addRequestsToLocalStorage(b[0])}},addRequestsToLocalStorage:function(b){try{if(localStorage){var d;if(localStorage.hasOwnProperty("search_history")){d=JSON.parse(localStorage.getItem("search_history"));if($.inArray(b,d)>-1){d.splice($.inArray(b,d),1)}d.unshift(b);if(d.length>50){d.pop()}}else{d=[];d.push(b)}localStorage.setItem("search_history",JSON.stringify(d))}}catch(c){}},getSuggestions:function(){log("_self","getSuggestions() for value",this.typedValue);if($.isArray(this.cachedResponse[encodeURIComponent(this.accentsTidy(this.typedValue))])){this.truncateSuggestions(this.cachedResponse[encodeURIComponent(this.accentsTidy(this.typedValue))]);log("_self","found cached response for value",this.typedValue,this.suggestions);this._suggest()}else{if(this.refineLocally&&this.options.allowRefineLocally){if(!this.lastTypedValue.match(/^\s*$/)&&this.el.value.toLowerCase().indexOf(this.lastTypedValue)===0){this.suggestions=$(this.suggestions).grep(function(b){return this.accentsTidy(b[0]).indexOf(this.accentsTidy(this.typedValue))===0},this);this.cachedResponse[encodeURIComponent(this.accentsTidy(this.typedValue))]=this.suggestions;this._suggest();return}else{this.refineLocally=false}}this.suggestionsProvider()}},suggestionsProvider:function(){var c=getCookie("dmt"),b=this.options.serviceUrl+"/"+encodeURIComponent(this.typedValue)+(c?"?"+c:"");$.getJSON(b).always($.proxy(this.processResponse,this,b))},_suggest:function(){this.suggest();if(this.options.withIframeLayer){this.$iframeLayer.show().css({left:$(this.container).css("left"),width:$(this.container).outerWidth()+"px",height:$(this.container).outerHeight()+"px"})}},suggest:function(){log("_self","suggest() results for value",this.typedValue);if(this.suggestions.length===0){this.updateShadow();log("_self","no suggestions to display, hide container");this.hide();return}var f=[];var d="";f.push('<div class="suggestions">');var e=this;$(this.suggestions).each(function(g,h){if(g===0){e.updateShadow(h[0])}d=h[0];f.push((e.selectedIndex===g?'<div class="selected"':"<div"),' onclick="Autocomplete.instances[',e.instanceId,"].onSelect(",g,')"',' onmouseover="Autocomplete.instances[',e.instanceId,"].activate(",g,')">','<span class="suggestion" id="suggestion_',g,'"',">",d,"</span>");f.push('<div class="clear_suggestion"></div></div>')});f.push("</div>");$(this.container).html(f.join("")).show();if(this.searchFieldId=="input_search"){$(".sd_header__search input[name=search]").addClass("no_border_bottom_left_radius")}var c=$("#"+this.searchFieldId),b=c.position();$(this.container).css({left:b.left+"px",width:c.width()+"px"})},processResponse:function(c,b){var f=c.substring(c.lastIndexOf("/")+1,c.length);if(f.indexOf("?")!=-1){f=f.substring(0,f.indexOf("?"))}log("_self","processResponse()",b);this.cachedResponse[encodeURIComponent(this.accentsTidy(this.typedValue))]=b;this.truncateSuggestions(b);if(this.suggestions.length<10&&this.options.allowRefineLocally){this.refineLocally=true}var e=this.el.value.toLowerCase(),d=this.options.cleanStringOnProcessResponse?this.cleansSearchString(e):e;if(f===encodeURIComponent(d)){this._suggest()}},truncateSuggestions:function(c){this.suggestions=c;var b=$("html");if(b.hasClass("win")&&(b.hasClass("webkit")||b.hasClass("ie"))){var f=$("#main_player")||$(".dmpi_video_playerv4"),d=f[0];if(d){var e=f.offset().top-$("#header").offset().top-this.options.headerOffset;this.options.suggestMax=Math.floor(e/this.options.suggestHeight);if(!$(document.body).hasClass("dm_page_html_video")){this.options.suggestMax--}}if(this.options.suggestMax<10){this.suggestions=c.slice(this.options.suggestMax-1)}}},activate:function(b){var d;if(this.container&&$(this.container).is(":visible")){$(this.container).find(".selected").removeClass("selected");this.selectedIndex=b;var c=$(this.container).children().children();if(this.selectedIndex!==-1&&c.length>this.selectedIndex){d=c[this.selectedIndex];$(d).addClass("selected")}}return d},updateShadow:function(b){if(this.options.withShadow){var c=this;clearTimeout(this.shadowTimeout);if(b){this.shadowTimeout=setTimeout(function(){c.shadowEl.value=b;log("_self","update shadow with value",b)},300)}else{this.shadowEl.value="";log("_self","update shadow with value",b)}}},cleansSearchString:function(b){return b.replace(/\s{2,}/g," ").replace(/^\s+/g,"").replace(/\//g,"")},accentsTidy:function(b){return b.toLowerCase().replace(/[Ã Ã¡Ã¢Ã£Ã¤Ã¥]/g,"a").replace(/Ã§/g,"c").replace(/[Ã¨Ã©ÃªÃ«]/g,"e").replace(/[Ã¬Ã­Ã®Ã¯]/g,"i").replace(/Ã±/g,"n").replace(/[Ã²Ã³Ã´ÃµÃ¶]/g,"o").replace(/[Ã¹ÃºÃ»Ã¼]/g,"u").replace(/[Ã½Ã¿]/g,"y")}};return a},true);