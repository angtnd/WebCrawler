define(["jquery-1","locator/utils","locator/search","locator/confirm","locator/cookies"],function(w,S,n,H,D){var j="blq-container-outer",p="body",R="locator",T="locator-overlay",z,U,C,h="locator-component",L="locator-component-searchbox",P,A,O,B=null,N=false,g=false,q=false,t={isModal:true,isSearchBox:false,xhrTimeout:10000},v,Q=null,f,b;function s(V){m();V=V||{};f=V.arrowPosition;if(typeof V.targetElement!=="undefined"){b=w(V.targetElement)}if(!N){M()}B={top:null,bottom:null,left:null,right:null};if(V){if(V.top){B.top=V.top}if(V.bottom){B.bottom=V.bottom}if(V.left){B.left=V.left}if(V.right){B.right=V.right}}if(g){g=false;q=false;z=null}if(!z){F()}else{c(r)}}function c(W){var V;if(document.activeElement){A=document.activeElement}if(!C){if(t.isSearchBox){z.wrap('<div class="'+h+" "+L+'"/>');C=z.find("div."+h)}}if(t.isModal){if(!q){q=true;z.prepend('<a class="locator-close" href="#locator"><span>'+window.locator.close+"</span></a>")}z.find("a.locator-close").one("click",function(X){w(this).blur();S.doIStatsAction("close");G();X.preventDefault()});u()}if(S.isFunction(W)){W()}if(D.shouldDisplayLimitedFunctionalityMessage()){if(w("#locator form").length>0){w("#locator form").append(D.getLimitedFunctionalityTemplate())}else{w("#locator-form-search").parents("span").after(D.getLimitedFunctionalityTemplate())}}V={supports_geolocation:(typeof navigator.geolocation!=="undefined")?1:0};S.doIStatsAction("open",V)}function G(){if(!z){return}x();z.detach();if(t.isModal){w(window).off("resize",I);m()}if(A){A.focus();A=null}}function I(){var X=w(window).width(),aa=w(window).height(),Y=false,W=false,V,Z;V={position:"absolute"};if(typeof b!=="undefined"){Z=b.offset();V.top=(Z.top)+(B.top||0);V.left=(Z.left)+(B.left||0)}else{if(B.top){V.top=B.top;W=true}if(B.bottom){V.bottom=B.bottom;W=true}if(B.left){V.left=B.left;Y=true}if(B.right){V.right=B.right;Y=true}if(!Y){V.left=(X-z.width())/2;V.left+="px"}if(!W){V.top=(aa-z.height())/2;V.top+="px"}}U.css(V)}function u(){var W=w(p),Y=w(document).height(),V,X;W.append(i());W.append(z);z.wrap('<div id="locator-modal"/>');U=z.parent();I();z.show();if(typeof b!=="undefined"){w(window).on("resize",I)}if(typeof f==="string"){V=w('<div id="locator-modal-arrow" />');X="-11px -55px";U.prepend(V);if(f==="center"){X=((U.width()/2)-33)+"px -55px"}else{if(f==="right"){X=(U.width()-54)+"px -55px"}else{X="-11px -55px"}}V.css("background-position",X)}K()}function i(){O=w('<div id="'+T+'" />');return O}function K(){O.css({opacity:0,height:w(document).height()});O.on("click",G);return O}function m(){if(O){O.remove();O=null}if(U){U.remove();U=null}}function F(){var V=S.interpolateRoute(window.locator.routes.index);S.ajax(V,function(W){z=w(W.html);if(W.page==="index"&&D.areAllowed()===false){D.isLimitedFunctionality=true}c(r)},function(X){var W='<div id="'+R+'"/>';z=w(W);c();d()},{timeout:t.xhrTimeout})}function r(V){t.setResultHandler=function(W){l({locationData:W})};if(Q===null){t.instanceId="locator_cookie";Q=new n(V,t)}o(Q,{callback:function(){Q.prepareDom()}})}function l(V){o(H,{callback:function(){H.setCancelHandler(r);H.setSuccessHandler(function(W){a(function(){w(v).trigger("location_changed",W)})});H.init(V,t)}})}function a(V){if(t.isModal){G();S.safeCallback(V)}else{y()}}function y(){document.location=window.locator.pageToReturnTo}function J(V,W){if(W.component){switch(W.component){case"confirm":l(W);break;case"search":r(W);break}}}function o(W,V){function X(){P=W;w(P).bind("locator_component_change",J);if(V&&V.callback&&S.isFunction(V.callback)){V.callback()}}if(P){k(X)}else{X()}}function k(V){if(P){w(P).unbind("locator_component_change",J)}if(P&&S.isFunction(P.fadeOutAndClear)){P.fadeOutAndClear(V)}else{S.safeCallback(V)}}function x(V){if(P){w(P).unbind("locator_component_change",J)}if(P&&S.isFunction(P.clear)){P.clear(function(){P=null;S.safeCallback(V)})}else{S.safeCallback(V)}}function e(){return t.isModal}function M(){N=true;z=w("#"+R);if(z.length){t.isModal=false;var V="search";if(z.find(".locator-confirm").length){V="confirm"}c(function(){if("confirm"===V){l()}else{r()}})}else{if(w(".locator-search").length){z=w(".locator-search");t.isModal=false;t.isSearchBox=true;c(r)}else{z=null}}}function E(){C=null;N=false}function d(){var W="locator-error",Y=window.locator.error.heading,X=window.locator.error.load,V=w('<div class="'+W+'"/>');V.append("<h2>"+Y+"</h2>");V.append("<p>"+X+"</p>");g=true;z.append(V)}v={init:M,getIsModal:e,open:s,close:G,reset:E,setLocation:S.setLocation,hasLocation:S.hasLocation};return v});