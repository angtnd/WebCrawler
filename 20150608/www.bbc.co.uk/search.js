define(["jquery-1","locator/utils","locator/autocomplete","locator/cookies","locator/geolocation"],function(f,a,e,d,b){function c(j,i){this.setupDefaults();this.setConfig(i);this.options=window.locator.search[this.instanceId].options;this.translations=window.locator.search[this.instanceId].translations;if(this.isSearchBox){this.container=f("#locator-search-"+this.instanceId).parent("."+this.classes.component)}else{if(this.locatorContainer===null){this.locatorContainer=f("#locator")}this.container=this.locatorContainer.find("."+this.classes.component)}if(this.isModal){if(!this.locatorContainer.length){this.isModal=false}}if(!this.html){this.html=this.container.find("div."+this.componentClass);if(!this.html.length){this.html=null}else{this.html.detach()}}var h=window.locator.search[this.instanceId];if(h.results){this.results=h.results}if(this.html){this.prepareDom();if(j&&"news_local_region"===j.mode){this.xhrResponseData=j;this.isWaitingToDisplayLocalNews=true;this.checkState()}}else{this.load()}}c.prototype.setupDefaults=function(){this.instanceId="default";this.container=null;this.locatorContainer=null;this.form=null;this.componentClass="locator-search";this.classes={info:"info",component:"locator-component",componentWithResult:"locator-search-with-results",loading:"locator-loading",pagination:"locator-pagination",results:"locator-results",resultsLocalRegion:"locator-results-local",error:"locator-error",prompt:"locator-prompt"};this.elements={component:null,info:null,form:null,input:null,prompt:null,results:null,resultsList:null,pagination:null,loading:null,error:null,close:null};this.autoSuggest=null;this.hasSelectedAutoSuggestion=false;this.xhr=null;this.xhrResponseData=null;this.isAnimating=false;this.isWaitingToDisplayResults=false;this.isWaitingToDisplayLocalNews=false;this.isWaitingToDisplay=false;this.isRequestingPaginationData=false;this.resultHandler=null;this.searchFormSelector=null;this.html=null;this.htmlInfo=null;this.isSearchBox=false;this.isModal=false;this.locationData=null;this.originalSearchTerm=null;this.xhrSearchTerm=null;this.hasSelectedLocation=false};function g(i,h){return function(){return i.apply(h,arguments)}}c.prototype.setConfig=function(h){var i;for(i in h){if(h.hasOwnProperty(i)&&this.hasOwnProperty(i)&&!a.isFunction(c.prototype[i])){this[i]=h[i]}}};c.prototype.setResultHandler=function(h){if(a.isFunction(h)){this.resultHandler=h}};c.prototype.getResultHandler=function(){return this.resultHandler};c.prototype.callResultHandler=function(h){if(a.isFunction(this.resultHandler)){this.resultHandler(h);return true}return false};c.prototype.resultsClick=function(l){var j=f(l.target),k,m,i,h;if(a.isFunction(l.preventDefault)){l.preventDefault()}if(this.hasSelectedLocation){return false}if(!j.is("a")){j=j.find("a")}if(l.isLocalRegion){i="news_region_click";k=j.attr("href");m=k.match(/confirm\/(\w+)\/(\w+)/);if(!m){return}this.locationData.local_region=m[2]}else{i="location_result_click";if(l.isAutoComplete){i="autocomplete_click"}this.locationData=j.data("result")}h={location_id:this.locationData.id,location_name:this.locationData.name};if(this.locationData.local_region){h.local_region=this.locationData.local_region}a.doIStatsAction(i,h);this.hasSelectedLocation=true;this.handleLocation(this.locationData)};c.prototype.handleLocation=function(i){var k,j,h;k=this;if(window.locator.isLocator){this.confirm()}else{if(window.locator.search[this.instanceId].options.emitJavascriptEvent){this.elements.input.val(i.fullName);this.removeElements(["results","pagination","error","close"],function(){h={id:i.id,name:i.name,fullName:i.fullName,instanceId:k.instanceId};k.hasSelectedLocation=false;f(window).trigger("location_selected",h)})}else{j=a.interpolateRoute(window.locator.search[this.instanceId].routes.targetUri,{location_id:String(i.id).toLowerCase()});window.location=j}}};c.prototype.paginationClick=function(l){var j,i=f(l.target).attr("href"),n=/search=([^&]+)&page=(\d+)/,m=i.match(n),k,h=this;j=m[1];j=j.replace(/\+/g," ");k=m[2];this.isRequestingPaginationData=true;this.removeElements(["resultsList"],function(){h.search({search:j,page:k})});l.preventDefault()};c.prototype.search=function(l){var i,k=1,m={},j=this.options.place_types,h=this.options.restrict_to_countries;if(!l||!l.search){return false}if(typeof l==="string"){l={search:l}}if(j.length>0){l.place_types=j.join(",")}if(h.length>0){l.restrict_to_countries=h.join(",")}if(this.options.filter){l.filter=this.options.filter}l.postcode_unit=this.options.isPostcodeUnitAllowed;l.postcode_district=this.options.isPostcodeDistrictAllowed;if(l.page){k=l.page}a.doIStatsAction("search",{ns_search_term:l.search,page_num:k});i=a.interpolateRoute(window.locator.search[this.instanceId].routes.search,{language:this.options.language});m.data=l;return this.ajax(i,m)};c.prototype.confirm=function(){var h;h=window.locator.routes.confirm;if(this.locationData.local_region){h=window.locator.routes.confirmWithLocalRegion}var i=a.interpolateRoute(h,{location_id:this.locationData.id,location_name:this.locationData.name,local_region:this.locationData.local_region,geolocation:this.locationData.geolocation?"1":"0"});return this.ajax(i)};c.prototype.ajax=function(i,j){if(!i){return false}var h=this;if(j&&j.data){this.xhrSearchTerm=j.data.search}this.xhr=a.ajax(i,function(m,n,l){var k;if("search"===m.component){h.xhrResponseData=m;h.xhr=null;switch(h.xhrResponseData.mode){case"results":if(1===h.xhrResponseData.noOfResults){h.locationData=h.xhrResponseData.results[0];a.doIStatsAction("location_result_click",{location_id:h.locationData.id,location_name:h.locationData.name});h.handleLocation(h.locationData);return}else{if(0===h.xhrResponseData.noOfResults){a.doIStatsAction("no_results",{ns_search_term:h.xhrSearchTerm})}}h.isWaitingToDisplayResults=true;h.checkState();break;case"news_local_region":h.locationData=h.xhrResponseData.location;h.isWaitingToDisplayLocalNews=true;h.checkState();break}}else{if(h.locationData){m.locationData={location_id:h.locationData.id,location_name:h.locationData.name,local_region:h.locationData.local_region,geolocation:h.locationData.geolocation}}else{if(m.location){m.locationData={location_id:m.location.id,location_name:m.location.name}}}f(h).trigger("locator_component_change",m)}},function(l,n,m){var k=null;h.isWaitingToDisplayError=true;h.xhr=null;h.checkState()},j);return true};c.prototype.isValidSearchTerm=function(h){if(!h||!h.length){return false}return true};c.prototype.revealElements=function(n,m){var l=0,i=0,k,j=this;function h(o){if(j.elements[o]){j.isAnimating=true;i++;a.fadeIn(j.elements[o],function(){if(++l===i){j.isAnimating=false;a.safeCallback(m)}})}}if(this.elements){for(k in n){if(n.hasOwnProperty(k)&&n[k]){h(n[k])}}}if(0===i){a.safeCallback(m)}};c.prototype.removeElements=function(n,m){var l=0,i=0,k,j=this;function h(o){if(j.elements[o]&&j.elements[o].is(":visible")){j.isAnimating=true;i++;a.fadeOut(j.elements[o],function(){if(j.elements[o]){j.elements[o].remove();j.elements[o]=null}if(++l===i){j.isAnimating=false;a.safeCallback(m)}})}}if(this.elements){for(k in n){if(n.hasOwnProperty(k)&&n[k].length>0){h(n[k])}}}if(0===i){a.safeCallback(m)}};c.prototype.clear=function(i){var h;this.isRequestingPaginationData=false;if(this.elements.component){this.elements.component.remove();this.elements.component.undelegate();this.elements.component=null}for(h in this.elements){if(this.elements.hasOwnProperty(h)){this.elements[h]=null}}a.safeCallback(i)};c.prototype.fadeOutAndClear=function(i){var h=this;this.removeElements(["info","prompt","form","results","pagination","error"],function(){h.clear(i);h.hasSelectedLocation=false})};c.prototype.prepareDomForResults=function(){d.removeLimitedFunctionalityMessage();if(!this.elements.results){this.elements.form.after('<div class="'+this.classes.results+'"/>');this.elements.results=this.container.find("."+this.classes.results)}this.elements.component.addClass(this.classes.componentWithResult)};c.prototype.updateLocalNews=function(j){if(!j||!j.html){return false}var h=this;this.prepareDomForResults();var i=f(j.html).find("."+this.classes.results);this.elements.results.html(i).hide();this.removeElements(["info"],function(){h.revealElements(["results"],function(){i.find("ul a:first").focus();h.checkState()})});this.hasSelectedLocation=false};c.prototype.createSearchResultsDom=function(n){var h,m,j,i,l,k,o="<h3>"+n.resultsText+': <span class="search-term"></span></h3>';if(0===n.results.length){f(".locator-results").addClass("no-results");h=f(o+"<p>"+this.translations.tryAgain+"</p>")}else{h=f("<div>"+o+"<ul></div>");m=h.find("ul");for(k=0;k<n.results.length;k++){i=n.results[k];j=a.interpolateRoute(window.locator.search[this.instanceId].routes.targetUri,{location_id:i.id},true);i.fullNameTruncated=a.truncate(i.fullName,this.options.truncationLengths.search);l=f('<li><a title="'+i.fullName+'" href="'+j+'">'+i.fullNameTruncated+"</a></li>");l.find("a").data("result",i);m.append(l)}h.unwrap()}h.find(".search-term").text("'"+this.originalSearchTerm+"'");return h};c.prototype.updateSearchResults=function(l){var h,j=this;if(!l||!l.results){return false}this.prepareDomForResults();h=this.createSearchResultsDom(l);this.elements.results.html(h);this.elements.resultsList=this.elements.results.find("ul");if(l.pagination){if(!this.elements.pagination){this.elements.results.after('<div class="'+this.classes.pagination+'"/>');this.elements.pagination=this.container.find("."+this.classes.pagination)}this.elements.pagination.html(l.pagination)}if(!window.locator.isLocator){var k=this.elements.results.parent();k.append('<a href="'+this.translations.close+'" class="locator-close"><span>'+this.translations.close+"</span></a>");this.elements.close=k.find("a.locator-close");this.elements.close.one("click",function(m){m.preventDefault();j.elements.results.remove();j.elements.results=null;if(j.elements.pagination){j.elements.pagination.remove();j.elements.pagination=null}j.elements.component.removeClass(j.classes.componentWithResult);f(this).remove()})}var i=[];if(this.isRequestingPaginationData){this.elements.resultsList.hide();i.push("resultsList");this.isRequestingPaginationData=false}else{this.elements.results.hide();i.push("results");if(0===l.noOfResults){if(this.htmlInfo){if(!this.elements.info){this.container.append(this.htmlInfo.clone());this.elements.info=this.container.find("p.info");this.elements.info.hide()}}i.push("info")}else{if(l.pagination){this.elements.pagination.hide();i.push("pagination")}}}this.revealElements(i,function(){j.elements.results.find("li a:first").focus();j.checkState()})};c.prototype.checkState=function(){if(this.isAnimating){return}if(this.isWaitingToDisplayResults||this.isWaitingToDisplayLocalNews||this.isWaitingToDisplayError){var j=["error","close"];if(!this.isRequestingPaginationData){if(!this.isWaitingToDisplayError){j.push("prompt")}j.push("results","pagination")}if(this.xhrResponseData&&this.xhrResponseData.noOfResults&&this.xhrResponseData.noOfResults>0){j.push("info")}var h=this;var i=this.translations.error.search;this.removeElements(j,function(){if(h.isWaitingToDisplayError){h.isWaitingToDisplayError=false;h.elements.component.append('<div class="'+h.classes.error+'"><p>'+i+"</p></div>");h.elements.error=h.container.find("."+h.classes.error);h.elements.error.hide();a.fadeIn(h.elements.error)}else{if(h.isWaitingToDisplayLocalNews){h.isWaitingToDisplayLocalNews=false;h.updateLocalNews(h.xhrResponseData)}else{if(h.isWaitingToDisplayResults){h.isWaitingToDisplayResults=false;h.updateSearchResults(h.xhrResponseData)}}}})}};c.prototype.prepareDom=function(){var k=this;this.elements.info=this.container.parent().find("p."+this.classes.info);if(this.elements.info.length){this.elements.info.detach();this.htmlInfo=this.elements.info.clone()}else{if(this.htmlInfo){this.elements.info=this.htmlInfo.clone()}else{this.elements.info=null}}this.container.html(this.html.clone());this.elements.component=this.container.find("."+this.componentClass);this.elements.form=this.container.find("form");this.elements.input=this.container.find('input[name="search"]');if(this.elements.info){this.container.append(this.elements.info)}this.elements.results=this.container.find("."+this.classes.results);this.elements.resultsList=this.elements.results.find("ul");f.map(this.elements.resultsList.find("a"),function(n,m){f(n).data("result",k.results[m])});this.elements.pagination=this.container.find("."+this.classes.pagination);if(!this.elements.results.length){this.elements.results=null}if(!this.elements.resultsList.length){this.elements.resultsList=null}if(!this.elements.pagination.length){this.elements.pagination=null}var j=this.elements.input;var h=this.translations.prompt;function l(n){if(typeof n.setSelectionRange==="function"){if(f(n).is(":visible")){n.setSelectionRange(0,0)}}else{if(typeof n.createTextRange==="function"){var m=n.createTextRange();m.collapse(true);m.select()}}}function i(m){if(j.val()===h){j.val("")}else{if(j.val().substr(1)===h){j.val(j.val().substr(0,1))}}}j.bind("keydown",i);j.unbind("keydown",i);j.bind("focus",function(m){if(j.val()===""||j.val()===h){j.val(h);l(m.currentTarget);setTimeout(function(){l(m.currentTarget)},9)}j.bind("keydown",i);k.hasSelectedAutoSuggestion=false});j.bind("blur",function(m){if(j.val()===""){j.val(h)}j.unbind("keydown",i)});j.bind("click",function(m){if(j.val()===h){l(m.currentTarget)}});if(j.val()===""){j.val(h)}else{this.originalSearchTerm=j.val()}if(this.isModal){this.elements.input.focus()}k.elements.form.bind("submit",function(m){var n;n=j.val();if(n===h){return false}k.locationData=null;if(k.hasSelectedAutoSuggestion){k.hasSelectedAutoSuggestion=false;return false}if(k.autoSuggest){k.autoSuggest.clearSuggestions()}if(k.xhr){k.xhr.abort();k.xhr=null}if(k.isValidSearchTerm(n)){k.originalSearchTerm=f.trim(n);n=n.toLowerCase();k.isRequestingPaginationData=false;k.removeElements(["results","pagination","error","close"],function(){k.search(n)})}return false});this.elements.component.delegate("."+this.classes.pagination+" a","click",g(this.paginationClick,this));this.elements.component.delegate("."+this.classes.results+" a","click",function(m){m.isLocalRegion=k.elements.results&&k.elements.results.find("."+k.classes.resultsLocalRegion).length>0;k.resultsClick.call(k,m)});if(this.options.autosuggest.enabled&&e){this.addAutoSuggest()}this.addGeolocationDetection()};c.prototype.addAutoSuggest=function(){var k=this.options.filter;var h=this.options.restrict_to_countries;var l=this.options.place_types;var j=a.interpolateRoute(window.locator.search[this.instanceId].routes.autosuggest,{lang:this.options.language});if(k){j+="&filter="+k}if(l.length>0){j+="&place_types="+l.join(",")}if(h.length>0){j+="&restrict_to_countries="+h.join(",")}var i=this;this.elements.input.attr("autocomplete","off");this.autoSuggest=new e(this.elements.input,j,this.instanceId);f(this.autoSuggest).bind("search",function(n,m){a.doIStatsAction("autocomplete_search",{ns_search_term:m})});f(this.autoSuggest).bind("item_selected",function(n,m){i.hasSelectedAutoSuggestion=true;g(i.resultsClick({target:m,isAutoComplete:true}),i)})};c.prototype.addGeolocationDetection=function(){var i,j,h="locator-search-"+this.instanceId;i=this.translations.reversegeocode;if(b.browserEnabled()&&this.options.reversegeocode.enabled===true){j=new b({permissionDenied:i.permission_denied,permissionUnavailable:i.detect_error,permissionDeniedTimeout:i.permission_denied_timeout,requestError:i.service_unavailable,position:"append",parentElement:f("#"+h),requestSuccess:function(k){if(!k.isWithinContext){j.displayError(i.outsideContext)}else{k.geolocation=true;this.locationData=k;this.handleLocation(this.locationData)}},context:this,reverseGeocodeRoute:window.locator.search[this.instanceId].routes.reversegeocode,language:this.language,buttonText:i.detect_label});j.render()}};c.prototype.load=function(){var i=a.interpolateRoute(window.locator.search[this.instanceId].routes.search),h=this;if(this.xhr){this.xhr.abort();this.xhr=null}this.xhr=a.ajax(i,function(m,o,l){if(m.html){var j=f(m.html),k=j.find("."+h.componentClass),n=j.find(".info");h.xhr=null;if(k.length){h.html=k;h.html.append(n);h.prepareDom()}}},function(j,l,k){h.xhr=null})};c.prototype.setIsWaitingToDisplayError=function(h){this.isWaitingToDisplayError=h};return c});