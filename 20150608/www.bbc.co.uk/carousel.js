define(["jquery-1","h4base","h4discoveryzone/animationflag","locator/locator","h4discoveryzone/lazyload"],function(L,V,P,D,x){var a=false;var g=L("#h4discoveryzone"),aj=null,ai=h4.discoveryzone.gridData,q=h4.discoveryzone.ajaxRoute,X=h4.discoveryzone.ajaxVersion,ah=h4.discoveryzone.errorPane,Y=h4.discoveryzone.newsRegion,e="focused",N=L("."+e),p="img-mask",s=L("<div />").attr("id","pane-wrapper"),M=L("<div />").attr("id","pane-wrapper-inner"),u=false,J="loadingnote",F=L("<a />").attr({id:J,href:"#h4discoveryzone"}).text("Loading..."),K=0.9,y=500,aa=600,U,k,G=0,af=null,Z=true,R=false,ae=null,l=V.getAudience(),m=L("html").attr("lang"),ag,A=[],B=1,Q=3,w=[],T=[],O={},ac=[],r="domestic";function C(){var ak,al=A.length;A=[];for(ak=0;ak<al-1;ak++){A.push(L(".pane-"+ak))}A.unshift(L(".pane-"+(al-1)));c();L(V).triggerHandler("reset_pagination_event")}function c(){if(P.isCarouselAnimating()&&V.isTouchDevice()&&!u){u=true;M.promise().done(function(){c()});return}var an=aj.offset().left,ak=aj.width()*5*4,al=L(window).width();var ap=L(".pane").index(L(".focused"))+1;ag=(G*ap-an)*-1;var ao=aj.outerWidth()+an,am=(al<ao)?ao:al;s.css({width:am,left:(an)*-1});M.css({width:ak,left:ag});M.remove(".pane");for(i=0;i<A.length;i++){M.append(A[i]);A[i].css("left",G*(i+1))}U.css("left",Math.round((aj.width()-an))*-1);k.css("left",Math.round(an+aj.width())+1);L("."+e).removeClass(e);A[B].addClass(e);ad();u=false}function j(am){var al;var ao=L("<div />").addClass("pane-inner");var an="";for(al=0;al<am;al++){if(L(".pane-"+al).hasClass("focused")){an=L(".pane-"+al).attr("id")}if(L(".pane-"+al).length>0){A[al]=L(".pane-"+al)}else{A[al]=L("<div />").addClass("pane pane-"+al).append(ao.clone())}}while(A[B].attr("id")!==an){A.unshift(A.pop())}L.each(A,function(ap,aq){M.append(aq.get(0))});s.append(M);s.insertBefore(L("#dz-arrow-previous",g));var ak=L("<div />").addClass("mask").fadeTo(0,K);U=ak.clone().attr("id","mask-left");k=ak.clone().attr("id","mask-right");s.append(U);s.append(k);f();c();z();L(window).resize(c)}function ab(am,ak){var al=L("<div />").html(am.html).text();al=L(al);ak.parent().attr("id",am.gridid);ak.empty().append(al.find(".grid-slot-container"));L(".promo",ak).addClass("closed")}function o(){if(P.isAnimating()){return}var al={version:X,audience:l||"domestic",lang:m||"en-GB",pagestate:I(),newsregion:Y||"london"};var ak=V.interpolateRoute(q,al);if(af){af.abort()}if(R===true){g.append(F);L("#"+J).focus()}af=L.ajax({url:ak,success:E,error:function(an){if(Z){j(Q);L(V).triggerHandler("attach_arrows_events")}var ao,ap;var am=function(){L(this).empty().append(ah).fadeIn();if(L.browser.msie&&L.browser.version<=7){L(this).bind("iedontcrash",function(){})}};for(ao=0;ao<=2;ao++){ap=L(".pane-"+ao);if(ap){if(!(Z&&ap.hasClass("focused"))){L(".pane-inner",ap).fadeOut(am)}}}Z=false},complete:function(){L(V).triggerHandler("json_load_success",[])}})}function I(){var ak="default";if(g.find(".breakingnews").length>0){ak="breakingnews"}else{if(g.find(".breakingsport").length>0){ak="breakingsport"}}return ak}function d(au,an,ar){if(af&&af.readyState!==4){return}if(P.isCarouselAnimating()){ac.push({direction:au,duration:an,easing:ar});return}P.incrementCarouselAnimationCounter();var aw=L(".pane:first"),ak=L(".pane:last"),aq=parseInt(ak.css("left"),10)+G,am=parseInt(aw.css("left"),10)-G;var av=L(".pane").length;var ap=L(".pane").index(L(".pane."+e))+1;var at=null;if(au==="previous"){var al=ap-1;if(al<=1){at=ak.clone(true,true);at.css("left",am);M.prepend(at)}ag=ag+G}else{var ao=av-ap;if(ao<=1){at=aw.clone(true,true);at.css("left",aq);M.append(at)}ag=ag-G}z();if(typeof an==="undefined"){an=aa}if(typeof ar==="undefined"){ar="swing"}M.animate({left:ag},an,ar,function(){P.decrementCarouselAnimationCounter();if(at){if(au==="previous"){ak.get(0).parentNode.removeChild(ak.get(0))}else{aw.get(0).parentNode.removeChild(aw.get(0))}}var ax=O[S()];if(au==="previous"){ax--;if(ax<0){ax=w.length-1}}else{ax++;if(ax>=w.length){ax=0}}t(w[ax]);A=[];L(".pane").each(function(az,aA){A.push(L(aA))});L("."+e).removeClass(e);N=L("#dz-grid"+S());N.addClass(e);B=L(".pane").index(N);if(ac.length>0){var ay=ac.shift();d(ay.direction,ay.duration,ay.easing)}else{ad();setTimeout(n,aa*1.25);v();L(V).triggerHandler("carousel_animate_stop",[au]);L(V).triggerHandler("carousel_pane_changed",[S()])}})}function H(aq){var ak=O[S()],al=O[aq],ap,ao,an,ar="linear",am;ap=al-ak;ao=(ap>0)?"next":"previous";ap=Math.abs(ap);an=aa/ap;L(V).triggerHandler("carousel_animate_start",[ao,aq]);for(am=1;am<=ap;am++){d(ao,an,ar)}}function z(am){if(!L.browser.msie&&L.browser.version!=="7.0"){return}var ak=document.body,ao=ak.getBoundingClientRect(),an=(ao.left-ao.right)/ak.offsetWidth,al=L(".pane, .promo h2 a").add(am);if(an!==-1){al.fadeTo(0,1)}else{al.css("filter","")}}function f(){var al="arrows_hover",ak=[{elm:L("#mask-left"),arrow:L("#dz-arrow-previous"),direction:"previous",pagination:-1},{elm:L("#mask-right"),arrow:L("#dz-arrow-next"),direction:"next",pagination:1}];L.each(ak,function(an,am){am.elm.bind("click touchend",function(ao){L(V).triggerHandler("carousel_scroll_initiated",["relative",am.direction,ao.type,"Carousel_Arrow_Click"]);L(V).triggerHandler("update_pagination",[am.pagination])});am.elm.mouseover(function(){if(!am.arrow.hasClass(al)){am.arrow.addClass(al)}h(am.direction)}).mouseleave(function(){am.arrow.removeClass(al);h()})})}function h(al){if(P.isAnimating()){return}var ak=ag;if(al){ak=(al==="next")?ak-20:ak+20}M.stop();M.animate({left:ak},400)}function ad(){var ak;for(ak=0;ak<A.length;ak++){if(ak===B){A[ak].find("a").removeAttr("tabindex")}else{A[ak].find("a").attr("tabindex","-1")}}}function n(){if(L("#"+J).length){F.remove()}if(ae==="keyboard"){var ak=L("."+e).find("a:first");ak.focus();ae=null}}function v(){L(".focused .module a").each(function(){var aq,am,al,an,ax,ap,ao,aw;aw=L(this);var at=aw.parents(".module");var av=aw.parent();if(av.is("h3")){return}if(av.hasClass("category")){return}ao=aw.parents(".focused").attr("class");var ar=/pane-(\d+)/.exec(ao);if(ar){am=ar[1]}else{return}ao=at.attr("class").split(" ");if(L.inArray("superpromo",ao)>=0){al="superpromo"}else{if(L.inArray("promo",ao)>=0){al="promo"}else{for(aq=0;aq<ao.length;aq++){if(ao[aq].substring(0,4)==="box-"){al="grid"+ao[aq].substring(4);break}}}}ao=at.attr("class");if(al==="promo"){ax="promo"}else{if(al==="superpromo"){ax="superpromo"}else{ao=at.find(".brand").attr("class");if(ao!==undefined){ao=ao.split(" ");for(aq=0;aq<ao.length;aq++){if(ao[aq]!=="brand"){ax=ao[aq];break}}}else{ax="none"}}}ap=1;if(av.is("li")){if(ax==="promo"||ax==="superpromo"){ap=av.index()+2}else{ap=av.index()+1}}if((ax==="promo"||ax==="superpromo")&&ap===1){an="image"}else{an=(aw.children("img").length)?"image":"text"}var ak=S().replace(/_/g,"");var au=[ak,am,al,an,ax,"link",ap].join("_");V.addiStatsLinkCarousel(this,au)})}function b(al,ak){t(ak);w=[];T=[];O={};var am=0;L.each(al,function(an){w.push(an);T.push(al[an].linkText);O[an]=am;am++})}function S(){if(!a){a=h4.discoveryzone.currentFlavour}return a}function t(ak){a=ak}function E(ak){P.incrementCarouselAnimationCounter();setTimeout(function(){P.decrementCarouselAnimationCounter();if(R===true){n()}},y*2);if(Z){j(ak.panes.length);L(V).triggerHandler("attach_arrows_events")}L(V).triggerHandler("flavour_titles_received",[ak.flavour_titles,S()]);L(V).triggerHandler("lazy_load_images_received",[ak.lazy_load_images]);L.each(ak.panes,function(al){if(Z&&L(".pane-"+al).hasClass("focused")){return}L(".pane-inner",".pane-"+al).fadeOut(y)});L(".pane-inner").promise().done(function(){L.each(ak.panes,function(al){if(Z&&L(".pane-"+al).hasClass("focused")){return}ab(ak.panes[al],L(".pane-inner",".pane-"+al));if(L.browser.msie&&L.browser.version<=7){L(".pane-"+al).bind("iedontcrash",function(){})}});if(Z){Z=false;ad()}L(".pane-inner").fadeIn(y);v();L(V).triggerHandler("carousel_ready")});L(V).triggerHandler("json_load_success",[])}function W(){if(N.length===0){return}aj=L("#h4-main");G=aj.width();L(V).bind("flavour_titles_received",function(am,al,an,ak){b(al,an,ak)});L(V).bind("carousel_scroll_initiated",function(ap,al,ak,an,ao){if(P.isAnimating()){return}ae=an;V.doLog(an,ao);L(V).triggerHandler("flavour_changed",[al,ak]);if(al==="relative"){var am=(ak==="previous")?-1:1;L(V).triggerHandler("update_pagination",[am]);L(V).triggerHandler("carousel_animate_start",[ak]);d(ak)}else{if(al==="absolute"){H(ak)}}});L(h4).bind("ie7ZoomFix",function(al,ak){z(ak)});L(D).bind("location_changed",function(al,am){V.setPortrayNation(false);if((am)&&(am.newsLocalRegions)){Y=am.newsLocalRegions[0].id;if(l==="domestic"&&am.location.nation){var ak={scotland:"sct",wales:"wls",northernireland:"nir"};if(ak[am.location.nation]){V.setPortrayNation(ak[am.location.nation])}}o()}});g.delegate(".module a","hover focus",function(){if(L(this).has("."+p)){L("."+p,this).stop();L("."+p,this).fadeTo(100,1)}});g.delegate(".module a","mouseleave blur",function(){if(L(this).has("."+p)){L("."+p,this).stop();L("."+p,this).fadeTo(100,0,function(){L(this).hide()})}});E(ai)}return{init:W,peekPanes:h}});