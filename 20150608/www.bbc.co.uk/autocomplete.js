define(["jquery-1","locator/utils"],function(e,j){var a=function(l,m){this.isAppendedToDom=false;this.isShown=false;this.$element=l;this.$attachedTo=m};a.prototype.show=function(){if(!this.isAppendedToDom){this.$element.appendTo(e("body"));this.isAppendedToDom=true}var l=this.$attachedTo.width();this.$element.css("width",l);this.$element.show();this.isShown=true};a.prototype.hide=function(){this.$element.hide();this.isShown=true};a.prototype.nextTo=function(l){var r=this.$element.outerWidth(),q=this.$element.outerHeight(),m=l.offset(),o=l.outerWidth(),n=l.outerHeight(),p=m.left;targetTop=m.top+n;this.$element.css({left:p,top:targetTop})};var c=500,f=2,b="suggestion-active",d="search",k="item_selected";var h=function(o,n,m){if(!o||0===o.length||o[0].tagName!=="INPUT"){throw ("$input must be defined and cannot be empty.")}var l=this;if(typeof n!=="string"){throw ("Please provide a data source URL")}if(typeof m!=="string"){l.searchInstanceId="default"}else{l.searchInstanceId=m}l.keyCode={ESCAPE:27,UPARROW:38,DOWNARROW:40,ENTER:13,TAB:9};l.xhr=null;l.$input=o;l.dataSource=n;l.userText="";l.currentText="";l.dataQueryText="";l.timeoutId=null;l._defaultMenuMarkup='<div class="locator-suggestions locator-suggestions-'+l.searchInstanceId+'" role="listbox"><ul></ul></div>';l.overlay=new a(e(l._defaultMenuMarkup),e(".locator-search-input"));l.$suggestionList=l.overlay.$element.find("ul");l.hasMousedDownOnSuggestion=false;l._hasBoundKeyCodeEvents=false;l.$input.bind("focus",function(){l.hasMousedDownOnSuggestion=false;l.blurTimer=setTimeout(function(){l.clearSuggestionsIfRequired(false)},0);l._bindKeyCodeEvents()});if(l.$input.is(":focus")){l._bindKeyCodeEvents()}l.$input.bind("blur",function(){l.blurTimer=setTimeout(function(){l.clearSuggestionsIfRequired(true)},0)})};h.prototype._getFromUrl=function(m,l){var n=this;m=m.toLowerCase();e(this).trigger(d,m);this.xhr=e.ajax({url:l.replace(/\{input\}/g,m),dataType:"json",cache:true,success:function(o){n.$input.removeClass("loading");n.dataReady(o)},error:function(o,q,p){n.$input.removeClass("loading");n.clearSuggestions();if("abort"!==q){n.$input.unbind("blur");n.$input.unbind("focus");n._unbindKeyCodeEvents();n.$input.attr("autocomplete","on")}}})};h.prototype.dataReady=function(l){var q=this,o,n,p;this.clearSuggestions();if(0===l.length){return}for(o=0;o<l.length;o++){n=l[o];n.fullNameTruncated=j.truncate(n.fullName,window.locator.search[this.searchInstanceId].options.truncationLengths.autocomplete);n.uri=j.interpolateRoute(window.locator.search[this.searchInstanceId].routes.targetUri,{location_id:n.id});p=e('<li><a id="locator-ac-'+n.id+'" href="'+n.uri+'" title="'+n.fullName+'">'+n.fullNameTruncated+"</a></li>");p.find("a").data("result",n);q.$suggestionList.append(p)}var m;q.$suggestionList.children().bind({mouseenter:function(r){q.itemHighlighted(e(this)[0])},click:function(r){r.preventDefault();q.itemSelected(e(this)[0])},mousedown:function(){q.hasMousedDownOnSuggestion=true;setTimeout(function(){e("body").one("mousedown",function(){if(q.hasMousedDownOnSuggestion){q.hasMousedDownOnSuggestion=false;q.clearSuggestionsIfRequired(true)}})},0)},mouseup:function(){q.hasMousedDownOnSuggestion=false;q.blurTimer=setTimeout(function(){q.clearSuggestionsIfRequired(true)},0)}});q.overlay.nextTo(q.$input);q.overlay.show()};h.prototype.clearSuggestionsIfRequired=function(l){if(!this.hasMousedDownOnSuggestion){this.clearSuggestions();if(l){this._unbindKeyCodeEvents()}}};h.prototype.inputChanged=function(){var p=this,r=p.$input.val(),n=r.replace(/^\s\s*/,"").replace(/\s\s*$/,""),o=""===n,m=n.length>=f,l=window.locator.search[this.searchInstanceId].options.prompt;if(r===l||!m||o){p.clearSuggestions();if(o){p.userText=""}return false}if(r===p.userText){return false}p.userText=r;p.$input.addClass("loading");var q=e(".locator-search-input").width()-17;e(".loading").css("background-position",q);p._getFromUrl(n,p.dataSource)};h.prototype.clearSuggestions=function(){if(this.xhr){this.xhr.abort();this.xhr=null}if(this.timeoutId){clearTimeout(this.timeoutId)}this.$suggestionList.children().remove();this.overlay.hide()};h.prototype.itemSelected=function(l){var m=e(l).find("a").attr("title");this.$input.val(m);e(this).trigger(k,l);this.clearSuggestions()};h.prototype.itemHighlighted=function(l){this.$suggestionList.children().removeClass(b);e(l).addClass(b)};var i,g={downs:0,presses:0,reset:function(){this.downs=0;this.presses=0}};h.prototype._keyPressHandler=function(l){g.presses++;if(g.downs===1&&g.presses>1){return i._keyDownAction(l)}};h.prototype._keyDownHandler=function(l){g.downs++;return i._keyDownAction(l)};h.prototype._keyUpHandler=function(l){g.reset();switch(l.keyCode){case i.keyCode.DOWNARROW:case i.keyCode.UPARROW:case i.keyCode.ESCAPE:case i.keyCode.ENTER:break;default:if(i.$input.val()!==i.currentText){i.currentText=i.$input.val();if(i.timeoutId){clearTimeout(i.timeoutId)}i.timeoutId=setTimeout(function(){i.inputChanged()},c)}}};h.prototype._keyDownAction=function(p){var m=i.$suggestionList.children(),l=i.$suggestionList.find("."+b),o;function n(r){var q=e(r).find("a"),s=q.text(),t=q.attr("title");if(t){s=t}clearTimeout(i.timeoutId);i.itemHighlighted(r);i.currentText=s;i.$input.val(t)}switch(p.keyCode){case i.keyCode.DOWNARROW:if(!m.length){return}if(l.length!==0){o=l.next()[0]}if(!o){o=m.first()[0]}n(o);break;case i.keyCode.UPARROW:if(!m.length){return}if(l.length!==0){o=l.prev()[0]}if(!o){o=m.last()[0]}n(o);break;case i.keyCode.ESCAPE:clearTimeout(i.timeoutId);i.clearSuggestions();i.$input.val(i.userText);break;case i.keyCode.ENTER:if(l.length){clearTimeout(i.timeoutId);i.itemSelected(l[0])}p.stopPropagation();break;default:}};h.prototype._bindKeyCodeEvents=function(){i=this;if(i._hasBoundKeyCodeEvents){return}i._hasBoundKeyCodeEvents=true;g.reset();this.$input.keydown(this._keyDownHandler);this.$input.keyup(this._keyUpHandler);this.$input.keypress(this._keyPressHandler)};h.prototype._unbindKeyCodeEvents=function(){this._hasBoundKeyCodeEvents=false;this.$input.unbind("keydown",i._keyDownHandler);this.$input.unbind("keyup",i._keyUpHandler);this.$input.unbind("keypress",i._keyPressHandler)};return h});