window.locator=window.locator||{};if(!window.locator.bootstrap){window.locator.bootstrap="locator/bootstrap"}define([window.locator.bootstrap,"istats-1","domReady!"],function(c,a){var d;d=c.$;function e(i,h){var g;for(g in h){if(h.hasOwnProperty(g)&&!i.hasOwnProperty(g)){i[g]=h[g]}}return i}function f(h,g){return function(){return h.apply(g,arguments)}}function b(g){g=g||{};this.options=e(g,{position:"append",requestError:'Sorry the "detect your location" feature is not currently available',buttonText:"Detect your location",requestSuccess:function(){},parentElement:null,geoOptions:{enableHighAccuracy:true,maximumAge:600000,timeout:30000},language:"en-GB",reverseGeocodeRoute:"/locator/default/:lang/reversegeocode.json?latitude=:latitude&longitude=:longitude"});this.awaitingResponse=false}b.browserEnabled=function(){return(typeof navigator.geolocation!=="undefined")};b.prototype.render=function(){var g,i,h;h=d("form",this.options.parentElement);g='<button type="button" class="geolocation-button"><span>'+this.options.buttonText+"</span></button>";switch(this.options.position){case"before":h.before(g);break;case"after":h.after(g);break;case"append":h.append(g);break;default:h.append(g)}d(this.options.parentElement).addClass("locator-search-geolocation");this.element=d("button.geolocation-button",this.options.parentElement);i=f(this.clickHandler,this);if(this.element.on){this.element.on("click",i)}else{c.addEvent(this.element[0],"click",i,false)}};b.prototype.clickHandler=function(j){if(j.preventDefault){j.preventDefault()}else{c.preventDefault(j)}this.element.addClass("waiting");if(this.awaitingResponse===false){this.awaitingResponse=true;var g=this;var i=false;var h=function(k){if(!i){g.geolocationSuccess(k);i=true}};window.navigator.geolocation.getCurrentPosition(h,f(this.geolocationError,this),this.options.geoOptions)}};b.prototype.normaliseCoordinate=function(h){var g=1000;return Math.round(h*g)/g};b.prototype.displayError=function(h){var g;g=this.options.parentElement;d(".locator-geolocate-error",g).remove();d("button.geolocation-button",g).after('<p class="locator-geolocate-error">'+h+"</p>")};b.prototype.geolocationSuccess=function(h){var j,g,i,l,k;i=this;l=this.normaliseCoordinate(h.coords.latitude);k=this.normaliseCoordinate(h.coords.longitude);j=this.options.reverseGeocodeRoute;j=j.replace(":latitude",l).replace(":longitude",k).replace(":lang",this.options.language||"en-GB");j+="&filter=domestic";g={url:j,error:function(){i.awaitingResponse=false;i.element.removeClass("waiting").addClass("disabled");i.displayError(i.options.requestError)},success:function(){var m;m=i.options.context||this;i.awaitingResponse=false;i.element.removeClass("waiting");i.options.requestSuccess.apply(m,arguments)}};c.request(g);a.log("geo_location","locator",{longitude:k,latitude:l})};b.prototype.geolocationError=function(g){this.awaitingResponse=false;this.element.addClass("disabled");var h="";switch(g.code){case g.PERMISSION_DENIED:h=this.options.permissionDenied;break;case g.POSITION_UNAVAILABLE:h=this.options.permissionUnavailable;break;case g.PERMISSION_DENIED_TIMEOUT:h=this.options.permissionUnavailable;break}this.displayError(h)};return b});