define(["jquery","OK/logger"],function(aq,R){var ao,W=null,U=null,ak="mtLayer",M="mtLayerMain",ac="mtLayerBack",ay="mtLayerForward",c="scrollToTopMtLayer",ai="media-layer media-layer__topic __redesign",j="media-layer_hld",aj="mlr_disc",aa="media-layer_close",at="media-layer_close_ico",d="sticky-plank_cnt",T="media-layer_fixer",af=310,i=null,F=null,x=null,o=null,b=null,w=null,aB=null,n=null,av=null,O=1145,D={id:null,to:75},L="MediaTopicLayerBody",l="layer__disabled",v="invisible",p="data-open-count",g="data-slide-count",aA="data-slide-count-per-open",f=false,ar,Q,a=false,G={showIfAllowed:function(){},hide:function(){},};function A(aH,aF){var aG=document.getElementById(aH),aE;if(!aG){return false;}for(aE=0;aE<aF.length;aE+=1){if(aG.classList.contains(aF[aE])){return false;}}return true;}function X(){return ao.isActive&&!aq("#hook_Block_PopLayerMediaTopic").hasClass(l);}function u(){return ao.isActive&&aq("#hook_Block_PopLayerMediaTopic").hasClass(l);}function y(aE){if(X()){if(!a&&i[0]!==document.activeElement&&i.find(document.activeElement).length===0){i.focus();a=true;}if(i.hasClass("__edit")||i.find(".__edit").length>0){return;}if(i.find(".tag-box__editable").length>0){return;}if(A("hook_Modal_popLayerModal",[l])){return;}if(A("photoLayerWrapper",[l,v])){return;}if(A("video-poplayer-cnt",[l,v])){return;}if(aE.keyCode===39&&n){n.click();OK.stop(aE);}else{if(aE.keyCode===37&&aB){aB.click();OK.stop(aE);}}}}function z(aE){if(aE){OK.Layers.register(ak,function(){P("cr_esc");},undefined,false,y);}else{OK.Layers.remove(ak);}}function Y(aE,aF){OK.loader.use("OKCustomJs",function(){if(aE){z(aF);}if(aF){if(OK.Layers.onLayerShown){OK.Layers.onLayerShown();}}else{if(OK.Layers.onLayerHidden){OK.Layers.onLayerHidden();}}});}function J(){U.toggleClass("__layer",!!ao.isActive);}function ax(){var aE=ai;if(ao.isActive){aE+=" __active";}if(ao.isProcess){aE+=" __process";}if(ao.isEditMode){aE+=" __edit";}i.attr("class",aE);}function am(){Y(true,ao.isActive);J();ax();if(ao.isActive){q();}}function q(){k(p);i.attr(aA,0);}function aC(){k(g);k(aA);}function k(aE){var aF=parseInt(i.attr(aE),10);if(isNaN(aF)){aF=0;}i.attr(aE,aF+1);}function E(aF){var aE=ao.isActive!==aF;ao.isActive=aF;if(aE){am();}else{if(u()){Y(false,true);}}document.getElementById("hook_Block_PopLayerMediaTopic").classList.remove(l);}function ag(aE){var aF=ao.isProcess!==aE;ao.isProcess=aE;if(aF){ax();}}function au(aE){var aF=ao.isEditMode!==aE;ao.isEditMode=aE;if(aF){ax();}}function s(aE){F.toggleClass("__process",aE);}function H(aG,aE){var aH=aG.length,aF=aH;while(--aH+1){aG[aH].toggleClass(aE);}setTimeout(function(){while(--aF+1){aG[aF].toggleClass(aE);}},1);}function B(){if(o){var aE=0;aq(".comments_i",o).each(function(){var aF=aq(this).data("unread");if(aF){aE=this.getBoundingClientRect().top;}return !aF;});i.each(function(){this.scrollTop=(aE!==0)?this.scrollTop+aE:this.scrollHeight;});setTimeout(function(){aq(".js-comments_add",o).focus();},50);}}function r(aJ,aG,aI){var aF=aq(window),aE=aF.height(),aH=aF.width();if(D.id){clearTimeout(D.id);}D.id=setTimeout(function(){H([w,n,aB,av],T);D.id=null;},aJ?0:D.to);i.toggleClass("__compact",aH<=O);i.toggleClass("__min-height",(aE<af));if(aG){B();}if(aI){ae(aI);}}function t(aE){if(f){return;}f=true;W=aq(window);U=aq(document.body);i=aq("#"+ak);F=aq("#"+M);aB=aq("#"+ac);n=aq("#"+ay);av=aq("#"+c);ao={isActive:i.hasClass("__active"),isProcess:i.hasClass("__process"),isEditMode:i.hasClass("__edit")};x=i.find("."+j);w=x.find("."+aa);w.click(function(aH){var aG="cr_shadow",aF=OK.eventTarget(aH);if(aq(aF).hasClass(at)){aG="cr_close";}P(aG);});if(ao.isActive){am();if(!ao.isProcess){r(true,aE);}}if(aE){B();}W.on("resize.mtLayer",function(){r();});}var e;var V;var az;function S(aF,aE){if(aE==null||aE.length==0){return;}OK.historyManager.putItemToCache(aF,aE);}function ap(aF){if(OK.historyManager.isHistorySupported()){var aG=aF.indexOf("?");if(aG>0){az=aF.substr(aG+1);V=aF.substr(0,aG);if(az.length>0){az+="&mt.scrollTop="+aq(window).scrollTop();}else{az=null;}S(V,az);}else{V=aF;az=null;}var aH=K()==V&&!Q;var aE;if(!e){if(aH){aE=true;}else{if(Q){aw(Q,true);}}e=K();}else{aE=!ao.closeTopicId;}Q="";if(!aH){aw(V,aE);}}}function I(){if(!e&&V==K()){aw(e,true);}e=null;V=null;az=null;}function K(){return OK.historyManager.getState();}function aw(aF,aE){if(aE){OK.historyManager.replaceState(aF);}else{OK.historyManager.pushState(aF);}}function P(aJ){a=false;ao.topicId=null;ao.owner=null;var aH=ao.closeTopicId,aE=ao.closeOwnerType;ao.closeTopicId=null;ao.closeOwnerType=null;if(aH&&(aJ==="cr_esc"||aJ==="cr_shadow"||aJ==="cr_close"||aJ==="cr_fail")){if(aJ){ab(aJ+"_ct");}setTimeout(function(){if(OK.historyManager.isHistorySupported()){OK.historyManager.back();}else{an(aH,aE,"");}},0);return;}var aG=X();var aF=false;if(aG){if(e&&V==K()){if(e==V){aF=true;OK.historyManager.back();}else{aw(e,true);}}}if(!aF){E(false);ag(false);au(false);s(false);m();ah();av.removeClass("__active __animated");OK.hookModel.setHookContent(L,"");}e=null;if(aJ){ab(aJ);}i.trigger("mtLayer.close");try{G.hide();}catch(aI){ab("adsCloseError");}}function ab(aE){R.success("mtlayer",ar||"",aE);}function m(){aB.removeClass("__active");n.removeClass("__active");}function N(aE,aF){if(aB){aB.toggleClass("__active",!!aE&&!!aF);aB.unbind("click.back").bind("click.back",function(aH){if(aB.hasClass("__active")){var aG=n.hasClass("__active");an(aE,aF,"MT_GoBack_"+aF,false,"","BACK",aG);}OK.stop(aH);});}}function h(aE,aF){if(n){n.toggleClass("__active",!!aE&&!!aF);n.unbind("click.forward").bind("click.forward",function(aH){if(n.hasClass("__active")){var aG=aB.hasClass("__active");an(aE,aF,"MT_GoForward_"+aF,false,"","FORWARD",aG);}OK.stop(aH);});}}function ae(aG){if(aG){var aH=i.find("[data-scroll-to='"+aG+"']");if(aH.length>0){var aL=aH[0],aK=aL.offsetTop,aE=aL.offsetParent;while(aE&&aE.nodeType===1&&aE!==i[0]){aK+=aE.offsetTop;aE=aE.offsetParent;}var aJ=i,aI=aJ.height(),aF=aJ.scrollTop(),aM=aI;if(aF+aI<=aK+aM){aJ.scrollTop(aK+aM-aI-5);}else{if(aF>aK){aJ.scrollTop(aK-5);}}}}}function ah(){var aE=U;var aF=aE.find(".gwt-shortcutMenu__show");if(aF.length){aF.removeClass("gwt-shortcutMenu__show");}var aG=aE.find(".sc-menu:not(.sc-menu__hidden,.poll_ans_cnt)");if(aG.length){aG=aG.not("#ownProfileLSMnu");aG.addClass("sc-menu__hidden");}}var aD=[0,1,2,3,5,8,13,21,34,55,89,144,233,377,610];function al(aF,aH){var aG=(aH-aF)/100;var aE;for(aE=1;aE<aD.length;aE++){if(aG<aD[aE]){break;}}return aD[aE-1]+"00";}function Z(){if(i){i.scrollTop(0);}}function ad(aE){if(ao.isProcess){ag(false);}else{s(false);}aE&&aE();}function C(aH,aN,aK,aP,aQ){Q=aN;t(aK);var aF=aq("#"+L);var aM=aF.attr("data-log");if(aM){ab(aM);}au("true"==aF.attr("data-edit-mode"));var aG=aF.attr("data-url");if(aG){ap(aG);}else{I();}if(ao.closeTopicId||aP){}else{var aJ=aF.attr("data-back-id");N(aJ,aH);var aI=aF.attr("data-forward-id");h(aI,aH);}var aO=aF.attr("data-id");if(aO){ao.topicId=aO;ao.owner=aH;}var aE=aF.attr("data-log-click");if(aE){i.attr("data-log-click",aE);}else{i.removeAttr("data-log-click");}if(!ao.isProcess){ax();}ad(aQ);H([n,aB,av],T);Z();o=x.find("."+aj);b=x.find("."+d);var aL=aF.attr("data-scroll-to-marker");r(true,aK,aL);}function an(aO,aG,aF,aI,aN,aR,aT,aS,aQ,aM,aP,aK){var aL=+new Date();var aH;t(aI);if(!aR){ao.closeTopicId=null;ao.closeOwnerType=null;}if(aF&&aF.indexOf("st.mt.or=on")!==-1){aQ=ao.topicId;aM=ao.owner;}if(OK.photoLayer){OK.photoLayer.close();}OK.VideoPlayer.pauseAll();OK.loader.use("OKCustomJs",function(){var aV=OK.Layers.stack;var aW=aV&&aV.length>0&&aV[aV.length-1].id===ak;if(!aW&&ao.isActive){z(true);}});function aU(aX){var aW=Date.now();var aV="";if(aX){aV+="r_";}if(aR){aV+="dt";}else{aV+="ot";}ab(aV+al(aL,aW));if(aH){ab("js_"+aV+al(aH,aW));}}ar=aG;Q=aN;if(Q){ab("shortlink");}m();if(ao.isActive&&!ao.isProcess){s(true);ah();}else{ag(true);}E(true);var aE;if(OK.getCurrentStateLink){aE=OK.getCurrentStateLink();}else{aE="/dk?"+window.pageCtx.state.replace("&amp;","&");}aE+=aE.indexOf("?")===-1?"?":"&";aE=aE.replace(/st\.mt\.(id|ot|bi|dir|hn).*?(&|$)/g,"");aE+="cmd="+L;if(aF){aE+="&st._aid="+aF;}var aJ=aq.ajax({type:"POST",url:aE,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":aO,"st.mt.ot":aG,"st.mt.dir":aR,"st.mt.wc":aS?"on":"off","st.mt.hn":aP?"on":"off","st.mt.bi":aK?aK:0},headers:{TKN:OK.tkn.get()}});aJ.done(function(aX,aV,a4){aH=Date.now();if(aQ){ao.closeTopicId=aQ;ao.closeOwnerType=aM;}var a0=a4.getResponseHeader("Redirect-Location");if(a0){var a1=function(a5){if(OK.navigation.redirect){OK.navigation.redirect(a0);}if(a5===0||OK.navigation.redirect){P();aU();}else{setTimeout(function(){a1(a5-1);},200);}};a1(5);}else{var aY=a4.getResponseHeader("End-Reached");if(aY==="yes"){if(aR==="FORWARD"){if(aT){aB.toggleClass("__active",true);}}else{if(aR=="BACK"){if(aT){n.toggleClass("__active",true);}}}ad(aU);return;}var aZ=aX.split(OK.navigation.SPLITER),a2=a4.getResponseHeader(OK.navigation.HEADER).split(",");for(var aW=0;aW<aZ.length;aW++){if(a2[aW]){OK.hookModel.setHookContent(a2[aW],aZ[aW]);}}if(aR){aC();}try{G.showIfAllowed();}catch(a3){ab("adsOpenError");}C(aG,Q,aI,aP,aU);}});aJ.fail(function(){P("cr_fail");aU();});return aJ;}return{show:function(){t();E(true);Z();},showPreloaded:C,showTopicInLayer:an,closeLayer:function(){if(f){P();}},hideLayer:function(){a=false;if(ao&&ao.isActive){if(e&&K()==V){aw(e,true);}Y(false,false);}},restoreLayer:function(){if(ao&&ao.isActive){H([w,n,aB,av],T);if(e&&K()!==V){aw(V,true);}Y(false,true);}},refreshLayerBody:function(aH){function aE(){if(aH){aH();}}if(!ao||!ao.topicId||!ao.owner){aE();return;}var aF="/";if(OK.getCurrentStateLink){aF=OK.getCurrentStateLink();}aF+=aF.indexOf("?")===-1?"?":"&";aF+="cmd="+L+"&st._aid=PLPhotoUserBackToView";var aG=aq.ajax({type:"POST",url:aF,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":ao.topicId,"st.mt.ot":ao.owner},headers:{TKN:OK.tkn.get()}});aG.done(function(aM,aO,aN){var aJ=aN.getResponseHeader("Redirect-Location");if(aJ){if(OK.navigation.redirect){OK.navigation.redirect(aJ);}P();}else{var aI=aM.split(OK.navigation.SPLITER),aL=aN.getResponseHeader(OK.navigation.HEADER).split(",");for(var aK=0;aK<aI.length;aK++){if(aL[aK]){OK.hookModel.setHookContent(aL[aK],aI[aK]);}}}aE();});aG.fail(aE);},deactivate:function(){aq(window).off(".mtLayer");E(false);},isActiveAndNotHidden:function(){if(!f){return false;}return X();},adsHandlers:function(){return G;},logAdsOpen:function(){ab("adsOpen");}};});