define(["jquery","swfobject","OK/logger","okVideoPlayerUtils"],function(g,c,x,r){function k(E,B,y,z){var D=g("#"+E),A=g("<div/>",{"class":"vp_video_stub_w"}),C=g("<div/>",{"class":"vp_video_stub __na"}).appendTo(A);g("<div/>",{"class":"vp_video_stub_txt",html:(B||"")}).appendTo(C);if(z){D.replaceWith(A);D=A;}else{D.append(A);}if(y){g("<img/>",{width:"100%",src:y,"class":"vp-video_stub_i"}).insertBefore(A);}return D;}function s(y){for(var z in y){if(y.hasOwnProperty(z)){if(typeof y[z]!=="string"){y[z]=encodeURIComponent(JSON.stringify(y[z]));}}}return y;}function n(y){return y+"C";}function u(y){return y+"E";}function a(y){y.isExternalPlayer&&g.ajax({url:"/dk?cmd=videoStatNew",contentType:"application/json",type:"POST",data:JSON.stringify({duration:0,contentId:y.url,location:y.flashvars.location,providerId:y.provider,batch:[{name:"started"}]})}).error(function(){x.error("OKVideoStart","failOG");});}function i(y){return g.ajax({url:decodeURIComponent(y),dataType:"json",type:"GET",headers:{TKN:OK.tkn.get()}});}function o(z,y){return g.ajax({url:"/dk?cmd=videoCommand&a=getVideoPlayerAttributes&st.vv_movieId="+z+"&st.location="+y,dataType:"json",type:"GET",headers:{TKN:OK.tkn.get()}});}function e(A){var B=A.flashvars.metadata.liveStreamInfo;if(!B){return true;}var C=parseInt(B.startTime,10),y=parseInt(B.endTime,10),z=Date.now()+A.timeshift;return !!((!y||z<=y)&&(!C||z>C));}function w(y){OK.VideoPlayer.playersCache.push(y);}function v(y){var z=OK.VideoPlayer.playersCache.indexOf(y);if(z>=0){OK.VideoPlayer.playersCache.splice(z,1);}}function j(z,y){require(["okHtml5Player"],function(A){v(y);A.embedPlayer(y,y,z.flashvars);});}function h(B,A){if(c.getObjectById(A)){return;}var C=c.hasFlashPlayerVersion(B.minFlashVersionNewPlayer||"11.2.0")&&B.url11?B.url11:B.url;var z={id:A,name:A};var D={allowScriptAccess:B.asa?"always":"never",wmode:B.wmode||"opaque",allowFullScreen:true,menu:false,bgcolor:"#000000"};var y=s(g.extend({},B.flashvars,{autoplay:true,wmode:D.wmode,stageVideo:D.wmode=="direct"||D.wmode=="gpu",playerId:B.playerId}));c.embedSWF(C,A,"100%","100%","10.0.0",null,y,D,z);w(A);a(B);}function p(z,y){v(y);var A=document.createElement("iframe");A.id=y;A.width="100%";A.height="100%";A.tabIndex="999";A.frameBorder="no";A.scrolling="no";A.allowFullscreen=true;A.src=z.url;var B=document.getElementById(y);B.parentNode.replaceChild(A,B);a(z);}function m(L,D,B){var J=L.flashvars.metadata.liveStreamInfo,C=Date.now()+L.timeshift,A=parseInt(J.startTime,10),F=parseInt(J.endTime,10),K=g("#"+D);function G(R,Q){var P=~~((R-Q)/1000),O=~~(P/3600),M=~~(P/60)%60,N=P%60;return(O<10?"0"+O:O)+":"+(M<10?"0"+M:M)+":"+(N<10?"0"+N:N);}var z=g("<div/>",{id:B,"class":"vp_broadcast-stub_w"}),E=g("<div/>",{"class":"vp_video_stub_w"}).appendTo(z),H=g("<div/>",{"class":"vp_broadcast-stub"}).appendTo(E);g("<img/>",{width:"100%",src:L.poster,"class":"vp-video_stub_i"}).appendTo(z);g("<div/>",{"class":"vp_broadcast-stub_tx",html:F&&F<C?L.liveEndedText:L.liveUnstartedText}).appendTo(H);g("#"+B).replaceWith(z);if(A>C){var y=g("<div/>",{"class":"vp_broadcast-stub_time js-live-time",text:G(A,C)}).appendTo(H);var I=setInterval(function(){C=Date.now()+L.timeshift;if(A<C){clearInterval(I);q(L,D,B);return;}y.text(G(A,C));},1000);K.data("startTimer",I.toString());}}function q(N,C,A){if(typeof N.flashvars.metadata==="string"){N.flashvars.metadata=JSON.parse(N.flashvars.metadata);}if(typeof N.flashvars.translations==="string"){N.flashvars.translations=JSON.parse(N.flashvars.translations);}var H=r.dash,J=r.mp4,F=c.getFlashPlayerVersion().major>=10,z=!!(N.flashvars.metadata&&N.flashvars.metadata.metadataEmbedded),K=N.flashvars.metadata.liveStreamInfo,M=g("#"+C),I=g("#"+A);function E(){try{p(N,A);}catch(O){k(C,null,null,true);}}function L(){if(J){j(N,A);}else{k(C,N.noFlashText,N.noFlashImage,true);}}function B(){if(!F){k(C,N.noFlashText,N.noFlashImage,true);}else{r.checkFlashStatus(function(O){if(O===r.FLASH_BLOCKED){k(C,N.noFlashText,N.noFlashImage,true);}else{h(N,A);}});}}function D(){if(H){j(N,A);}else{if(!F){L();}else{r.checkFlashStatus(function(O){if(O===r.FLASH_BLOCKED){L();}else{h(N,A);}});}}}function G(){if(N.isIframePlayer){E();}else{if(N.isExternalPlayer||!N.isHtml5Player){B();}else{if(z){D();}else{if(J){j(N,A);}else{B();}}}}}function y(){var P=parseInt(K.endTime,10),R=Date.now()+N.timeshift;if(P&&R<P){var Q=~~((parseInt(K.endTime,10)-R)/1000);var O=setTimeout(function(){q(N,C,A);},Q*1000+3000);M.data("endTimer",O.toString());}}if(!I.length){M.hide();g("<div>",{id:A}).insertAfter(M);}if(e(N)){K&&y();G();}else{m(N,C,A);}}function f(y,A,z){A=A||n(y.playerId);z=z||u(y.playerId);if(!y.timeshift){y.timeshift=y.timestamp?parseInt(y.timestamp,10)-Date.now():0;}if(!y.flashvars.metadata&&y.flashvars.metadataUrl){i(y.flashvars.metadataUrl).done(function(B){y.flashvars.metadata=B;delete y.flashvars.metadataUrl;q(y,A,z);}).error(function(){k(A,null,null,true);});}else{q(y,A,z);}}function l(A,B,C,y,z){o(A,z).always(function(D){D=D||{flashvars:{}};D.playerId=B||D.playerId||null;D.width=C||D.width||null;D.height=y||D.height||null;if(D.error||!D.url){var E=k(n(D.playerId),D.error).css("display","block");D.width&&E.width(D.width);D.height&&E.height(D.height);}else{f(D);}});}function t(y){f(JSON.parse(y.getAttribute("data-attributes")),y.id,y.id+"Object");}function d(E){var K=g(E),A=K.data("playerContainerId"),z=K.data("playerElementId"),M=K.data("options"),L=K.data("autostart"),J=K.data("viewportTimeout"),G=K.data("viewportDisabledIfMusic"),y=K.data("hoverTimeout"),C=K.data("hoverDisabledIfMusic"),D=K.data("isBannerVideo");M.timeshift=M.timestamp?parseInt(M.timestamp,10)-Date.now():0;if(D){var F,H=K.closest(".js-banner-wrapper-pointer");if(H.length){F=g("#"+H.data("bannerWrapperId"));}else{F=K.closest(".js-banner-wrapper");}if(F.length){var I=F.children(".adv-px");if(I.length){var B={};I.each(function(){var O=g(this),N=O.data("type"),P=O.data("src");if(typeof B[N]==="undefined"){B[N]=[];}B[N].push(P);});M.flashvars.pixels=B;}}}if(!K.find("#"+A).length){g("<div>",{id:A,"class":"vid-card_cnt_w"}).css({width:"100%",height:"100%"}).append(g("<i>",{"class":"vid_play"})).appendTo(K);}K.find("#"+A).on("click",function(N){N.preventDefault();f(g.extend(true,{},M),A,z);});if(L){f(g.extend(true,{},M),A,z);}if(J){require(["OK/VideoAutoplayFlow"],function(N){N.activateViewportPlayer(g.extend(true,{},M),A,z,J,G);});}if(y){require(["OK/VideoAutoplayFlow"],function(N){N.activateHoverPlayer(g.extend(true,{},M),A,z,y,C);});}}function b(A){var z=g(A),E=z.data("playerContainerId"),D=z.data("viewportTimeout"),B=z.data("hoverTimeout"),F=g("#"+E),C=parseInt(F.data("startTimer"),10),y=parseInt(F.data("endTimer"),10);if(D||B){require(["OK/VideoAutoplayFlow"],function(G){G.deactivateHoverPlayer(E);G.deactivateViewportPlayer(E);});}if(C||y){clearInterval(C);clearTimeout(y);}}return{activate:d,deactivate:b,createPlayer:l,start:f,activatePlayer:t};});