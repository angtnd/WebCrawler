define(["jquery","swfobject","OK/logger","okVideoPlayerUtils"],function(h,c,E,y){var r=null;var z=null;var q={};h(window).on("onMusicPlaying",function(){if(q.isExternalPlayer){w();}else{C("pause");}});function n(L,I,F,G){var K=h("#"+L),H=h("<div/>",{"class":"vp_video_stub_w"}),J=h("<div/>",{"class":"vp_video_stub __na"}).appendTo(H);h("<div/>",{"class":"vp_video_stub_txt",html:(I||"")}).appendTo(J);if(G){K.replaceWith(H);K=H;}else{K.append(H);}if(F){h("<img/>",{width:"100%",src:F,"class":"vp-video_stub_i"}).insertBefore(H);}return K;}function B(F){for(var G in F){if(F.hasOwnProperty(G)){if(typeof F[G]!=="string"){F[G]=encodeURIComponent(JSON.stringify(F[G]));}}}return F;}function a(F){F.isExternalPlayer&&h.ajax({url:"/dk?cmd=videoStatNew",contentType:"application/json",type:"POST",data:JSON.stringify({duration:0,contentId:F.url,location:F.flashvars.location,providerId:F.provider,batch:[{name:"started"}]})}).error(function(){E.error("OKVideoStart","failOG");});}function k(F){return h.ajax({url:decodeURIComponent(F),dataType:"json",type:"GET",headers:{TKN:OK.tkn.get()}});}function s(G,F){return h.ajax({url:"/dk?cmd=videoCommand&a=getVideoPlayerAttributes&st.vv_movieId="+G+"&st.location="+F,dataType:"json",type:"GET",headers:{TKN:OK.tkn.get()}});}function e(H){var I=H.flashvars.metadata.liveStreamInfo;if(!I){return true;}var J=parseInt(I.startTime,10),F=parseInt(I.endTime,10),G=Date.now()+H.timeshift;return !!((!F||G<=F)&&(!J||G>J));}function l(G,F){require(["okHtml5Player"],function(H){H.embedPlayer(F,F,G.flashvars);});}function i(I,H){if(c.getObjectById(H)){return;}var J=c.hasFlashPlayerVersion(I.minFlashVersionNewPlayer||"11.2.0")&&I.url11?I.url11:I.url;var G={id:H,name:H};var K={allowScriptAccess:I.asa?"always":"never",wmode:I.wmode||"opaque",allowFullScreen:true,menu:false,bgcolor:"#000000"};var F=B(h.extend({},I.flashvars,{autoplay:true,wmode:K.wmode,stageVideo:K.wmode=="direct"||K.wmode=="gpu",playerId:I.playerId}));c.embedSWF(J,H,"100%","100%","10.0.0",null,F,K,G);a(I);}function u(G,F){var H=document.createElement("iframe");H.id=F;H.width="100%";H.height="100%";H.tabIndex="999";H.frameBorder="no";H.scrolling="no";H.allowFullscreen=true;H.src=G.url;var I=document.getElementById(F);I.parentNode.replaceChild(H,I);a(G);}function p(S,K,I){var Q=S.flashvars.metadata.liveStreamInfo,J=Date.now()+S.timeshift,H=parseInt(Q.startTime,10),M=parseInt(Q.endTime,10),R=h("#"+K);function N(Y,X){var W=~~((Y-X)/1000),V=~~(W/3600),T=~~(W/60)%60,U=W%60;return(V<10?"0"+V:V)+":"+(T<10?"0"+T:T)+":"+(U<10?"0"+U:U);}var G=h("<div/>",{id:I,"class":"vp_broadcast-stub_w"}),L=h("<div/>",{"class":"vp_video_stub_w"}).appendTo(G),O=h("<div/>",{"class":"vp_broadcast-stub"}).appendTo(L);h("<img/>",{width:"100%",src:S.poster,"class":"vp-video_stub_i"}).appendTo(G);h("<div/>",{"class":"vp_broadcast-stub_tx",html:M&&M<J?S.liveEndedText:S.liveUnstartedText}).appendTo(O);h("#"+I).replaceWith(G);if(H>J){var F=h("<div/>",{"class":"vp_broadcast-stub_time js-live-time",text:N(H,J)}).appendTo(O);var P=setInterval(function(){J=Date.now()+S.timeshift;if(H<J){clearInterval(P);v(S,K,I);return;}F.text(N(H,J));},1000);R.data("startTimer",P.toString());}}function v(U,J,H){if(typeof U.flashvars.metadata==="string"){U.flashvars.metadata=JSON.parse(U.flashvars.metadata);}if(typeof U.flashvars.translations==="string"){U.flashvars.translations=JSON.parse(U.flashvars.translations);}var O=y.dash,Q=y.mp4,M=c.getFlashPlayerVersion().major>=10,G=!!(U.flashvars.metadata&&U.flashvars.metadata.metadataEmbedded),R=U.flashvars.metadata.liveStreamInfo,T=h("#"+J),P=h("#"+H);function L(){try{u(U,H);}catch(V){n(J,null,null,true);}}function S(){if(Q){l(U,H);}else{n(J,U.noFlashText,U.noFlashImage,true);}}function I(){if(!M){n(J,U.noFlashText,U.noFlashImage,true);}else{y.checkFlashStatus(function(V){if(V===y.FLASH_BLOCKED){n(J,U.noFlashText,U.noFlashImage,true);}else{i(U,H);}});}}function K(){if(O){l(U,H);}else{if(!M){S();}else{y.checkFlashStatus(function(V){if(V===y.FLASH_BLOCKED){S();}else{i(U,H);}});}}}function N(){if(U.isIframePlayer){L();}else{if(U.isExternalPlayer||!U.isHtml5Player){I();}else{if(G){K();}else{if(Q){l(U,H);}else{I();}}}}}function F(){var W=parseInt(R.endTime,10),Y=Date.now()+U.timeshift;if(W&&Y<W){var X=~~((parseInt(R.endTime,10)-Y)/1000);var V=setTimeout(function(){v(U,J,H);},X*1000+3000);T.data("endTimer",V.toString());}}w();if(U.isExternalPlayer&&window.__getMusicFlash){window.__getMusicFlash().lcPause();}r=H;z=J;q=U;if(!P.length){T.hide();h("<div>",{id:H}).insertAfter(T);}if(e(U)){R&&F();N();}else{p(U,J,H);}}function m(F){return F+"C";}function x(F){return F+"E";}function g(F,H,G){H=H||m(F.playerId);G=G||x(F.playerId);if(!F.timeshift){F.timeshift=F.timestamp?parseInt(F.timestamp,10)-Date.now():0;}if(!F.flashvars.metadata&&F.flashvars.metadataUrl){k(F.flashvars.metadataUrl).done(function(I){F.flashvars.metadata=I;delete F.flashvars.metadataUrl;v(F,H,G);}).error(function(){n(H,null,null,true);});}else{v(F,H,G);}}function w(){if(r&&z){h("#"+r).remove();h("#"+z).show();r=null;z=null;q={};}}function t(){return r?document.getElementById(r):null;}function A(){return r;}function f(){var F=t();return F&&F.isPlaying&&F.isPlaying();}function j(){return z;}function o(){return q;}function C(G){var F=t();if(F&&F.call){F.call(G);}}function D(H,I,J,F,G){s(H,G).always(function(K){K=K||{flashvars:{}};K.playerId=I||K.playerId||null;K.width=J||K.width||null;K.height=F||K.height||null;if(window.odklMusic&&window.odklMusic.playingTrack()){K.flashvars.silent="1";}if(K.error||!K.url){var L=n(m(K.playerId),K.error).css("display","block");K.width&&L.width(K.width);K.height&&L.height(K.height);}else{g(K);}});}function d(L){var R=h(L),H=R.data("playerContainerId"),G=R.data("playerElementId"),T=R.data("options"),S=R.data("autostart"),Q=R.data("viewportTimeout"),N=R.data("viewportDisabledIfMusic"),F=R.data("hoverTimeout"),J=R.data("hoverDisabledIfMusic"),K=R.data("isBannerVideo");T.timeshift=T.timestamp?parseInt(T.timestamp,10)-Date.now():0;if(K){var M,O=R.closest(".js-banner-wrapper-pointer");if(O.length){M=h("#"+O.data("bannerWrapperId"));}else{M=R.closest(".js-banner-wrapper");}if(M.length){var P=M.children(".adv-px");if(P.length){var I={};P.each(function(){var V=h(this),U=V.data("type"),W=V.data("src");if(typeof I[U]==="undefined"){I[U]=[];}I[U].push(W);});T.flashvars.pixels=I;}}}if(!R.find("#"+H).length){h("<div>",{id:H,"class":"vid-card_cnt_w"}).css({width:"100%",height:"100%"}).append(h("<i>",{"class":"vid_play"})).appendTo(R);}R.find("#"+H).on("click",function(U){U.preventDefault();g(h.extend(true,{},T),H,G);});if(S){g(h.extend(true,{},T),H,G);}if(Q&&!T.isExternalPlayer){require(["OK/VideoAutoplayFlow"],function(U){U.activateViewportPlayer(h.extend(true,{},T),H,G,Q,N);});}if(F){require(["OK/VideoAutoplayFlow"],function(U){U.activateHoverPlayer(h.extend(true,{},T),H,G,F,J);});}}function b(H){var G=h(H),L=G.data("playerContainerId"),K=G.data("viewportTimeout"),I=G.data("hoverTimeout"),M=h("#"+L),J=parseInt(M.data("startTimer"),10),F=parseInt(M.data("endTimer"),10);if(K||I){require(["OK/VideoAutoplayFlow"],function(N){N.deactivateHoverPlayer(L);N.deactivateViewportPlayer(L);});}if(J||F){clearInterval(J);clearTimeout(F);}}return{activate:d,deactivate:b,createMusicPreview:D,start:g,stop:w,getPlayer:t,getPlayerId:A,getContainerId:j,getOptions:o,isPlaying:f,callPlayer:C,createPlayerContainerId:m,createPlayerElementId:x};});