KISSY.add("tbc/search-suggest/1.4.8/plugin/history-magic",function(t,e,a,i,r){function o(t){o.superclass.constructor.call(this,t||{})}return KISSY.extend(o,e,{pluginInitializer:function(t){var e=this,i=t.getPlugin("cloud"),r=500;this.sug=t,e.set("cloudPlugin",i),e.set("caller",t);var o;t.on("afterQueryChange",function(n){o&&clearTimeout(o),e.isGetData&&(r=0),o=setTimeout(function(){var r=t.get("menu").get("el");e.getPostData(r,function(t){if(t){var e=a.get(".search-menuitem");i.show(e)}})},r)})},getPostData:function(t,e){var i=this,r=".search-menu-history-key",o=a.query(r,t),n=a.query(".search-menu-extras-history",t),u=[],s=[],c=[],l=i.historyData||{},g=!0;if(!o)return!0;for(var d=0,h=n.length-1;h>=d;d++){var f=a.text(o[d]);u.push(a.attr(n[d],"data-index")),l[f]?l[f].index=d+1:(s.push(f),l[f]={}),c.push(f)}i.historyData=l,0===s.length&&(g=!1);var v={text:c,index:u,el:n,result:{content:a.outerHTML(t)}};if(g)var x=i.getMagicData(v,function(t){e.call(this,t)});else{var y=i.getLocalData(c);i.render(v,y,function(t){e.call(this,t)})}return x},getLocalData:function(t){for(var e,a={},i=this.historyData,r=0;r<t.length;r++)e=t[r],a[e]=i[e];return a},getMagicData:function(t,e){var a=this,o=t.text,n=a.get("dataUrl"),u=n.replace("{query}",o.join("%01"));-1===u.indexOf("bucketid")&&(u+="&bucketid="+(new r).getBucket()),i.jsonp(u,function(i){a.isGetData=!0,a.render(t,i.magic,e,!0)})},render:function(t,e,i,r){var o,n,u,s,c=this,l=c.get("cloudPlugin"),g=t.text,d=t.index,h=t.el,f=!1;if(!e)return!0;c.checkCloudBox();for(var v in e){var x=e[v],y=x.index-0;x.data&&(n="_his_"+y,s=KISSY.indexOf(n,d),u=g[s]||v,c.historyData[u]=e[v],s>-1&&a.addClass(h[s],"search-wrap-cloud"),o=l._renderHTML({result:t.result,data:e[v],query:u,index:n,key:u,auto:!1,type:e[v].type||"tag",tagTitle:u,prefix:n,action:c.sug.userConfig&&c.sug.userConfig.action}),a.get("#J_CloudList"+n)&&a.remove("#J_CloudList"+n),a.append(a.create(o),".cloud-box"),1===y&&(f=!0))}i.call(this,f)},checkCloudBox:function(){var t=this.get("caller"),e=t.get("menu").get("el");if(e&&!a.get(".cloud-box")){var i='<div class="search-combobox-menu-footer cloud-footer"><div class="cloud-box" style="height: auto"></div></div>';e.append(i)}},update:function(){}},{ATTRS:{pluginId:{value:"historyMagic"},dataUrl:{value:location.protocol+"//suggest.taobao.com/sug?area=history_magic&q={query}"},cloudPlugin:{value:null}}}),o},{requires:["base","dom","ajax","../mods/bts"]});