register_controller("AppOffersCtrl",function(T){var q=$(T),m=$(".app-link",q),G=$(".app-offers-button",q),I=$(".app-offers-container",q),P=$(".appOnlyDialog-popup-content",q),ac=$(".fk-question-mark",q),E,ah,aa,B,w,ab,r,M,ag,ak,R,a,y,h,D,J,i,Z,v,L,u,K,j,O,C=false,ai,V,x,Q,H,aj,N,A,k,c=false;function o(){G.click(function(){if(!c){f("Opened");$(this).addClass("open");ac.text("X");setTimeout(function(){I.slideDown(200);c=true},150)}else{f("Closed");I.slideUp(200,function(){G.removeClass("open");ac.text("?");c=false})}});m.click(function(al){f("Clicked");W($(this));p();al.preventDefault()})}function p(){ak=null;ad();if(!FKART.login.isUserLoggedIn()){r.hide();e()}else{A=setTimeout(function(){$.ajax({url:"/lc/sendPushNotificationForAccount",data:{pid:V,sid:x,offerid:ai,title:Q,subtitle:H},type:"POST",dataType:"json",success:function(al){if(al.deviceFound&&al.notificationSent){F()}else{U()}},error:function(){U()}})},7000)}}function f(am){var al={};if(am=="Clicked"){al.products=s.products}al.prop21="OpenInApp_"+am;FKART.omni.customEvent("App only offers",al)}function F(){g();r.hide();if(aj&&aj.length>0){var al=$("<img>");al.attr("src",aj);aa.append(al)}else{aa.remove()}ah.show();z();f("PNSent")}function U(){g();r.hide();B.show();e();f("PNFailed")}function ad(){ak=new FKART.ui.Dialog({showFooter:false,cssClass:"appOnlyDialog",body:P.html(),destroyOnHide:true,width:"500px"});a=ak.getContainer();r=a.find(".loadingDiv");E=a.find(".smsDiv");ah=a.find(".successDiv");aa=ah.find(".phone-image span");D=a.find(".smsForm");R=a.find(".successPrefixDiv");B=a.find(".errorDiv");M=a.find(".send-sms-fake-link");ag=a.find(".send-sms-link");k=a.find(".timer");y=a.find(".retry-notification");ak.show();d()}function d(){a.on("beforeHide",function(al){af();g();C=false});ag.click(function(){ah.hide();R.show();e();f("PNExpired")});y.click(function(){ak.hide();p();f("PNReTried")})}function Y(){j=K.val();if(!(/^[789]\d{9}$/.test(j))){K.addClass("error").val("").attr("placeholder","Invalid Number").focus();return}else{$.ajax({url:"/lc/sendSMSForNumber",type:"POST",data:{pid:V,sid:x,offerid:ai,title:Q,subtitle:H,phoneNumber:j,captchaText:v.val(),captchaId:L.attr("id")},dataType:"json",success:function(al){if(al.captchaStatus){if(al.smsStatus){X()}else{t()}}else{n()}},error:function(){t()}})}}function n(){l();v.addClass("error").val("").attr("placeholder","Invalid Captcha").focus()}function X(){i.hide();D.hide();u.html(j);w.show();f("SMSSent")}function t(){i.hide();D.hide();u.html(j);ab.show();f("SMSFailed")}function e(){K=D.find(".phoneNumber");j=FKART.login.userPhoneNumber;K.val(j);J=D.find("input[type=submit]");i=E.find(".infoDiv");w=E.find(".smsSuccessDiv");ab=E.find(".smsErrorDiv");h=E.find(".retry-sms");Z=D.find(".captchaDiv");v=D.find(".captchaText");O=D.find(".refreshCaptcha");u=E.find(".phone_number");if(/^\d{10}$/.test(j)){C=true;l()}E.show();ak.reposition();S()}function S(){O.click(function(){l();v.val("").focus()});D.submit(function(al){Y();f("SMSTried");al.preventDefault()});h.click(function(){i.show();D.show();ab.hide();v.removeClass("error").val("").attr("placeholder","Captcha text").focus();l();f("SMSReTried")});K.focus(function(){f("PhoneNumberFocused");if(!C){C=true;l()}})}function l(){$.ajax({url:"/lc/generateCaptcha",type:"POST",dataType:"json",success:function(al){if(al.success){L=Z.find("img");L.attr("src","data:image/png;base64,"+al.captchaBytes);L.attr("id",al.id);Z.show();v.show();L.load(function(){if(this.complete){ak.reposition()}})}else{Z.find("img").attr("alt","Captcha failed to load")}},error:function(){Z.find("img").attr("alt","Captcha failed to load")}})}function af(){clearInterval(N);N=null}function g(){clearInterval(A);A=null}function z(){N=setInterval(function(){var al=parseInt(k.html());if(al==0){af();M.hide();ag.show()}k.html(al-1)},1000)}function b(am,al){var ap=am.split("?")[1];var ao=ap.split("&");for(var an=0;an<ao.length;an++){var aq=ao[an].split("=");if(aq[0]==al){return aq[1]}}}function W(al){aj=al.data("image");if(al.data("pid")){V=al.data("pid").toString();ai=al.data("offerid")}else{x=b(al.data("url"),"sid");V=b(al.data("url"),"pid");ai=b(al.data("url"),"offer");Q=al.data("title");H=al.data("subtitle")}}function ae(){o()}ae()});