define(["jquery","swfobject","OK/logger","okVideoPlayerUtils"],function(f,c,u,q){function k(B,y,v,w){var A=f("#"+B),x=f("<div/>",{"class":"vp_video_stub_w"}),z=f("<div/>",{"class":"vp_video_stub __na"}).appendTo(x);f("<div/>",{"class":"vp_video_stub_txt",html:(y||"")}).appendTo(z);if(w){A.replaceWith(x);A=x;}else{A.append(x);}if(v){f("<img/>",{width:"100%",src:v,"class":"vp-video_stub_i"}).insertBefore(x);}return A;}function r(v){for(var w in v){if(v.hasOwnProperty(w)){if(typeof v[w]!=="string"){v[w]=encodeURIComponent(JSON.stringify(v[w]));}}}return v;}function n(v){return v+"C";}function t(v){return v+"E";}function a(v){v.isExternalPlayer&&f.ajax({url:"/dk?cmd=videoStatNew",contentType:"application/json",type:"POST",data:JSON.stringify({duration:0,contentId:v.url,location:v.flashvars.location,providerId:v.provider,batch:[{name:"started"}]})}).error(function(){u.error("OKVideoStart","failOG");});}function i(v){return f.ajax({url:decodeURIComponent(v),dataType:"json",type:"GET",headers:{TKN:OK.tkn.get()}});}function o(w,v){return f.ajax({url:"/dk?cmd=videoCommand&a=getVideoPlayerAttributes&st.vv_movieId="+w+"&st.location="+v,dataType:"json",type:"GET",headers:{TKN:OK.tkn.get()}});}function e(x){var y=x.flashvars.metadata.liveStreamInfo;if(!y){return true;}var z=parseInt(y.startTime,10),v=parseInt(y.endTime,10),w=Date.now()+x.timeshift;return !!((!v||w<=v)&&(!z||w>z));}function j(w,v){require(["okHtml5Player"],function(y){var x=OK.VideoPlayer.playersCache.indexOf(v);if(x>=0){OK.VideoPlayer.playersCache.splice(x,1);}y.embedPlayer(v,v,w.flashvars);});}function g(y,x){if(c.getObjectById(x)){return;}var z=c.hasFlashPlayerVersion(y.minFlashVersionNewPlayer||"11.2.0")&&y.url11?y.url11:y.url;var w={id:x,name:x};var A={allowScriptAccess:y.asa?"always":"never",wmode:y.wmode||"opaque",allowFullScreen:true,menu:false,bgcolor:"#000000"};var v=r(f.extend({},y.flashvars,{autoplay:true,wmode:A.wmode,stageVideo:A.wmode=="direct"||A.wmode=="gpu",playerId:y.playerId}));c.embedSWF(z,x,"100%","100%","10.0.0",null,v,A,w);OK.VideoPlayer.playersCache.push(x);}function m(I,A,y){var G=I.flashvars.metadata.liveStreamInfo,z=Date.now()+I.timeshift,x=parseInt(G.startTime,10),C=parseInt(G.startTime,10),H=f("#"+A);function D(O,N){var M=~~((O-N)/1000),L=~~(M/3600),J=~~(M/60)%60,K=M%60;return(L<10?"0"+L:L)+":"+(J<10?"0"+J:J)+":"+(K<10?"0"+K:K);}var w=f("<div/>",{id:y,"class":"vp_broadcast-stub_w"}),B=f("<div/>",{"class":"vp_video_stub_w"}).appendTo(w),E=f("<div/>",{"class":"vp_broadcast-stub"}).appendTo(B);f("<img/>",{width:"100%",src:I.poster,"class":"vp-video_stub_i"}).appendTo(w);f("<div/>",{"class":"vp_broadcast-stub_tx",html:C&&C<z?I.liveEndedText:I.liveUnstartedText}).appendTo(E);f("#"+y).replaceWith(w);if(x>z){var v=f("<div/>",{"class":"vp_broadcast-stub_time js-live-time",text:D(x,z)}).appendTo(E);var F=setInterval(function(){z=Date.now()+I.timeshift;if(x<z){clearInterval(F);p(I,A,y);return;}v.text(D(x,z));},1000);H.data("startTimer",F.toString());}}function p(J,z,x){if(typeof J.flashvars.metadata==="string"){J.flashvars.metadata=JSON.parse(J.flashvars.metadata);}if(typeof J.flashvars.translations==="string"){J.flashvars.translations=JSON.parse(J.flashvars.translations);}var D=q.dash,F=q.mp4,B=c.getFlashPlayerVersion().major>=10,w=!!(J.flashvars.metadata&&J.flashvars.metadata.metadataEmbedded),G=J.flashvars.metadata.liveStreamInfo,I=f("#"+z),E=f("#"+x);function H(){if(F){j(J,x);}else{k(z,J.noFlashText,J.noFlashImage,true);}}function y(){if(!B){k(z,J.noFlashText,J.noFlashImage,true);}else{q.checkFlashStatus(function(K){if(K===q.FLASH_BLOCKED){k(z,J.noFlashText,J.noFlashImage,true);}else{g(J,x);}});}}function A(){if(D){j(J,x);}else{if(!B){H();}else{q.checkFlashStatus(function(K){if(K===q.FLASH_BLOCKED){H();}else{g(J,x);}});}}}function C(){if(J.isExternalPlayer||!J.isHtml5Player){y();}else{if(w){A();}else{if(F){j(J,x);}else{y();}}}}function v(){var L=parseInt(G.endTime,10),N=Date.now()+J.timeshift;if(L&&N<L){var M=~~((parseInt(G.endTime,10)-N)/1000);var K=setTimeout(function(){p(J,z,x);},M*1000+3000);I.data("endTimer",K.toString());}}if(!E.length){I.hide();f("<div>",{id:x}).insertAfter(I);}if(e(J)){G&&v();C();}else{m(J,z,x);}a(J);}function h(v,x,w){x=x||n(v.playerId);w=w||t(v.playerId);if(!v.flashvars.metadata&&v.flashvars.metadataUrl){i(v.flashvars.metadataUrl).done(function(y){v.flashvars.metadata=y;delete v.flashvars.metadataUrl;p(v,x,w);}).error(function(){k(x,null,null,true);});}else{p(v,x,w);}}function l(x,y,z,v,w){o(x,w).always(function(A){A=A||{flashvars:{}};A.playerId=y||A.playerId||null;A.width=z||A.width||null;A.height=v||A.height||null;if(A.error||!A.url){var B=k(n(A.playerId),A.error).css("display","block");A.width&&B.width(A.width);A.height&&B.height(A.height);}else{h(A);}});}function s(v){h(JSON.parse(v.getAttribute("data-attributes")),v.id,v.id+"Object");}function d(z){var D=f(z),x=D.data("playerContainerId"),w=D.data("playerElementId"),F=D.data("options"),E=D.data("autostart"),C=D.data("viewportTimeout"),A=D.data("viewportDisabledIfMusic"),v=D.data("hoverTimeout"),y=D.data("hoverDisabledIfMusic"),B=D.data("timestamp");if(!D.find("#"+x).length){f("<div>",{id:x,"class":"vid-card_cnt_w"}).css({width:"100%",height:"100%"}).append(f("<i>",{"class":"vid_play"})).appendTo(D);}F.timeshift=B?parseInt(B,10)-Date.now():0;D.find("#"+x).on("click",function(G){G.preventDefault();h(f.extend(true,{},F),x,w);});if(E){h(f.extend(true,{},F),x,w);}if(C){require(["OK/VideoAutoplayFlow"],function(G){G.activateViewportPlayer(f.extend(true,{},F),x,w,C,A);});}if(v){require(["OK/VideoAutoplayFlow"],function(G){G.activateHoverPlayer(f.extend(true,{},F),x,w,v,y);});}}function b(x){var w=f(x),B=w.data("playerContainerId"),A=w.data("viewportTimeout"),y=w.data("hoverTimeout"),C=f("#"+B),z=parseInt(C.data("startTimer"),10),v=parseInt(C.data("endTimer"),10);if(A||y){require(["OK/VideoAutoplayFlow"],function(D){D.deactivateHoverPlayer(B);D.deactivateViewportPlayer(B);});}if(z||v){clearInterval(z);clearTimeout(v);}}return{activate:d,deactivate:b,createPlayer:l,start:h,activatePlayer:s};});