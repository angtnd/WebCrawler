/*
 shopping_counter-3.4.3.js
 Copyright (c) 2015 Rakuten.Inc
 Date : 2015-10-28 10:35:48

 jquery.jsonp 2.4.0 (c)2012 Julian Aubourg | MIT License
 https://github.com/jaubourg/jquery-jsonp
*/
(function(d){function q(){}function o(b){y=[b]}function b(b,a,c){return b&&b.apply&&b.apply(a.context||a,c)}function a(a){function E(c){t++||(u(),v&&(A[k]={s:[c]}),F&&(c=F.apply(a,[c])),b(B,a,[c,G,a]),b(H,a,[a,G]))}function z(c){t++||(u(),v&&c!=I&&(A[k]=c),b(C,a,[a,c]),b(H,a,[a,c]))}var a=d.extend({},J,a),B=a.success,C=a.error,H=a.complete,F=a.dataFilter,K=a.callbackParameter,L=a.callback,V=a.cache,v=a.pageCache,M=a.charset,k=a.url,p=a.data,N=a.timeout,w,t=0,u=q,O,i,r,D;return P&&P(function(a){a.done(B).fail(C);
B=a.resolve;C=a.reject}).promise(a),a.abort=function(){!t++&&u()},!1===b(a.beforeSend,a,[a])||t?a:(k=k||e,p=p?"string"==typeof p?p:d.param(p,a.traditional):e,k+=p?(/\?/.test(k)?"&":"?")+p:e,K&&(k+=(/\?/.test(k)?"&":"?")+encodeURIComponent(K)+"=?"),!V&&!v&&(k+=(/\?/.test(k)?"&":"?")+"_"+(new Date).getTime()+"="),k=k.replace(/=\?(&|$)/,"="+L+"$1"),v&&(w=A[k])?w.s?E(w.s[0]):z(w):(Q[L]=o,i=d(R)[0],i.id=f+W++,M&&(i[m]=M),S&&11.6>S.version()?(r=d(R)[0]).text="document.getElementById('"+i.id+"')."+h+"()":
i[c]=c,X&&(i.htmlFor=i.id,i.event=j),i[n]=i[h]=i[T]=function(a){if(!i[l]||!/i/.test(i[l])){try{i[j]&&i[j]()}catch(b){}a=y;y=0;a?E(a[0]):z(g)}},i.src=k,u=function(){D&&clearTimeout(D);i[T]=i[n]=i[h]=null;s[U](i);r&&s[U](r)},s[x](i,O=s.firstChild),r&&s[x](r,O),D=0<N&&setTimeout(function(){z(I)},N)),a)}var c="async",m="charset",e="",g="error",x="insertBefore",f="_jqjsp",j="onclick",h="on"+g,n="onload",T="onreadystatechange",l="readyState",U="removeChild",R="<script>",G="success",I="timeout",Q=window,
P=d.Deferred,s=d("head")[0]||document.documentElement,A={},W=0,y,J={callback:f,url:location.href},S=Q.opera,X=!!d("<div>").html("<\!--[if IE]><i><![endif]--\>").find("i").length;a.setup=function(a){d.extend(J,a)};d.jsonp=a})(jQuery);
(function(){if(void 0!==window.jQuery){var d=jQuery.noConflict(),q=function(b){this.$root=b;this.$lastDate=this.$ifArea=this.$itemStamp=this.$shopStamp=this.$sugoroku=this.$count=this.$busy=this.$error=this.$noLogin=this.$login=this.$default=this.$userInfo=void 0;this.hasJSON="JSON"in window&&"parse"in JSON&&"stringify"in JSON;this.hasLocalStorage=this.checkLocalStorage();this.api="";this.json={};this.lsString=this.lsKey="";this.lsLastDate=0;this.isTestMode=this.checkTestMode(location.search);this.isReloaded=
!1;this.getElements();this.bindCustomEvent();this.getJSONFromLocalStorage()};q.prototype={defaults:{splitter:{number:"#NUMBER#",date:"#DATE#"},selectors:{target:".target"},events:{COUNTER_UPDATED:"counterupdated",GET_COUTER_DATA:"getcounterdata"},lsKey:"RJSShoppingCounter",updateThreshold:180,reloadThreshold:5},checkLocalStorage:function(){try{return localStorage.setItem("test","test"),localStorage.removeItem("test"),!0}catch(b){return!1}},checkTestMode:function(b){return null!==b.match(/\?shoppingcountertest/)},
getElements:function(){this.api=this.$root.attr("data-api-url");this.updateThreshold=+this.$root.attr("data-updateThreshold")||this.defaults.updateThreshold;this.reloadThreshold=+this.$root.attr("data-reloadThreshold")||this.defaults.reloadThreshold;this.useLocalStorageCache="true"===this.$root.attr("data-useLocalStorageCache");this.$userInfo=this.$root.find("[data-user-info]");this.$default=this.$userInfo.filter("[data-user-info=default]").show();this.$login=this.$userInfo.filter("[data-user-info=login]").hide();
this.$noLogin=this.$userInfo.filter("[data-user-info=nologin]").hide();this.$error=this.$userInfo.filter("[data-user-info=error]").hide();this.$busy=this.$userInfo.filter("[data-user-info=busy]").hide();this.$count=this.$login.find("[data-count]");this.$sugoroku=this.$login.find("[data-sugoroku]");this.$shopStamp=this.$login.find("[data-shop-stamp]");this.$itemStamp=this.$login.find("[data-item-stamp]");this.$ifArea=this.$login.find("[data-if-area]").hide();this.$lastDate=this.$root.find("[data-last-date]").hide()},
bindCustomEvent:function(){var b=this;this.$root.bind(this.defaults.events.GET_COUTER_DATA,function(){b.fireEvent(b.$root,b.defaults.events.COUNTER_UPDATED,b.json)})},getJSONFromLocalStorage:function(){var b=(new Date).getTime();if(this.isTestMode)this.startTestMode(location.search);else if(this.hasLocalStorage){this.lsString=localStorage.getItem(this.defaults.lsKey)||"null";if(this.hasJSON)this.json=JSON.parse(this.lsString)||{};if(d.isEmptyObject(this.json))this.requestAPI(this.api);else if(this.json.loaded>
b-1E3*this.reloadThreshold)this.isReloaded=!0,this.updateCounter(this.json);else if("success"===this.json.status&&this.useLocalStorageCache){var a=+this.json.last_date.substr(0,4),c=+this.json.last_date.substr(5,2)-1,m=+this.json.last_date.substr(8,2),e=+this.json.last_date.substr(11,2),g=+this.json.last_date.substr(14,2),x=+this.json.last_date.substr(17,2),f=6E4*(new Date).getTimezoneOffset(),a=(new Date((new Date(a,c,m,e,g,x)).getTime()-324E5-f)).getTime(),b=b-a;12E4<b&&b<1E3*this.updateThreshold+
12E4?this.updateCounter(this.json):this.requestAPI(this.api)}else this.requestAPI(this.api)}else this.requestAPI(this.api)},startTestMode:function(b){for(var a=[],a=b.split("&"),b={},c=0;c<a.length;c++){if(null!==a[c].match(/status/))b.status=a[c].split("=")[1];if(null!==a[c].match(/count/))b.count=+a[c].split("=")[1];if(null!==a[c].match(/last_date/))b.last_date=a[c].split("=")[1].replace("%20"," ");if(null!==a[c].match(/item_genre/)){var d=[],e=[],d=a[c].replace(/\}/,"").split("{")[1].split("-");
b.item_genre={};for(var g=0;g<d.length;g++)e=d[g].split("="),b.item_genre[e[0]]=e[1]}if(null!==a[c].match(/shop_genre/)){d=[];e=[];d=a[c].replace(/\}/,"").split("{")[1].split("-");b.shop_genre={};for(g=0;g<d.length;g++)e=d[g].split("="),b.shop_genre[e[0]]=e[1]}}this.json=b;this.updateCounter(b)},requestAPI:function(b){var a=this;d.jsonp({type:"GET",callback:"_shoppingcounter_jqjsp",url:b,dataType:"json",scriptCharset:"euc-jp",timeout:1E4,error:function(b,d){a.busyCase(b,d)},success:function(b){a.json=
b;a.updateCounter(b)}})},updateCounter:function(b){switch(b.status){case "success":this.successCase(b);break;case "nologin":this.nologinCase(b);break;case "error":this.errorCase();break;case "busy":this.busyCase()}},successCase:function(b){var a=this;this.$default.hide();this.$login.show();var c=0,m=0;b.last_date&&this.$lastDate.show().each(function(){var c=d(this),f=c.attr("data-last-date"),f=f.replace(a.defaults.splitter.date,b.last_date);c.html(f)});if(b.shop_genre){for(var e in b.shop_genre)0<
+b.shop_genre[e]&&c++;this.$shopStamp.each(function(a,c){var j=d(c),h=j.attr("data-shop-stamp");0<+b.shop_genre[h]&&j.attr("src",j.attr("data-clear"))})}if(b.item_genre){for(var g in b.item_genre)0<+b.item_genre[g]&&m++;this.$itemStamp.each(function(a,c){var j=d(c),h=j.attr("data-item-stamp");0<+b.item_genre[h]&&j.attr("src",j.attr("data-clear"))})}this.$count.each(function(e,f){var j=d(f),h=j.attr("data-base-url").split(a.defaults.splitter.number),n=j.attr("data-count"),g=n.split(/[0-1]./)[0],n=
n.slice(-2),l;switch(g){case "count":l=b.count;break;case "shop":l=c;break;case "item":l=m}"10"===n?10<=l&&j.attr("src",h[0]+l.toString().slice(0,1)+h[1]):"01"===n&&(10<=l?j.attr("src",h[0]+l.toString().slice(1,2)+h[1]):j.attr("src",h[0]+l+h[1]))});this.$sugoroku.each(function(){var e=d(this),f=0,j=+e.attr("data-limit"),h=e.attr("data-base-url").split(a.defaults.splitter.number);switch(e.attr("data-sugoroku")){case "count":f=b.count;break;case "shop":f=c;break;case "item":f=m}j<=f?e.attr("src",h[0]+
j+h[1]):e.attr("src",h[0]+f+h[1])});this.$ifArea.each(function(){var a=d(this),f=a.attr("data-if-area").split(":"),e=f[0],h=f[1].split("-")[0],f=f[1].split("-")[1],g;switch(e){case "count":g=b.count;break;case "shop":g=c;break;case "item":g=m}void 0!==f?h<=g&&g<=f&&a.show():h<=g&&a.show()});this.fireEvent(this.$root,this.defaults.events.COUNTER_UPDATED,b);this.saveJSONToLocalStorage()},nologinCase:function(b){this.$default.hide();this.$noLogin.show();this.fireEvent(this.$root,this.defaults.events.COUNTER_UPDATED,
b);this.saveJSONToLocalStorage()},errorCase:function(b){this.$default.hide();this.$error.show();this.fireEvent(this.$root,this.defaults.events.COUNTER_UPDATED,b);this.saveJSONToLocalStorage()},busyCase:function(){this.$default.hide();this.$busy.show();this.fireEvent(this.$root,this.defaults.events.COUNTER_UPDATED);this.saveJSONToLocalStorage()},saveJSONToLocalStorage:function(){if(this.hasLocalStorage&&this.hasJSON){if(!this.isReloaded)this.json.loaded=(new Date).getTime();this.lsString=JSON.stringify(this.json);
localStorage.setItem(this.defaults.lsKey,this.lsString)}},fireEvent:function(b,a,c){a=d.Event(a);a.customData=c||{};b.trigger(a)}};if("undefined"!==typeof __unittest__&&!0===__unittest__)window.ShoppingCounter=q;else{var o=d("#RJSShoppingCounter");0<o.length?new q(o):d(document).ready(function(){o=d("#RJSShoppingCounter");0<o.length&&new q(o)})}}})();
