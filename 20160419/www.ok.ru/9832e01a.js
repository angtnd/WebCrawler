define(["jquery","OK/logger","okVideoPlayerUtils","PTS/video.player"],function(A,y,p,a){var w={UNKNOWN:"UNKNOWN",OK:"OK",ERROR:"ERROR",UPLOADING:"UPLOADING",CREATING:"CREATING",PROCESSING:"PROCESSING",ONLINE:"ONLINE",OFFLINE:"OFFLINE",LIVE_NOT_STARTED:"LIVE_NOT_STARTED",LIVE_ENDED:"LIVE_ENDED",ON_MODERATION:"ON_MODERATION",BLOCKED:"BLOCKED",CENSORED:"CENSORED",COPYRIGHTS_RESTRICTED:"COPYRIGHTS_RESTRICTED",UNAVAILABLE:"UNAVAILABLE",LIMITED_ACCESS:"LIMITED_ACCESS"};var M=null;var I=null;var b={};var d=null;var H=null;var n=null;A(window).on("onMusicPlaying",function(){if(b.isExternalPlayer){q();}else{K("pause");}});function v(T,Q,N,O){var S=A("#"+T),P=A("<div/>",{"class":"vp_video_stub_w"}),R=A("<div/>",{"class":"vp_video_stub __na"}).appendTo(P);A("<div/>",{"class":"vp_video_stub_txt",html:(Q||"")}).appendTo(R);if(O){S.replaceWith(P);S=P;}else{S.append(P);}if(N){A("<img/>",{width:"100%",src:N,"class":"vp-video_stub_i"}).insertBefore(P);}return S;}function L(){if(d){clearTimeout(d);d=null;}if(H){clearInterval(H);H=null;}if(n){clearTimeout(n);n=null;}}function x(N){for(var O in N){if(N.hasOwnProperty(O)){if(typeof N[O]!=="string"){N[O]=encodeURIComponent(JSON.stringify(N[O]));}}}return N;}function z(N){N.isExternalPlayer&&A.ajax({url:"/dk?cmd=videoStatNew",contentType:"application/json",type:"POST",data:JSON.stringify({duration:0,contentId:N.url,location:N.flashvars.location,providerId:N.provider,batch:[{name:"started"}]})}).error(function(){y.error("OKVideoStart","failOG");});}function h(N){return !N.flashvars.metadata.paymentInfo||N.flashvars.metadata.paymentInfo.status==="PAID";}function f(P,O,Q,N){return A.ajax({url:P?decodeURIComponent(P):"/dk?cmd=videoPlayerMetadata",data:O,dataType:"json",type:"POST",headers:{TKN:OK.tkn.get()}}).done(Q).error(N);}function E(P,N,O,R){var S=P.flashvars.metadataUrl,Q={};if(P.flashvars.metadata){if(typeof P.flashvars.metadata==="string"){P.flashvars.metadata=JSON.parse(P.flashvars.metadata);}if(!R){N();return;}if(h(P)){Q.is="on";}}else{P.flashvars.metadata={};}if(!S){if(P.flashvars.metadata){Q.mid=P.flashvars.metadata.movie.movieId;}else{O();return;}}f(S,Q,function(T){if(T&&!T.error){A.extend(true,P.flashvars.metadata,T);delete P.flashvars.metadataUrl;N();}else{O();}},function(){O();});}function m(O,N){return A.ajax({url:"/dk",data:{cmd:"videoCommand",a:"getVideoPlayerAttributes","st.vv_movieId":O,"st.location":N},dataType:"json",type:"POST",headers:{TKN:OK.tkn.get()}});}function C(O,N){require(["okHtml5Player"],function(P){P.embedPlayer(N,N,O.flashvars);});}function g(O,N){require(["swfobject"],function(R){if(R.getObjectById(N)){return;}var S=R.hasFlashPlayerVersion(O.minFlashVersionNewPlayer||"11.2.0")&&O.url11?O.url11:O.url;var Q={id:N,name:N};var T={allowScriptAccess:O.asa?"always":"never",wmode:O.wmode||"opaque",allowFullScreen:true,menu:false,bgcolor:"#000000"};var P={autoplay:true,wmode:T.wmode,stageVideo:T.wmode=="direct"||T.wmode=="gpu",playerId:O.playerId};if(!O.isExternalPlayer){P=x(A.extend({},O.flashvars,P));}R.embedSWF(S,N,"100%","100%","10.0.0",null,P,T,Q);});z(O);}function F(O,N){var P=document.createElement("iframe");P.id=N;P.width="100%";P.height="100%";P.tabIndex="999";P.frameBorder="no";P.scrolling="no";P.allowFullScreen=true;P.setAttribute("allowfullscreen","");P.src=O.url;var Q=document.getElementById(N);Q.parentNode.replaceChild(P,Q);z(O);}function e(Z,S,Q){var Y=Z.flashvars.metadata.liveStreamInfo,V=Z.flashvars.metadata.movie.status,R=Date.now()+Z.timeshift,P=parseInt(Y.startTime,10);function W(af,ae){var ad=~~((af-ae)/1000),ac=~~(ad/3600),aa=~~(ad/60)%60,ab=ad%60;return(ac<10?"0"+ac:ac)+":"+(aa<10?"0"+aa:aa)+":"+(ab<10?"0"+ab:ab);}var O=A("<div/>",{id:Q,"class":"vp_broadcast-stub_w"}),U=A("<div/>",{"class":"vp_video_stub_w"}).appendTo(O),X=A("<div/>",{"class":"vp_broadcast-stub"}).appendTo(U),T=A("<div/>",{"class":"vp_broadcast-stub_tx"}).appendTo(X);A("<img/>",{width:"100%",src:Z.poster,"class":"vp-video_stub_i"}).appendTo(O);A("#"+Q).replaceWith(O);if(V===w.OFFLINE){T.html(Z.liveOfflineText);o(Z.liveRertyTimeout);}else{if(P>R){T.html(Z.liveUnstartedText);var N=A("<div/>",{"class":"vp_broadcast-stub_time js-live-time",text:W(P,R)}).appendTo(X);H=setInterval(function(){R=Date.now()+Z.timeshift;if(P<R){clearInterval(H);o();return;}N.text(W(P,R));},1000);}else{T.html(Z.liveEndedText);}}}function B(N,Q,P){var O=N.flashvars.metadata.paymentInfo;if(window.__FAPI__ShowPaymentForApp){__FAPI__ShowPaymentForApp(Date.now(),O.title,"",O.productCode,O.price,"","","OK","true","",O.appId,"");OK.loader.use(["OKCustomJs"],function(){OK.Layers.subscribe("modal_hook",function R(S){if(!S){OK.Layers.unsubscribe("modal_hook",R);E(N,function(){if(h(N)){i(N,Q,P);}},null,true);}});});}else{OK.VideoPlayer.openLogin();}}function i(P,S,ae){P.flashvars.translations=a;var V=P.flashvars.metadata;if(!V||V.error){v(S,V&&a[V.error]||a.not_found,P.poster,true);return;}var W=p.dash,N=p.mp4,O=p.flash.major>=10,T=!!(P.flashvars.metadata&&P.flashvars.metadata.metadataEmbedded),U=!!(P.flashvars.metadata&&P.flashvars.metadata.hlsMasterPlaylistUrl),Q=!!(P.flashvars.metadata&&P.flashvars.metadata.liveDashManifestUrl),ag=P.flashvars.metadata.liveStreamInfo,aa=P.flashvars.metadata.movie.status,ah=P.flashvars.metadata.movie.statusText,ab=A("#"+S),Y=A("#"+ae);function R(){try{F(P,ae);}catch(aj){v(S,a.not_found,P.poster,true);}}function ad(){if(N){C(P,ae);}else{v(S,P.noFlashText,P.poster,true);}}function X(){if(W&&Q){C(P,ae);}else{Z();}}function Z(){if(!O){v(S,P.noFlashText,P.poster,true);}else{g(P,ae);}}function ac(){if(W){C(P,ae);}else{if(!O){ad();}else{g(P,ae);}}}function af(){if(P.isIframePlayer){R();}else{if(P.isExternalPlayer||!P.isHtml5Player){Z();}else{if(Q||U){X();}else{if(T){ac();}else{if(N){C(P,ae);}else{Z();}}}}}}function ai(){var aj=parseInt(ag.endTime,10),al=Date.now()+P.timeshift;if(aj&&al<aj){var ak=~~((parseInt(ag.endTime,10)-al)/1000);n=setTimeout(function(){i(P,S,ae);},ak*1000+3000);}}if(M!==ae){q();}if(P.isExternalPlayer&&window.__getMusicFlash){window.__getMusicFlash().lcPause();}M=ae;I=S;b=P;if(!Y.length&&h(P)){ab.addClass("invisible");A("<div>",{id:ae}).insertAfter(ab);}if(ag&&aa===w.ONLINE&&!U&&!Q){aa=w.OFFLINE;}switch(aa){case w.OK:case w.ONLINE:ag&&ai();af();break;case w.OFFLINE:case w.LIVE_NOT_STARTED:case w.LIVE_ENDED:if(ag){e(P,S,ae);}else{v(S,ah||a.not_found,P.poster,true);}break;default:v(S,ah||a.not_found,P.poster,true);}}function G(N){return N+"C";}function l(N){return N+"E";}function u(N,P,O){P=P||G(N.playerId);O=O||l(N.playerId);if(!N.timeshift){N.timeshift=N.timestamp?parseInt(N.timestamp,10)-Date.now():0;}E(N,function(){i(N,P,O);},function(){v(P,a.not_found,N.poster,true);});}function q(){if(M&&I){L();A("#"+M).remove();A("#"+I).removeClass("invisible");M=null;I=null;b={};}}function o(N){d=setTimeout(E.bind(null,b,function(){i(b,I,M);},function(){v(I,a.not_found,b.poster,true);},true),N||0);}function t(){return M?document.getElementById(M):null;}function j(){return M;}function D(){var N=t();return N&&N.isPlaying&&N.isPlaying();}function r(){return I;}function J(){return b;}function K(P,O){var N=t();if(N&&N.call){N.call(P,O);}}function s(P,Q,R,N,O){m(P,O).always(function(T){T=T||{flashvars:{}};T.playerId=Q||T.playerId||null;T.width=R||T.width||null;T.height=N||T.height||null;if(window.odklMusic&&window.odklMusic.playingTrack()){T.flashvars.silent="1";}var S=(typeof T.error==="string")?T.error:"",V=G(T.playerId),U=l(T.playerId);if(S||!T.url){var W=v(V,S).removeClass("invisible");T.width&&W.width(T.width);T.height&&W.height(T.height);}else{u(T,V,U);}});}function k(T){var Z=A(T),P=Z.data("playerContainerId"),O=Z.data("playerElementId"),ab=Z.data("options"),aa=Z.data("autostart"),Y=Z.data("viewportTimeout"),V=Z.data("viewportDisabledIfMusic"),N=Z.data("hoverTimeout"),R=Z.data("hoverDisabledIfMusic"),S=Z.data("isBannerVideo");ab.timeshift=ab.timestamp?parseInt(ab.timestamp,10)-Date.now():0;if(S){var U,W=Z.closest(".js-banner-wrapper-pointer");if(W.length){U=A("#"+W.data("bannerWrapperId"));}else{U=Z.closest(".js-banner-wrapper");}if(U.length){var X=U.children(".adv-px");if(X.length){var Q={};X.each(function(){var ad=A(this),ac=ad.data("type"),ae=ad.data("src");if(typeof Q[ac]==="undefined"){Q[ac]=[];}Q[ac].push(ae);});ab.flashvars.pixels=Q;}}}if(!Z.find("#"+P).length){A("<div>",{id:P,"class":"vid-card_cnt_w"}).css({width:"100%",height:"100%"}).append(A("<i>",{"class":"vid_play"})).appendTo(Z);}Z.find("#"+P).on("click",function(ac){ac.preventDefault();E(ab,function(){if(h(ab)){i(ab,P,O);}else{B(ab,P,O);}});});if(aa){u(A.extend(true,{},ab),P,O);}if(Y&&!ab.isExternalPlayer){require(["OK/VideoAutoplayFlow"],function(ac){ac.activateViewportPlayer(A.extend(true,{},ab),P,O,Y,V);});}if(N){require(["OK/VideoAutoplayFlow"],function(ac){ac.activateHoverPlayer(A.extend(true,{},ab),P,O,N,R);});}}function c(O){var N=A(O),R=N.data("playerContainerId"),Q=N.data("viewportTimeout"),P=N.data("hoverTimeout");if(Q||P){require(["OK/VideoAutoplayFlow"],function(S){S.deactivateHoverPlayer(R);S.deactivateViewportPlayer(R);});}if(R===I){L();}}return{activate:k,deactivate:c,createMusicPreview:s,start:u,stop:q,retry:o,getPlayer:t,getPlayerId:j,getContainerId:r,getOptions:J,isPlaying:D,callPlayer:K,createPlayerContainerId:G,createPlayerElementId:l};});