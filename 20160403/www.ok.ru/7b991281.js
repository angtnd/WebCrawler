define(["jquery","OK/logger","okVideoPlayerUtils","PTS/video.player"],function(z,x,o,a){var v={UNKNOWN:"UNKNOWN",OK:"OK",ERROR:"ERROR",UPLOADING:"UPLOADING",CREATING:"CREATING",PROCESSING:"PROCESSING",ONLINE:"ONLINE",OFFLINE:"OFFLINE",LIVE_NOT_STARTED:"LIVE_NOT_STARTED",LIVE_ENDED:"LIVE_ENDED",ON_MODERATION:"ON_MODERATION",BLOCKED:"BLOCKED",CENSORED:"CENSORED",COPYRIGHTS_RESTRICTED:"COPYRIGHTS_RESTRICTED",UNAVAILABLE:"UNAVAILABLE",LIMITED_ACCESS:"LIMITED_ACCESS"};var J=null;var F=null;var b={};var d=null;var E=null;var m=null;z(window).on("onMusicPlaying",function(){if(b.isExternalPlayer){p();}else{H("pause");}});function u(Q,N,K,L){var P=z("#"+Q),M=z("<div/>",{"class":"vp_video_stub_w"}),O=z("<div/>",{"class":"vp_video_stub __na"}).appendTo(M);z("<div/>",{"class":"vp_video_stub_txt",html:(N||"")}).appendTo(O);if(L){P.replaceWith(M);P=M;}else{P.append(M);}if(K){z("<img/>",{width:"100%",src:K,"class":"vp-video_stub_i"}).insertBefore(M);}return P;}function I(){if(d){clearTimeout(d);d=null;}if(E){clearInterval(E);E=null;}if(m){clearTimeout(m);m=null;}}function w(K){for(var L in K){if(K.hasOwnProperty(L)){if(typeof K[L]!=="string"){K[L]=encodeURIComponent(JSON.stringify(K[L]));}}}return K;}function y(K){K.isExternalPlayer&&z.ajax({url:"/dk?cmd=videoStatNew",contentType:"application/json",type:"POST",data:JSON.stringify({duration:0,contentId:K.url,location:K.flashvars.location,providerId:K.provider,batch:[{name:"started"}]})}).error(function(){x.error("OKVideoStart","failOG");});}function f(M,L,N,K){return z.ajax({url:M?decodeURIComponent(M):"/dk?cmd=videoPlayerMetadata",data:L,dataType:"json",type:"POST",headers:{TKN:OK.tkn.get()}}).done(N).error(K);}function l(L,K){return z.ajax({url:"/dk",data:{cmd:"videoCommand",a:"getVideoPlayerAttributes","st.vv_movieId":L,"st.location":K},dataType:"json",type:"POST",headers:{TKN:OK.tkn.get()}});}function A(L,K){require(["okHtml5Player"],function(M){M.embedPlayer(K,K,L.flashvars);});}function g(L,K){require(["swfobject"],function(O){if(O.getObjectById(K)){return;}var P=O.hasFlashPlayerVersion(L.minFlashVersionNewPlayer||"11.2.0")&&L.url11?L.url11:L.url;var N={id:K,name:K};var Q={allowScriptAccess:L.asa?"always":"never",wmode:L.wmode||"opaque",allowFullScreen:true,menu:false,bgcolor:"#000000"};var M={autoplay:true,wmode:Q.wmode,stageVideo:Q.wmode=="direct"||Q.wmode=="gpu",playerId:L.playerId};if(!L.isExternalPlayer){M=w(z.extend({},L.flashvars,M));}O.embedSWF(P,K,"100%","100%","10.0.0",null,M,Q,N);});y(L);}function C(L,K){var M=document.createElement("iframe");M.id=K;M.width="100%";M.height="100%";M.tabIndex="999";M.frameBorder="no";M.scrolling="no";M.allowFullScreen=true;M.setAttribute("allowfullscreen","");M.src=L.url;var N=document.getElementById(K);N.parentNode.replaceChild(M,N);y(L);}function e(W,P,N){var V=W.flashvars.metadata.liveStreamInfo,S=W.flashvars.metadata.movie.status,O=Date.now()+W.timeshift,M=parseInt(V.startTime,10);function T(ac,ab){var aa=~~((ac-ab)/1000),Z=~~(aa/3600),X=~~(aa/60)%60,Y=aa%60;return(Z<10?"0"+Z:Z)+":"+(X<10?"0"+X:X)+":"+(Y<10?"0"+Y:Y);}var L=z("<div/>",{id:N,"class":"vp_broadcast-stub_w"}),R=z("<div/>",{"class":"vp_video_stub_w"}).appendTo(L),U=z("<div/>",{"class":"vp_broadcast-stub"}).appendTo(R),Q=z("<div/>",{"class":"vp_broadcast-stub_tx"}).appendTo(U);z("<img/>",{width:"100%",src:W.poster,"class":"vp-video_stub_i"}).appendTo(L);z("#"+N).replaceWith(L);if(S===v.OFFLINE){Q.html(W.liveOfflineText);n(W.liveRertyTimeout);}else{if(M>O){Q.html(W.liveUnstartedText);var K=z("<div/>",{"class":"vp_broadcast-stub_time js-live-time",text:T(M,O)}).appendTo(U);E=setInterval(function(){O=Date.now()+W.timeshift;if(M<O){clearInterval(E);n();return;}K.text(T(M,O));},1000);}else{Q.html(W.liveEndedText);}}}function h(N,Q,ac){if(typeof N.flashvars.metadata==="string"){N.flashvars.metadata=JSON.parse(N.flashvars.metadata);}N.flashvars.translations=a;var T=N.flashvars.metadata;if(!T||T.error){u(Q,T&&a[T.error]||a.not_found,N.poster,true);return;}var U=o.dash,K=o.mp4,L=o.flash.major>=10,R=!!(N.flashvars.metadata&&N.flashvars.metadata.metadataEmbedded),S=!!(N.flashvars.metadata&&N.flashvars.metadata.hlsMasterPlaylistUrl),O=!!(N.flashvars.metadata&&N.flashvars.metadata.liveDashManifestUrl),ae=N.flashvars.metadata.liveStreamInfo,Y=N.flashvars.metadata.movie.status,Z=z("#"+Q),V=z("#"+ac);function P(){try{C(N,ac);}catch(ag){u(Q,a.not_found,N.poster,true);}}function ab(){if(K){A(N,ac);}else{u(Q,N.noFlashText,N.poster,true);}}function W(){if(U&&O){A(N,ac);}else{X();}}function X(){if(!L){u(Q,N.noFlashText,N.poster,true);}else{g(N,ac);}}function aa(){if(U){A(N,ac);}else{if(!L){ab();}else{g(N,ac);}}}function ad(){if(N.isIframePlayer){P();}else{if(N.isExternalPlayer||!N.isHtml5Player){X();}else{if(O||S){W();}else{if(R){aa();}else{if(K){A(N,ac);}else{X();}}}}}}function af(){var ag=parseInt(ae.endTime,10),ai=Date.now()+N.timeshift;if(ag&&ai<ag){var ah=~~((parseInt(ae.endTime,10)-ai)/1000);m=setTimeout(function(){h(N,Q,ac);},ah*1000+3000);}}function M(){if(Y!==v.OK&&Y!==v.ONLINE){return false;}if(!ae){return true;}if(!S&&!O){T.movie.status=v.OFFLINE;return false;}var ai=parseInt(ae.startTime,10),ag=parseInt(ae.endTime,10),ah=Date.now()+N.timeshift;return !!((!ag||ah<=ag)&&(!ai||ah>ai));}if(J!==ac){p();}if(N.isExternalPlayer&&window.__getMusicFlash){window.__getMusicFlash().lcPause();}J=ac;F=Q;b=N;if(!V.length){Z.hide();z("<div>",{id:ac}).insertAfter(Z);}if(M(N)){ae&&af();ad();}else{e(N,Q,ac);}}function D(K){return K+"C";}function k(K){return K+"E";}function t(K,M,L){M=M||D(K.playerId);L=L||k(K.playerId);if(!K.timeshift){K.timeshift=K.timestamp?parseInt(K.timestamp,10)-Date.now():0;}if(!K.flashvars.metadata&&K.flashvars.metadataUrl){f(K.flashvars.metadataUrl,null,function(N){K.flashvars.metadata=N;delete K.flashvars.metadataUrl;h(K,M,L);},function(){u(M,a.not_found,K.poster,true);});}else{h(K,M,L);}}function p(){if(J&&F){I();z("#"+J).remove();z("#"+F).show();J=null;F=null;b={};}}function n(L){var M=b.flashvars.metadataUrl,K=M?null:{mid:b.flashvars.metadata.movie.movieId,is:"on"};if(!M&&!K){u(F,a.not_found,b.poster,true);}else{d=setTimeout(f.bind(null,M,K,function(N){if(N&&!N.error){z.extend(true,b.flashvars.metadata,N);}h(b,F,J);}),L||0);}}function s(){return J?document.getElementById(J):null;}function i(){return J;}function B(){var K=s();return K&&K.isPlaying&&K.isPlaying();}function q(){return F;}function G(){return b;}function H(M,L){var K=s();if(K&&K.call){K.call(M,L);}}function r(M,N,O,K,L){l(M,L).always(function(Q){Q=Q||{flashvars:{}};Q.playerId=N||Q.playerId||null;Q.width=O||Q.width||null;Q.height=K||Q.height||null;if(window.odklMusic&&window.odklMusic.playingTrack()){Q.flashvars.silent="1";}var P=(typeof Q.error==="string")?Q.error:"";if(P||!Q.url){var R=u(D(Q.playerId),P).css("display","block");Q.width&&R.width(Q.width);Q.height&&R.height(Q.height);}else{t(Q);}});}function j(Q){var W=z(Q),M=W.data("playerContainerId"),L=W.data("playerElementId"),Y=W.data("options"),X=W.data("autostart"),V=W.data("viewportTimeout"),S=W.data("viewportDisabledIfMusic"),K=W.data("hoverTimeout"),O=W.data("hoverDisabledIfMusic"),P=W.data("isBannerVideo");Y.timeshift=Y.timestamp?parseInt(Y.timestamp,10)-Date.now():0;if(P){var R,T=W.closest(".js-banner-wrapper-pointer");if(T.length){R=z("#"+T.data("bannerWrapperId"));}else{R=W.closest(".js-banner-wrapper");}if(R.length){var U=R.children(".adv-px");if(U.length){var N={};U.each(function(){var aa=z(this),Z=aa.data("type"),ab=aa.data("src");if(typeof N[Z]==="undefined"){N[Z]=[];}N[Z].push(ab);});Y.flashvars.pixels=N;}}}if(!W.find("#"+M).length){z("<div>",{id:M,"class":"vid-card_cnt_w"}).css({width:"100%",height:"100%"}).append(z("<i>",{"class":"vid_play"})).appendTo(W);}W.find("#"+M).on("click",function(Z){Z.preventDefault();t(z.extend(true,{},Y),M,L);});if(X){t(z.extend(true,{},Y),M,L);}if(V&&!Y.isExternalPlayer){require(["OK/VideoAutoplayFlow"],function(Z){Z.activateViewportPlayer(z.extend(true,{},Y),M,L,V,S);});}if(K){require(["OK/VideoAutoplayFlow"],function(Z){Z.activateHoverPlayer(z.extend(true,{},Y),M,L,K,O);});}}function c(L){var K=z(L),O=K.data("playerContainerId"),N=K.data("viewportTimeout"),M=K.data("hoverTimeout");if(N||M){require(["OK/VideoAutoplayFlow"],function(P){P.deactivateHoverPlayer(O);P.deactivateViewportPlayer(O);});}if(O===F){I();}}return{activate:j,deactivate:c,createMusicPreview:r,start:t,stop:p,retry:n,getPlayer:s,getPlayerId:i,getContainerId:q,getOptions:G,isPlaying:B,callPlayer:H,createPlayerContainerId:D,createPlayerElementId:k};});