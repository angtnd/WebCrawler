define(["jquery-1.4"],function(a){var b=function(c,d){};b.prototype={domEl:null,editButton:null,searchPanel:null,defaultCleared:false,moduleId:null,contentBlockId:null,inputDefaultText:null,editButtonText:"Edit my location",closeButtonText:"Close",resultsText:"Select an option below to select your location",noResultsText:"Location not found",initialised:false,init:function(d,e){this.opts=e;this.domEl=a(d);if(this.domEl.find(".weatherforecast .edit").length===0){this.domEl.find(".weatherforecast h3").after('<span class="edit">'+this.editButtonText+"</span>")}this.editButton=this.domEl.find(".weatherforecast .edit");this.searchPanel=this.domEl.find(".weatherforecast .searchPanel");this.inputDefaultText=this.searchPanel.find('[name="location_term"]').val();this.moduleId=this.searchPanel.find('form [name="module"]').val();this.contentBlockId=this.searchPanel.find('form [name="contentBlock"]').val();this.defaultCleared=false;if(this.opts.autocomplete.enabled===true){this.searchPanel.find("form").attr("autocomplete","off")}if(!this.initialised){var c=this.readCookie("ckps_hploc");if(c!==null&&c!=""){this.setAndUpdate("/wwhp?module=weather&action=get&location_id="+c)}else{a("#weather_forecast").removeClass("weather_loading")}}},reset:function(){this.searchPanel.find(".searchPanelSearch").val(this.inputDefaultText);this.searchPanel.find(".results");this.defaultCleared=false},processResults:function(e){var g=this;var d=this.searchPanel.find(".results");var j=d.find("ul");var c=d.find("p");j.empty();if(typeof(e)!="undefined"&&e.length>0){for(var k in e){var f=e[k];var h=encodeURI("/wwhp?module=weather&action=set&location_id="+f.id);j.append('<li><a href="'+h+'">'+f.name+"</a></li>")}c.text(this.resultsText).removeClass("noResults")}else{c.text(this.noResultsText).addClass("noResults")}if(d.not(":visible")){d.slideDown()}},ajaxSearch:function(){var d=this.searchPanel.find("form");var c=this;a.ajax({type:d.attr("method"),url:d.attr("action"),data:{module:"weather",action:"search",location_term:d.find('[name="location_term"]').val()},dataType:"json",success:function(e){c.processResults(e)}})},setAndUpdate:function(d){var c=this;var e=d.split("?");a.ajax({type:"GET",url:e[0],data:e[1],dataType:"json",success:function(f){if(c.verifyWeatherResponse(f.html)){a("#weather_forecast").html(f.html)}else{c.searchPanel.find(".results").hide()}c.renderWeather(c.domEl,c.opts);a("#weather_forecast").removeClass("weather_loading");if(c.searchPanel.is(":visible")){c.searchPanel.slideUp();c.editButton.text(c.editButtonText);c.reset()}},error:function(){a("#weather_forecast").removeClass("weather_loading")}})},setEventListeners:function(){this.editButton.unbind("click").bind("click",{self:this},function(e){var d=e.data.self;if(d.searchPanel.is(":visible")){d.searchPanel.slideUp();d.editButton.text(d.editButtonText)}else{d.searchPanel.slideDown();d.editButton.text(d.closeButtonText);d.reset()}return false},false);var c=this.searchPanel.find("input");c.unbind("focus").bind("focus",{self:this},function(e){var d=e.data.self;if(d.defaultCleared===false){a(this).val("");d.defaultCleared=true}return false},false);this.searchPanel.find("form").unbind("submit").bind("submit",{self:this},function(e){var d=e.data.self;d.ajaxSearch();return false},false);if(this.opts.autocomplete.enabled===true){c.bind("keyup",{self:this},function(e){var d=e.data.self;if(a(this).val().length>=d.opts.autocomplete.minLength){d.ajaxSearch()}return false},false)}if(!this.initialised){this.searchPanel.find(".results a").live("click",{self:this},function(e){var d=e.data.self;d.setAndUpdate(this.href);return false},false)}},readCookie:function(e){var g=e+"=";var d=document.cookie.split(";");for(var f=0;f<d.length;f++){var h=d[f];while(h.charAt(0)==" "){h=h.substring(1,h.length)}if(h.indexOf(g)==0){return h.substring(g.length,h.length)}}return null},renderWeather:function(c,d){this.init(c,d);this.setEventListeners();this.initialised=true},verifyWeatherResponse:function(c){var d=a(c);return d.filter("dl.dayForecast").find("dd").length>0&&d.filter("h3").text()!==""}};return b});